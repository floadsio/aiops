{% extends "base.html" %}
{% block title %}{{ project.name }} | Projects{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    article.contrast ul li > button,
    article.contrast ul li > .inline-form {
      display: inline-block;
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
    @media (max-width: 640px) {
      article.contrast ul li {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      article.contrast ul li > button {
        width: 100%;
        justify-content: center;
        margin-top: 0.35rem;
        margin-right: 0;
        /* Ensure minimum touch target size for iOS */
        min-height: 44px;
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }
      article.contrast ul li > .inline-form {
        display: block !important;
        width: 100%;
        margin-top: 0.35rem;
        margin-right: 0;
      }
      /* Make pin/unpin buttons full-width and properly sized on mobile */
      article.contrast ul li > .inline-form button {
        width: 100%;
        justify-content: center;
        min-height: 44px;
        font-size: 1rem;
        padding: 0.5rem 1rem;
        margin-left: 0;
      }
    }
    .git-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .git-history-list li {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.75rem;
      padding: 0.65rem 0.85rem;
      background: rgba(15, 23, 42, 0.02);
    }
    [data-theme="dark"] .git-history-list li {
      background: rgba(15, 23, 42, 0.35);
      border-color: rgba(148, 163, 184, 0.45);
    }
    .git-history-list code {
      font-size: 0.85rem;
    }
    .git-history-list small {
      color: #475569;
    }
    [data-theme="dark"] .git-history-list small {
      color: rgba(226, 232, 240, 0.7);
    }
    /* Issue comments styling */
    .issue-comment-thread {
      margin: 1.5rem 0;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.5rem;
      padding: 0.5rem 0;
    }
    [data-theme="dark"] .issue-comment-thread {
      border-color: rgba(148, 163, 184, 0.45);
    }
    .issue-comment-thread summary {
      cursor: pointer;
      padding: 0.5rem 1rem;
      font-weight: 600;
      user-select: none;
    }
    .issue-comment-thread summary:hover {
      background: rgba(15, 23, 42, 0.05);
    }
    [data-theme="dark"] .issue-comment-thread summary:hover {
      background: rgba(15, 23, 42, 0.15);
    }
    .issue-comments {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    .issue-comments li {
      padding: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
    }
    [data-theme="dark"] .issue-comments li {
      border-top-color: rgba(148, 163, 184, 0.35);
    }
    .issue-comments li:first-child {
      border-top: none;
    }
    .issue-comment__header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }
    .issue-comment__author {
      font-weight: 600;
      color: var(--pico-color-slate-900);
    }
    [data-theme="dark"] .issue-comment__author {
      color: rgba(226, 232, 240, 0.95);
    }
    .issue-comment__timestamp {
      color: #64748b;
      font-size: 0.85rem;
    }
    [data-theme="dark"] .issue-comment__timestamp {
      color: rgba(148, 163, 184, 0.75);
    }
    .issue-comment__body {
      line-height: 1.6;
      color: var(--pico-color-slate-800);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    [data-theme="dark"] .issue-comment__body {
      color: rgba(226, 232, 240, 0.85);
    }
    .issue-comment__body p {
      margin: 0.5rem 0;
    }
    .issue-comment__body p:first-child {
      margin-top: 0;
    }
    .issue-comment__body p:last-child {
      margin-bottom: 0;
    }
    .issue-comment__body pre {
      background: rgba(15, 23, 42, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.4rem;
      padding: 0.75rem;
      overflow-x: auto;
      font-size: 0.85rem;
    }
    [data-theme="dark"] .issue-comment__body pre {
      background: rgba(15, 23, 42, 0.35);
      border-color: rgba(148, 163, 184, 0.35);
    }
    .issue-comment__body code {
      background: rgba(148, 163, 184, 0.1);
      padding: 0.2rem 0.4rem;
      border-radius: 0.2rem;
      font-family: monospace;
      font-size: 0.9em;
    }
    [data-theme="dark"] .issue-comment__body code {
      background: rgba(148, 163, 184, 0.2);
    }
    .issue-comment__body blockquote {
      border-left: 3px solid rgba(148, 163, 184, 0.5);
      padding-left: 1rem;
      margin-left: 0;
      color: #64748b;
      font-style: italic;
    }
    [data-theme="dark"] .issue-comment__body blockquote {
      border-left-color: rgba(148, 163, 184, 0.6);
      color: rgba(148, 163, 184, 0.8);
    }
    .jira-mention {
      background: rgba(59, 130, 246, 0.1);
      padding: 0.2rem 0.4rem;
      border-radius: 0.3rem;
      font-weight: 500;
      color: var(--pico-color-blue-600);
    }
    [data-theme="dark"] .jira-mention {
      background: rgba(59, 130, 246, 0.2);
      color: var(--pico-color-blue-300);
    }

    /* Issue Cards Grid */
    .issues-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 1024px) {
      .issues-grid {
        grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
      }
    }

    /* Individual Issue Card */
    .issue-card {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.75rem;
      padding: 1.25rem;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: all 0.2s ease;
    }

    .issue-card:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    [data-theme="dark"] .issue-card {
      background: rgba(15, 23, 42, 0.5);
      border-color: rgba(148, 163, 184, 0.45);
    }

    [data-theme="dark"] .issue-card:hover {
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .issue-card__header {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      padding-bottom: 1rem;
    }

    .issue-card__title-section {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .issue-card__title {
      margin: 0;
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
      font-size: 1.1rem;
      line-height: 1.4;
    }

    .issue-card__badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .issue-card__meta {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .issue-card__id {
      font-weight: 600;
      color: var(--pico-color-blue-600);
      font-size: 0.9rem;
    }

    [data-theme="dark"] .issue-card__id {
      color: var(--pico-color-blue-300);
    }

    .issue-card__timestamp {
      color: #64748b;
      font-size: 0.85rem;
    }

    [data-theme="dark"] .issue-card__timestamp {
      color: rgba(148, 163, 184, 0.75);
    }

    .issue-card__labels {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .issue-card__content {
      flex: 1;
      min-height: 0;
    }

    /* Comments Section */
    .issue-comments__header {
      cursor: pointer;
      font-weight: 600;
      padding: 0.75rem 0;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .issue-comments__header:hover {
      color: var(--pico-color-blue-600);
    }

    .issue-comments__list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem 0;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .issue-comment {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .issue-comment__header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }

    .issue-comment__author {
      font-weight: 600;
      color: var(--pico-color-slate-900);
      display: inline-block;
    }

    [data-theme="dark"] .issue-comment__author {
      color: rgba(226, 232, 240, 0.95);
    }

    .issue-comment__timestamp {
      color: #64748b;
      font-size: 0.85rem;
      display: inline-block;
    }

    [data-theme="dark"] .issue-comment__timestamp {
      color: rgba(148, 163, 184, 0.75);
    }

    .issue-comment__link {
      color: var(--pico-color-blue-600);
      text-decoration: none;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .issue-comment__link:hover {
      opacity: 1;
    }

    .issue-comment__body {
      line-height: 1.6;
      color: var(--pico-color-slate-800);
      word-wrap: break-word;
      overflow-wrap: break-word;
      margin-left: 0.5rem;
    }

    [data-theme="dark"] .issue-comment__body {
      color: rgba(226, 232, 240, 0.85);
    }

    .issue-comment__body p {
      margin: 0.5rem 0;
    }

    .issue-comment__body p:first-child {
      margin-top: 0;
    }

    .issue-comment__body p:last-child {
      margin-bottom: 0;
    }

    .issue-comment__body pre {
      background: rgba(15, 23, 42, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.4rem;
      padding: 0.75rem;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }

    [data-theme="dark"] .issue-comment__body pre {
      background: rgba(15, 23, 42, 0.35);
      border-color: rgba(148, 163, 184, 0.35);
    }

    .issue-comment__body code {
      background: rgba(148, 163, 184, 0.1);
      padding: 0.2rem 0.4rem;
      border-radius: 0.2rem;
      font-family: monospace;
      font-size: 0.9em;
    }

    [data-theme="dark"] .issue-comment__body code {
      background: rgba(148, 163, 184, 0.2);
    }

    .issue-comment__body blockquote {
      border-left: 3px solid rgba(148, 163, 184, 0.5);
      padding-left: 1rem;
      margin-left: 0;
      margin: 0.5rem 0;
      color: #64748b;
      font-style: italic;
    }

    [data-theme="dark"] .issue-comment__body blockquote {
      border-left-color: rgba(148, 163, 184, 0.6);
      color: rgba(148, 163, 184, 0.8);
    }

    /* Reply Form */
    .issue-comment__reply {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(59, 130, 246, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 0.5rem;
    }

    [data-theme="dark"] .issue-comment__reply {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.35);
    }

    .issue-comment__reply label {
      margin-bottom: 0.5rem;
      display: block;
    }

    .issue-comment__reply textarea {
      margin-bottom: 0.75rem;
      width: 100%;
    }

    .issue-comment__reply button {
      margin-top: 0;
    }

    /* Issue Card Footer */
    .issue-card__footer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      padding-top: 1rem;
      margin-top: auto;
    }

    .issue-card__actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .issue-card__actions button,
    .issue-card__actions a {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
    }

    .issue-card__state-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .issue-card__state-actions form {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .issue-card__state-actions button {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
      margin: 0;
    }

    .issue-card__state-actions input {
      font-size: 0.85rem;
      padding: 0.4rem 0.6rem;
      height: auto;
    }
  </style>
{% endblock %}
{% block content %}
<h1>{{ project.name }}</h1>
<p>
  <strong>Tenant:</strong>
  <span class="tenant-badge" style="--tenant-color: {{ project.tenant.color or default_tenant_color }}">
    <span class="tenant-badge__swatch" aria-hidden="true"></span>
    {{ project.tenant.name }}
  </span>
</p>
<p><strong>Repository:</strong> <code>{{ project.repo_url }}</code></p>
<p><strong>Local Path:</strong> <code>{{ project.local_path }}</code></p>

<section>
  <h2>Automation Consoles</h2>
  <p>
    Launch dedicated windows for AI-assisted edits or Ansible runs.
    Each console locks to this project.
  </p>
  <p>
    <a
      role="button"
      href="{{ url_for('projects.project_ai_console', project_id=project.id) }}"
    >Open AI Console</a>
    <a
      role="button"
      class="secondary"
      href="{{ url_for('projects.project_ansible_console', project_id=project.id) }}"
    >Open Ansible Console</a>
  </p>
</section>

<section>
  <h2>Workspace</h2>
  {% if workspace_status.has_git %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-green-500)">âœ“ Initialized</span>
    </p>
    <p><strong>Path:</strong> <code>{{ workspace_status.path }}</code></p>
    <p class="text-muted">
      Your workspace is ready. Launch a tmux session to start working.
    </p>
  {% elif workspace_status.error %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-amber-500)">âš  Not available</span>
    </p>
    <p class="text-muted">{{ workspace_status.error }}</p>
  {% else %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-amber-500)">âš  Not initialized</span>
    </p>
    <p class="text-muted">
      Initialize your workspace to start working on this project.
      This will clone the repository to <code>{{ workspace_status.path or '~/workspace/' ~ project.name }}</code>
    </p>
    <button
      id="init-workspace-btn"
      data-project-id="{{ project.id }}"
      onclick="initWorkspace({{ project.id }})"
    >
      Initialize Workspace
    </button>
    <p id="workspace-init-status" style="margin-top: 1rem;"></p>
  {% endif %}
</section>

<section>
  <h2>SSH Access</h2>
  <form method="post">
    {{ ssh_key_form.hidden_tag() }}
    <label>
      {{ ssh_key_form.ssh_key_id.label }}
      {{ ssh_key_form.ssh_key_id() }}
    </label>
    {% for error in ssh_key_form.ssh_key_id.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
    {{ ssh_key_form.submit(class="secondary") }}
  </form>
  {% if project.ssh_key %}
    <p class="text-muted">
      Using project-specific key <strong>{{ project.ssh_key.name }}</strong>
      {% if project.ssh_key.fingerprint %}
        ({{ project.ssh_key.fingerprint }})
      {% endif %}
    </p>
  {% elif tenant_default_key %}
    <p class="text-muted">
      Using tenant default key <strong>{{ tenant_default_key.name }}</strong>
      {% if tenant_default_key.fingerprint %}
        ({{ tenant_default_key.fingerprint }})
      {% endif %}
    </p>
  {% else %}
    <p class="warning-note">This tenant has no SSH key with private material configured. Git operations may fail.</p>
  {% endif %}
</section>

<section>
  <h2>Repository Status</h2>
  <p>Branch: {{ status.branch }} | Dirty: {{ status.dirty }}</p>
  {% if status.untracked_files %}
    <details>
      <summary>Untracked Files</summary>
      <ul>
        {% for file in status.untracked_files %}
          <li>{{ file }}</li>
        {% endfor %}
      </ul>
    </details>
  {% endif %}
</section>

<section>
  <h2>Recent Git History</h2>
  {% if commit_history %}
    <ul class="git-history-list">
      {% for commit in commit_history %}
        <li>
          <div>
            <code>{{ commit.short_hash }}</code>
            â€” {{ commit.message }}
          </div>
          <small>{{ commit.author }} â€¢ {{ commit.date_display }}</small>
        </li>
      {% endfor %}
    </ul>
  {% elif commit_history_error %}
    <p class="warning-note">Git history unavailable: {{ commit_history_error }}</p>
  {% else %}
    <p class="text-muted">No commits recorded yet.</p>
  {% endif %}
</section>

<section>
  <h2>Issues</h2>
  <form method="get" class="issue-filter-form">
    <label for="issue-status-filter">Issue status</label>
    <select id="issue-status-filter" name="issue_status" onchange="this.form.submit()">
      {% for option in issue_status_options %}
        <option
          value="{{ option.value }}"
          {% if option.value == issue_status_filter %}selected{% endif %}
        >
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    {% for key, value in request.args.items() if key != 'issue_status' %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
  </form>
  {% if issue_groups %}
    <p class="text-muted">
      Showing {{ total_issue_count }} of {{ total_issue_full_count }}
      issue{{ '' if total_issue_full_count == 1 else 's' }}
      across {{ issue_groups|length }}
      integration{{ '' if issue_groups|length == 1 else 's' }}
      {% if issue_status_filter != 'all' %}
        (status: {{ issue_status_filter_label }})
      {% endif %}.
    </p>
    {% for group in issue_groups %}
      <article class="contrast">
        <header>
          <h3>{{ group.integration_name }}</h3>
          <p>
            Provider: {{ group.provider_display }}
            {% if group.project_identifier %}
              â€¢ Target: <code>{{ group.project_identifier }}</code>
            {% endif %}
            {% if not group.enabled %}
              <span class="badge">Disabled</span>
            {% endif %}
          </p>
          {% if group.last_synced %}
            <p class="text-muted">Last synced {{ group.last_synced }}</p>
          {% endif %}
        </header>
        {% if group.can_create_issue %}
          <details class="issue-create-form">
            <summary>Create new issue</summary>
            <form method="post" class="grid">
              {{ group.create_form.hidden_tag() }}
              {{ group.create_form.integration_id() }}
              <label>
                {{ group.create_form.summary.label }}
                {{ group.create_form.summary() }}
                {% for error in group.create_form.summary.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.description.label }}
                {{ group.create_form.description() }}
                {% for error in group.create_form.description.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.issue_type.label }}
                {{ group.create_form.issue_type() }}
                {% if group.create_form.issue_type.description %}
                  <small class="text-muted">{{ group.create_form.issue_type.description }}</small>
                {% endif %}
                {% for error in group.create_form.issue_type.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.labels.label }}
                {{ group.create_form.labels() }}
                {% if group.create_form.labels.description %}
                  <small class="text-muted">{{ group.create_form.labels.description }}</small>
                {% endif %}
                {% for error in group.create_form.labels.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.assignee_user_id.label }}
                {{ group.create_form.assignee_user_id() }}
                {% if group.create_form.assignee_user_id.description %}
                  <small class="text-muted">{{ group.create_form.assignee_user_id.description }}</small>
                {% endif %}
                {% for error in group.create_form.assignee_user_id.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <div>
                {{ group.create_form.submit(class="secondary") }}
              </div>
            </form>
          </details>
        {% endif %}
        {% if group.issues %}
          <div class="issues-grid">
            {% for issue in group.issues %}
              <article class="issue-card">
                <!-- Issue Header -->
                <header class="issue-card__header">
                  <div class="issue-card__title-section">
                    <h4 class="issue-card__title">{{ issue.title }}</h4>
                    <div class="issue-card__badges">
                      {% if issue.status %}
                        <span class="badge secondary">{{ issue.status }}</span>
                      {% endif %}
                      {% if issue.assignee %}
                        <span class="badge">{{ issue.assignee }}</span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="issue-card__meta">
                    <small class="issue-card__id">{{ issue.external_id }}</small>
                    {% if issue.updated_display %}
                      <small class="issue-card__timestamp">Updated {{ issue.updated_display }}</small>
                    {% endif %}
                  </div>
                </header>

                <!-- Labels -->
                {% if issue.labels %}
                  <div class="issue-card__labels">
                    {% for label in issue.labels %}
                      <span class="badge outline">{{ label }}</span>
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Issue Content -->
                <div class="issue-card__content">
                  <!-- Comments Section -->
                  {% if issue.comment_count %}
                    <details class="issue-comment-thread" open>
                      <summary class="issue-comments__header">
                        ðŸ’¬ Conversation ({{ issue.comment_count }} comment{{ '' if issue.comment_count == 1 else 's' }})
                      </summary>
                      <div class="issue-comments__list">
                        {% for comment in issue.comments %}
                          <div class="issue-comment">
                            <div class="issue-comment__header">
                              <strong class="issue-comment__author">
                                {% if comment.author %}
                                  {{ comment.author }}
                                {% else %}
                                  <span class="text-muted">Unknown author</span>
                                {% endif %}
                              </strong>
                              {% if comment.created_display %}
                                <small class="issue-comment__timestamp">{{ comment.created_display }}</small>
                              {% endif %}
                              {% if comment.url %}
                                <a href="{{ comment.url }}" target="_blank" rel="noopener" class="issue-comment__link">â†—</a>
                              {% endif %}
                            </div>
                            <div class="issue-comment__body">
                              {{ comment.body|render_issue_content }}
                            </div>
                          </div>
                        {% endfor %}
                      </div>

                      <!-- Reply Form -->
                      <form method="post" class="issue-comment__reply" action="{{ url_for('projects.comment_issue', project_id=project.id, issue_id=issue.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <label for="reply-{{ issue.id }}">
                          <small>Add your reply:</small>
                        </label>
                        <textarea
                          id="reply-{{ issue.id }}"
                          name="comment"
                          placeholder="Type your reply here... (markdown supported)"
                          rows="3"
                          style="font-family: monospace; font-size: 0.9rem;"
                        ></textarea>
                        <button type="submit" class="secondary">Post Reply</button>
                      </form>
                    </details>
                  {% else %}
                    <!-- Reply Form for Issues Without Comments -->
                    <form method="post" class="issue-comment__reply" action="{{ url_for('projects.comment_issue', project_id=project.id, issue_id=issue.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <label for="reply-{{ issue.id }}">
                        <small>Start a conversation:</small>
                      </label>
                      <textarea
                        id="reply-{{ issue.id }}"
                        name="comment"
                        placeholder="Type your comment here... (markdown supported)"
                        rows="3"
                        style="font-family: monospace; font-size: 0.9rem;"
                      ></textarea>
                      <button type="submit" class="secondary">Post Comment</button>
                    </form>
                  {% endif %}
                </div>

                <!-- Footer Actions -->
                <footer class="issue-card__footer">
                  <div class="issue-card__actions">
                    <button
                      type="button"
                      class="secondary start-codex-session"
                      data-target="{{ url_for('projects.project_ai_console', project_id=project.id, issue_id=issue.id) }}"
                      data-prepare="{{ url_for('projects.prepare_issue_context', project_id=project.id, issue_id=issue.id) }}"
                      data-context='{{ issue.codex_payload|tojson }}'
                      data-tool="claude"
                      data-command="{{ ai_tool_commands.get('claude') or default_ai_shell }}"
                      title="Start AI-assisted work session"
                    >
                      ðŸ¤– Claude
                    </button>
                    <button
                      type="button"
                      class="secondary start-codex-session"
                      data-target="{{ url_for('projects.project_ai_console', project_id=project.id, issue_id=issue.id) }}"
                      data-prepare="{{ url_for('projects.prepare_issue_context', project_id=project.id, issue_id=issue.id) }}"
                      data-context='{{ issue.codex_payload|tojson }}'
                      data-tool="codex"
                      data-command="{{ ai_tool_commands.get('codex') or default_ai_shell }}"
                      title="Start Codex work session"
                    >
                      ðŸŽ¨ Codex
                    </button>
                    {% if issue.url %}
                      <a
                        href="{{ issue.url }}"
                        target="_blank"
                        rel="noopener"
                        class="button secondary outline"
                        title="Open in {{ group.provider_display }}"
                      >
                        ðŸ”— {{ group.provider_display }}
                      </a>
                    {% endif %}
                  </div>
                  <div class="issue-card__state-actions">
                    {% if issue.is_pinned %}
                      <form method="post" action="{{ url_for('projects.unpin_issue', project_id=project.id, issue_id=issue.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="tertiary outline" title="Unpin this issue">â˜… Pinned</button>
                      </form>
                    {% else %}
                      <form method="post" action="{{ url_for('projects.pin_issue', project_id=project.id, issue_id=issue.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="tertiary outline" title="Pin this issue">â˜† Pin</button>
                      </form>
                    {% endif %}
                    {% if issue.status_key != 'closed' %}
                      <form method="post" action="{{ url_for('projects.close_issue', project_id=project.id, issue_id=issue.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="secondary outline" title="Close this issue">âœ“ Close</button>
                      </form>
                    {% endif %}
                    {% if issue.can_assign %}
                      <form method="post" action="{{ url_for('projects.assign_issue', project_id=project.id, issue_id=issue.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input
                          type="text"
                          name="assignee"
                          placeholder="Assign..."
                          style="max-width: 10rem; display:inline-block; margin-right: 0.5rem;"
                        />
                        <button type="submit" class="secondary outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Assign</button>
                      </form>
                    {% endif %}
                  </div>
                </footer>
              </article>
            {% endfor %}
          </div>
        {% else %}
          {% if group.total_issues %}
            <p class="text-muted">No issues match the current filter.</p>
          {% else %}
            <p class="text-muted">No issues cached for this integration yet.</p>
          {% endif %}
        {% endif %}
      </article>
    {% endfor %}
  {% else %}
  <p class="text-muted">No issue integrations linked to this project.</p>
  {% endif %}
</section>

<section>
  <h2>Project Guide</h2>
  <p class="text-muted">
    Review or update the repository's <code>AGENTS.override.md</code> guide from the dashboard.
  </p>
  <p>
    <a
      role="button"
      class="secondary"
      href="{{ url_for('projects.edit_agents_file', project_id=project.id) }}"
    >View &amp; Edit AGENTS.override.md</a>
  </p>
</section>

<section>
  <h2>Git Actions</h2>
  <form method="post">
    {{ git_form.hidden_tag() }}
    {{ git_form.action.label }} {{ git_form.action() }}
    {{ git_form.ref.label }} {{ git_form.ref() }}
    <label class="checkbox">
      {{ git_form.clean_pull() }} {{ git_form.clean_pull.label.text }}
    </label>
    {{ git_form.submit() }}
  </form>
</section>

{% if message %}
<article class="contrast">
  <h3>Task Output</h3>
  <pre>{{ message }}</pre>
</article>
{% endif %}

{% if error %}
<article class="contrast" data-theme="dark">
  <h3>Errors</h3>
  <pre>{{ error }}</pre>
</article>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const codexButtons = document.querySelectorAll('.start-codex-session');
    const populateButtons = document.querySelectorAll('.populate-agents-md');
    if (!codexButtons.length && !populateButtons.length) {
      return;
    }
    const storageKeyPrefix = 'aiops-session-context';
    const projectId = {{ project.id }};
    const storageKey = `${storageKeyPrefix}-${projectId}`;
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenValue = (
      (csrfInput && csrfInput.value) ||
      (csrfMeta && csrfMeta.getAttribute('content')) ||
      ''
    );
    const csrfHeaders = csrfTokenValue
      ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue }
      : {};

    codexButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        const prepareEndpoint = button.dataset.prepare;
        const payloadRaw = button.dataset.context;
        const toolOverride = button.dataset.tool;
        const commandOverride = button.dataset.command;
        if (!target || !payloadRaw) {
          return;
        }
        let payload;
        try {
          payload = JSON.parse(payloadRaw);
        } catch (error) {
          return;
        }

        // Override the tool if specified on the button
        if (toolOverride) {
          payload.tool = toolOverride;
          if (commandOverride) {
            payload.command = commandOverride;
          }
        }

        const finalize = (context) => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(context));
          } catch (error) {
            /* ignore storage errors */
          }
          window.location.href = target;
        };

        if (payload.issueId && prepareEndpoint) {
          const preparePayload = {};
          if (payload.tool) {
            preparePayload.tool = payload.tool;
          }

          fetch(prepareEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...csrfHeaders,
            },
            credentials: 'same-origin',
            body: JSON.stringify(preparePayload)
          })
            .then((response) => (
              response.ok
                ? response.json()
                : response.json().then((data) => Promise.reject(data))
            ))
            .then(data => {
              finalize({
                prompt: data.prompt,
                command: data.command,
                tool: data.tool || payload.tool,
                autoStart: true,
                tmuxTarget: data.tmux_target || null,
              });
            })
            .catch(() => {
              finalize({
                prompt: payload.prompt,
                command: payload.command,
                tool: payload.tool,
                autoStart: payload.autoStart,
                tmuxTarget: payload.tmuxTarget || null,
              });
            });
        } else {
          finalize({
            prompt: payload.prompt,
            command: payload.command,
            tool: payload.tool,
            autoStart: payload.autoStart,
            tmuxTarget: payload.tmuxTarget || null,
          });
        }
      });
    });

    populateButtons.forEach(button => {
      button.addEventListener('click', () => {
        const endpoint = button.dataset.populate;
        if (!endpoint) {
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Populating...';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...csrfHeaders,
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then(response => (
            response.ok
              ? response.json()
              : response.json().then(data => Promise.reject(data))
          ))
          .then(data => {
            button.textContent = 'AGENTS.override.md updated';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2000);
            if (data && data.tracked_path) {
              console.info(`Updated agent context at ${data.tracked_path}`);
            }
          })
          .catch(error => {
            console.error('Failed to populate AGENTS.override.md', error);
            button.textContent = 'Update failed';
            window.setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2500);
          });
      });
    });
  })();

  // Workspace initialization
  function initWorkspace(projectId) {
    const button = document.getElementById('init-workspace-btn');
    const statusEl = document.getElementById('workspace-init-status');

    if (!button || !statusEl) return;

    // Disable button and show loading state
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    const originalText = button.textContent;
    button.textContent = 'Initializing...';
    statusEl.innerHTML = '<small style="color: var(--pico-color-azure-500);">Cloning repository...</small>';

    fetch(`/api/v1/projects/${projectId}/workspace/init`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        statusEl.innerHTML = `<small style="color: var(--pico-color-green-500);">âœ“ ${data.message || 'Workspace initialized successfully!'}</small>`;
        // Reload page after 1 second to show updated status
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        statusEl.innerHTML = `<small style="color: var(--pico-color-red-500);">âœ— ${data.error || 'Failed to initialize workspace'}</small>`;
        button.disabled = false;
        button.removeAttribute('aria-busy');
        button.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Workspace initialization error:', error);
      statusEl.innerHTML = '<small style="color: var(--pico-color-red-500);">âœ— Network error. Please try again.</small>';
      button.disabled = false;
      button.removeAttribute('aria-busy');
      button.textContent = originalText;
    });
  }
</script>
{% endblock %}
