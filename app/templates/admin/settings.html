{% extends "base.html" %}
{% block title %}Admin Settings | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .settings-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }
  .settings-card {
    padding: 1.5rem;
    border-radius: 1.2rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.92);
  }
  [data-theme="dark"] .settings-card {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .settings-card h2 {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }
  .settings-card p {
    margin-top: 0;
    margin-bottom: 0.9rem;
  }
  .settings-card form {
    margin: 0;
  }
  .settings-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .settings-actions label {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 220px;
  }
  .settings-actions select,
  .settings-actions input[type="text"],
  .settings-actions input[type="number"],
  .settings-actions input[type="password"] {
    width: 100%;
  }
  .settings-actions .checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .settings-actions .form-helper {
    font-size: 0.85rem;
  }
  .user-table {
    width: 100%;
  }
  .user-table td,
  .user-table th {
    vertical-align: top;
  }
  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .user-actions details {
    margin-bottom: 0.35rem;
  }
  .user-edit-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .user-edit-form label {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .user-actions form {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .user-actions input[type="password"] {
    max-width: 220px;
  }
  .user-meta {
    font-size: 0.9rem;
    color: #475569;
  }
  [data-theme="dark"] .user-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .log-output {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 1rem;
    background: rgba(241, 245, 249, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
    max-height: 20rem;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
  [data-theme="dark"] .log-output {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  @media (max-width: 768px) {
    .settings-card {
      padding: 1.1rem;
    }
    .settings-actions {
      flex-direction: column;
      align-items: stretch;
    }
    .settings-actions label,
    .settings-actions .checkbox-inline {
      width: 100%;
    }
    .settings-actions button {
      width: 100%;
      justify-content: center;
    }
    .settings-actions .form-helper {
      width: 100%;
    }
    .log-output {
      max-width: 100%;
      overflow-x: auto;
    }
    .settings-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}
{% block content %}
<h1>Admin Settings</h1>

<div class="settings-grid">
  <article class="settings-card">
    <h2>System Update</h2>
    <p>Run <code>scripts/update.sh</code> without shell access. Optionally request a restart once the update completes.</p>
    {% if restart_command %}
      <p class="text-muted">Configured restart command: <code>{{ restart_command }}</code></p>
    {% else %}
      <p class="text-muted">No restart command configured. Set <code>UPDATE_RESTART_COMMAND</code> in your environment to automatically restart the service.</p>
    {% endif %}
    <form method="post" action="{{ url_for('admin.run_system_update') }}">
      {{ update_form.hidden_tag() }}
      <div class="settings-actions">
        <label>
          {{ update_form.branch.label }}
          {{ update_form.branch() }}
        </label>
        <label class="checkbox-inline">
          {{ update_form.restart() }}
          <span>Restart application after update</span>
        </label>
        <button type="submit" class="secondary">Run update script</button>
        <span class="text-muted form-helper">Set AIOPS_UPDATE_BRANCH for this run (default matches current branch).</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h2>Quick Branch Switch</h2>
    <p>Pick a branch and run the update script with restart in one step. Use this when you need to jump between release trains quickly.</p>
    <form method="post" action="{{ url_for('admin.quick_branch_switch') }}">
      {{ quick_branch_form.hidden_tag() }}
      {{ quick_branch_form.next }}
      <div class="settings-actions">
        <label>
          {{ quick_branch_form.branch.label }}
          {{ quick_branch_form.branch() }}
        </label>
        <button type="submit" class="secondary">Switch & Restart</button>
        <span class="text-muted form-helper">Runs the same update script and immediately triggers the configured restart command.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h2>tmux Sessions</h2>
    <p>Ensure each project has an active tmux window and remove orphaned project windows from the shared session.</p>
    <p class="text-muted">Creates missing windows (matching the DB) and prunes stale `-p<ID>` tmux windows.</p>
    <form method="post" action="{{ url_for('admin.resync_tmux_sessions') }}">
      {{ tmux_resync_form.hidden_tag() }}
      <div class="settings-actions">
        <button type="submit" class="secondary">Resync tmux windows</button>
        <span class="text-muted form-helper">Safe to run after importing databases or pruning projects.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h2>Database Schema</h2>
    <p>Apply pending Alembic migrations without shell access. Use this after pulling new releases that add columns or tables.</p>
    <p class="text-muted">Runs <code>flask --app manage.py db upgrade</code> inside the project virtualenv.</p>
    <form method="post" action="{{ url_for('admin.run_database_migrations') }}">
      {{ migration_form.hidden_tag() }}
      <div class="settings-actions">
        <button type="submit" class="secondary">Run migrations</button>
        <span class="text-muted form-helper">Outputs appear below as flash messages.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h2>Codex CLI Updates</h2>
    <p>Check the installed Codex CLI version and install the latest release without shell access.</p>
    <p class="text-muted">The update command runs <code>sudo npm install -g @openai/codex</code> on Debian-based hosts. Ensure the service account has passwordless sudo access for npm.</p>
    <div>
      <p><strong>Installed version:</strong>
        {% if codex_status.installed_version %}
          <code>{{ codex_status.installed_version }}</code>
        {% else %}
          <span class="text-muted">Unknown</span>
        {% endif %}
      </p>
      <p><strong>Latest release:</strong>
        {% if codex_status.latest_version %}
          <code>{{ codex_status.latest_version }}</code>
        {% else %}
          <span class="text-muted">Unknown</span>
        {% endif %}
      </p>
      <p>
        {% if codex_status.errors %}
          <span class="badge danger">Status unavailable</span>
        {% elif codex_status.update_available %}
          <span class="badge warning">Update available</span>
        {% else %}
          <span class="badge success">Up to date</span>
        {% endif %}
      </p>
    </div>
    {% if codex_status.errors %}
      <div class="critical-note">
        <p>Unable to determine Codex CLI status:</p>
        <ul>
          {% for message in codex_status.errors %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <form method="post" action="{{ url_for('admin.update_codex_cli') }}">
      {{ codex_update_form.hidden_tag() }}
      {% set disable_update = codex_status.errors or (not codex_status.update_available) %}
      <div class="settings-actions">
        <button type="submit" class="secondary"
                {% if disable_update %}disabled aria-disabled="true"{% endif %}
                {% if disable_update %}title="Codex must have an update available and a healthy status to proceed."{% endif %}>
          Install latest Codex
        </button>
        <span class="text-muted form-helper">Runs the Debian-friendly Codex upgrade in the background.</span>
      </div>
    </form>
    {% if codex_status.errors %}
      <p class="text-muted">Resolve the issues above, then refresh to try again.</p>
    {% elif codex_status.update_available %}
      <p class="text-muted">A newer Codex CLI release is available. Updates can take a few minutes.</p>
    {% else %}
      <p class="text-muted">Codex CLI is up to date. Refresh the page to check for newer releases.</p>
    {% endif %}
  </article>

  <article class="settings-card">
    <h2>User Accounts</h2>
    <p>Create and manage application users. Promote additional administrators so critical tasks are not blocked on a single account.</p>
    <details>
      <summary><strong>Create user</strong></summary>
      <form method="post">
        {{ create_user_form.hidden_tag() }}
        <label>
          {{ create_user_form.name.label }}
          {{ create_user_form.name() }}
          {% for error in create_user_form.name.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.email.label }}
          {{ create_user_form.email(type="email") }}
          {% for error in create_user_form.email.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.password.label }}
          {{ create_user_form.password(type="password", autocomplete="new-password") }}
          {% for error in create_user_form.password.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label class="checkbox">
          {{ create_user_form.is_admin() }}
          {{ create_user_form.is_admin.label }}
        </label>
        <button type="submit" class="secondary">{{ create_user_form.submit.label.text }}</button>
      </form>
    </details>

    <h3>Existing users</h3>
    {% if users %}
      <div class="table-scroll">
        <table class="user-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              {% set toggle_form = user_toggle_forms[user.id] %}
              {% set reset_form = user_reset_forms[user.id] %}
              {% set delete_form = user_delete_forms[user.id] %}
              {% set update_form = user_update_forms[user.id] %}
              <tr>
                <th scope="row">
                  {{ user.name or "Unnamed user" }}
                  <div class="user-meta">#{{ user.id }}</div>
                </th>
                <td><code>{{ user.email }}</code></td>
                <td>
                  {% if user.is_admin %}
                    <span class="badge success">Administrator</span>
                  {% else %}
                    <span class="badge">Standard</span>
                  {% endif %}
                  {% if current_user.id == user.id %}
                    <div class="user-meta">(You)</div>
                  {% endif %}
                </td>
                <td>
                  <div class="user-actions">
                    <details>
                      <summary>Edit details</summary>
                      <form method="post" action="{{ url_for('admin.update_user', user_id=user.id) }}" class="user-edit-form">
                        {{ update_form.hidden_tag() }}
                        <label>
                          {{ update_form.name.label }}
                          {{ update_form.name() }}
                        </label>
                        <label>
                          {{ update_form.email.label }}
                          {{ update_form.email(type="email") }}
                        </label>
                        <label class="checkbox">
                          {{ update_form.is_admin() }}
                          {{ update_form.is_admin.label }}
                        </label>
                        <button type="submit" class="secondary">{{ update_form.submit.label.text }}</button>
                      </form>
                    </details>
                    <form method="post" action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}">
                      {{ toggle_form.hidden_tag() }}
                      <button type="submit" class="secondary">
                        {% if user.is_admin %}Revoke admin{% else %}Promote to admin{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('admin.reset_user_password', user_id=user.id) }}">
                      {{ reset_form.hidden_tag() }}
                      {{ reset_form.password(type="password", placeholder="New password", autocomplete="new-password") }}
                      <button type="submit" class="secondary outline">Reset password</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
                      {{ delete_form.hidden_tag() }}
                      <button type="submit" class="secondary outline">Delete user</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No users found.</p>
    {% endif %}
  </article>

  <article class="settings-card">
    <h2>Application Logs</h2>
    {% if log_file %}
      <p>Inspect recent entries from <code>{{ log_file }}</code> to troubleshoot background activity.</p>
    {% else %}
      <p>Inspect recent log output to troubleshoot background activity.</p>
    {% endif %}
    <div class="settings-actions">
      <label class="checkbox-inline" for="log-line-count">
        <span>Lines</span>
        <input type="number" id="log-line-count" min="50" max="2000" value="400" />
      </label>
      <button type="button" class="secondary" id="refresh-log">Refresh logs</button>
      <span class="text-muted form-helper" id="log-status" aria-live="polite"></span>
    </div>
    <pre id="app-log-output" class="log-output" tabindex="0">Loading…</pre>
  </article>
</div>
<script>
  (function () {
    const refreshButton = document.getElementById('refresh-log');
    const output = document.getElementById('app-log-output');
    const status = document.getElementById('log-status');
    const lineInput = document.getElementById('log-line-count');
    if (!refreshButton || !output) {
      return;
    }

    const fetchLogs = () => {
      const lines = Math.max(50, Math.min(2000, parseInt(lineInput?.value || '400', 10) || 400));
      if (status) {
        status.textContent = 'Fetching…';
      }
      fetch(`/admin/settings/logs?lines=${lines}`, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(payload => {
          if (!payload.ok) {
            throw new Error(payload.error || 'Unable to read logs.');
          }
          output.textContent = payload.content || '(no log entries)';
          if (status) {
            status.textContent = payload.truncated ? `Showing last ${lines} lines (truncated).` : `Showing up to ${lines} lines.`;
          }
        })
        .catch(error => {
          output.textContent = `Error loading logs: ${error.message}`;
          if (status) {
            status.textContent = 'Failed to fetch logs';
          }
        });
    };

    refreshButton.addEventListener('click', fetchLogs);
    fetchLogs();
  })();
</script>
{% endblock %}
