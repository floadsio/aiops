{% extends "base.html" %}
{% block title %}Issues | aiops Control Panel{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    .issues-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .issues-filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .issues-filter-form {
      display: contents;
    }
    .issues-filters select,
    .issues-filters input[type="text"] {
      margin: 0;
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.92);
      min-width: 180px;
      flex: 1 1 auto;
    }
    [data-theme="dark"] .issues-filters select,
    [data-theme="dark"] .issues-filters input[type="text"] {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(26, 29, 35, 0.65);
      color: rgba(226, 232, 240, 0.9);
    }
    .issues-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .issues-actions button,
    .issues-actions a[role="button"],
    .issues-actions .inline-form button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      white-space: nowrap;
      margin: 0;
    }
    .issue-refresh-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .issue-refresh-form button {
      margin: 0;
    }
    .issues-table table {
      width: 100%;
      table-layout: fixed;
    }
    .issues-table th {
      white-space: nowrap;
      padding: 0.75rem 0.5rem;
      font-size: 0.9rem;
    }
    .issues-table td {
      padding: 0.75rem 0.5rem;
      vertical-align: top;
    }
    .issues-table th:nth-child(1) { width: 6%; }  /* ID */
    .issues-table th:nth-child(2) { width: 28%; } /* Title */
    .issues-table th:nth-child(3) { width: 14%; } /* Status */
    .issues-table th:nth-child(4) { width: 7%; }  /* Provider */
    .issues-table th:nth-child(5) { width: 12%; } /* Project */
    .issues-table th:nth-child(6) { width: 10%; } /* Tenant */
    .issues-table th:nth-child(7) { width: 9%; }  /* Updated */
    .issues-table th:nth-child(8) { width: 9%; }  /* Assignee */
    .issues-table th:nth-child(9) { width: 10%; } /* Labels */
    .issue-actions-row {
      border-top: none;
    }
    .issue-actions-row td {
      padding-top: 0;
      padding-bottom: 1rem;
      background: rgba(241, 245, 249, 0.5);
    }
    [data-theme="dark"] .issue-actions-row td {
      background: rgba(30, 41, 59, 0.3);
    }
    .issues-table .sort-link {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }
    .issues-table .sort-link:hover,
    .issues-table .sort-link:focus {
      text-decoration: underline;
    }
    .issues-table .sort-indicator {
      font-size: 0.8rem;
      opacity: 0.65;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }
    .issues-table .sort-link.is-active .sort-indicator {
      opacity: 1;
    }
    .issues-table td:nth-child(2) {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .issue-status-form--inline {
      display: inline;
    }
    .issue-status-form--inline .issue-status-select {
      width: 100%;
      max-width: 100%;
    }
    .issue-title-button {
      background: none;
      border: none;
      color: #2563eb;
      text-align: left;
      width: 100%;
      font: inherit;
      padding: 0;
      cursor: pointer;
      text-align: left;
    }
    .issue-title-button:hover,
    .issue-title-button:focus {
      text-decoration: underline;
    }
    [data-theme="dark"] .issue-title-button {
      color: #93c5fd;
    }
    .issue-detail-row[hidden] {
      display: none;
    }
    .issue-detail {
      padding: 1.25rem 1.4rem;
      border-radius: 1rem;
      background: rgba(241, 245, 249, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: grid;
      gap: 0.8rem;
    }
    [data-theme="dark"] .issue-detail {
      background: rgba(30, 41, 59, 0.7);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .issue-detail__header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: flex-start;
    }
    .issue-detail__description {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    /* Markdown styling for issue descriptions */
    .issue-detail__description h1,
    .issue-detail__description h2,
    .issue-detail__description h3,
    .issue-detail__description h4,
    .issue-detail__description h5,
    .issue-detail__description h6 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
      line-height: 1.25;
    }
    .issue-detail__description h1 { font-size: 1.75em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .issue-detail__description h2 { font-size: 1.5em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .issue-detail__description h3 { font-size: 1.25em; }
    .issue-detail__description h4 { font-size: 1.1em; }
    .issue-detail__description h5 { font-size: 1em; }
    .issue-detail__description h6 { font-size: 0.9em; color: #64748b; }
    .issue-detail__description p {
      margin-bottom: 1em;
    }
    .issue-detail__description code {
      background-color: rgba(175, 184, 193, 0.2);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .issue-detail__description pre {
      background-color: #f6f8fa;
      border-radius: 6px;
      padding: 16px;
      overflow: auto;
      margin: 1em 0;
      font-size: 0.85em;
      line-height: 1.45;
    }
    .issue-detail__description pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    .issue-detail__description blockquote {
      border-left: 4px solid #dfe2e5;
      padding-left: 1em;
      margin: 1em 0;
      color: #6a737d;
    }
    .issue-detail__description ul,
    .issue-detail__description ol {
      padding-left: 2em;
      margin-bottom: 1em;
    }
    .issue-detail__description li {
      margin-bottom: 0.25em;
    }
    .issue-detail__description table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    .issue-detail__description table th,
    .issue-detail__description table td {
      border: 1px solid #dfe2e5;
      padding: 0.5em 1em;
    }
    .issue-detail__description table th {
      background-color: #f6f8fa;
      font-weight: 600;
    }
    .issue-detail__description hr {
      border: 0;
      border-top: 1px solid #e2e8f0;
      margin: 1.5em 0;
    }
    .issue-detail__description a {
      color: #0969da;
      text-decoration: none;
    }
    .issue-detail__description a:hover {
      text-decoration: underline;
    }
    /* Dark theme adjustments */
    [data-theme="dark"] .issue-detail__description h1,
    [data-theme="dark"] .issue-detail__description h2 {
      border-bottom-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description h6 {
      color: #8b949e;
    }
    [data-theme="dark"] .issue-detail__description code {
      background-color: rgba(110, 118, 129, 0.4);
    }
    [data-theme="dark"] .issue-detail__description pre {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-detail__description blockquote {
      border-left-color: #3b434b;
      color: #8b949e;
    }
    [data-theme="dark"] .issue-detail__description table th,
    [data-theme="dark"] .issue-detail__description table td {
      border-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description table th {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-detail__description hr {
      border-top-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description a {
      color: #58a6ff;
    }
    /* Apply same Markdown styling to comment bodies */
    .issue-comment__body {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .issue-comment__body h1,
    .issue-comment__body h2,
    .issue-comment__body h3,
    .issue-comment__body h4,
    .issue-comment__body h5,
    .issue-comment__body h6 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
      line-height: 1.25;
    }
    .issue-comment__body h1 { font-size: 1.5em; }
    .issue-comment__body h2 { font-size: 1.3em; }
    .issue-comment__body h3 { font-size: 1.15em; }
    .issue-comment__body h4 { font-size: 1.05em; }
    .issue-comment__body h5 { font-size: 0.95em; }
    .issue-comment__body h6 { font-size: 0.85em; color: #64748b; }
    .issue-comment__body p {
      margin-bottom: 1em;
    }
    .issue-comment__body code {
      background-color: rgba(175, 184, 193, 0.2);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .issue-comment__body pre {
      background-color: #f6f8fa;
      border-radius: 6px;
      padding: 16px;
      overflow: auto;
      margin: 1em 0;
      font-size: 0.85em;
      line-height: 1.45;
    }
    .issue-comment__body pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    .issue-comment__body blockquote {
      border-left: 4px solid #dfe2e5;
      padding-left: 1em;
      margin: 1em 0;
      color: #6a737d;
    }
    .issue-comment__body ul,
    .issue-comment__body ol {
      padding-left: 2em;
      margin-bottom: 1em;
    }
    .issue-comment__body li {
      margin-bottom: 0.25em;
    }
    .issue-comment__body table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    .issue-comment__body table th,
    .issue-comment__body table td {
      border: 1px solid #dfe2e5;
      padding: 0.5em 1em;
    }
    .issue-comment__body table th {
      background-color: #f6f8fa;
      font-weight: 600;
    }
    .issue-comment__body hr {
      border: 0;
      border-top: 1px solid #e2e8f0;
      margin: 1.5em 0;
    }
    .issue-comment__body a {
      color: #0969da;
      text-decoration: none;
    }
    .issue-comment__body a:hover {
      text-decoration: underline;
    }
    [data-theme="dark"] .issue-comment__body h6 {
      color: #8b949e;
    }
    [data-theme="dark"] .issue-comment__body code {
      background-color: rgba(110, 118, 129, 0.4);
    }
    [data-theme="dark"] .issue-comment__body pre {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-comment__body blockquote {
      border-left-color: #3b434b;
      color: #8b949e;
    }
    [data-theme="dark"] .issue-comment__body table th,
    [data-theme="dark"] .issue-comment__body table td {
      border-color: #30363d;
    }
    [data-theme="dark"] .issue-comment__body table th {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-comment__body hr {
      border-top-color: #30363d;
    }
    [data-theme="dark"] .issue-comment__body a {
      color: #58a6ff;
    }
    .issue-detail__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    .issue-detail__meta dt {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(71, 85, 105, 0.9);
      margin: 0;
    }
    .issue-detail__meta dd {
      margin: 0.1rem 0 0;
      font-weight: 600;
    }
    [data-theme="dark"] .issue-detail__meta dt {
      color: rgba(226, 232, 240, 0.72);
    }
    .issue-detail__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    .issue-detail__status {
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .issue-card__details {
      margin-top: 1rem;
    }
    .issue-card__description {
      margin-top: 0.75rem;
      font-size: 0.95rem;
      line-height: 1.45;
    }
  .issues-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
    .issue-status-form {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .issue-status-form--table {
      justify-content: flex-start;
    }
    .issue-status-select {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.92);
      font-size: 0.85rem;
      min-width: 9rem;
      appearance: none;
      position: relative;
    }
    .issue-status-input {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.85rem;
      min-width: 9rem;
    }
    [data-theme="dark"] .issue-status-input {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(26, 29, 35, 0.6);
      color: rgba(226, 232, 240, 0.9);
    }
    [data-theme="dark"] .issue-status-select {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(26, 29, 35, 0.65);
      color: rgba(226, 232, 240, 0.9);
    }
    .issue-card {
      padding: 1rem 1.25rem;
      border-radius: 0.7rem;
      background: rgba(26, 29, 35, 0.04);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    [data-theme="dark"] .issue-card {
      background: rgba(148, 163, 184, 0.08);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .issue-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .issue-card__header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .issue-card__title {
      margin: 0.25rem 0 0;
      font-size: 0.95rem;
    }
    .issue-card__meta {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: #64748b;
      margin: 0.5rem 0;
    }
    [data-theme="dark"] .issue-card__meta {
      color: rgba(148, 163, 184, 0.75);
    }
    @media (max-width: 768px) {
      .issues-header {
        margin-bottom: 1rem;
      }
      .issues-header h1 {
        font-size: 1.5rem;
      }
      .issues-filters {
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .issues-filters select {
        width: 100%;
        min-width: 0;
        font-size: 1rem; /* Prevents zoom on iOS */
      }
      .issues-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
      .issues-actions button,
      .issues-actions a[role="button"] {
        width: 100%;
        justify-content: center;
        padding: 0.6rem 1rem;
      }
      .issue-refresh-form {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem;
      }
      .issue-refresh-form button {
        width: 100%;
        padding: 0.6rem 1rem;
      }
    }
    @media (max-width: 768px) {
      /* Issue actions row - AI tools and buttons */
      .issue-actions-row td {
        padding: 0.75rem;
      }
      .issue-actions-row .issues-actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      .issue-actions-row .issues-actions button,
      .issue-actions-row .issues-actions .inline-form button {
        width: 100%;
        justify-content: center;
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
      }
      .issue-actions-row .issues-actions label {
        width: 100%;
        text-align: center;
        margin: 0;
      }
      /* Make pin/unpin buttons visible and full-width on mobile */
      .issues-actions .inline-form {
        display: block !important;
        width: 100%;
      }
      .issues-actions .inline-form button {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .issues-header h1 {
        font-size: 1.25rem;
      }
      .issues-actions button,
      .issues-actions a[role="button"] {
        font-size: 0.85rem;
        padding: 0.5rem 0.8rem;
      }
      .issue-actions-row .issues-actions button {
        font-size: 0.8rem;
        padding: 0.45rem 0.7rem;
      }
    }
    .issue-create-modal {
      position: fixed;
      inset: 0;
      background: rgba(26, 29, 35, 0.55);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 1000;
    }
    .issue-create-modal.is-open {
      display: flex;
    }
    .issue-create-modal__dialog {
      background: var(--surface, #fff);
      color: inherit;
      border-radius: 1rem;
      padding: 1.5rem;
      width: min(720px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 60px rgba(26, 29, 35, 0.25);
    }
    [data-theme="dark"] .issue-create-modal__dialog {
      background: rgba(26, 29, 35, 0.95);
    }
    .issue-create-modal__close {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      color: inherit;
    }
    .issue-create-form .form-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .issue-create-form label {
      font-weight: 600;
    }
    .issue-create-form input[type="text"],
    .issue-create-form select,
    .issue-create-form textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.65rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.92);
    }
    [data-theme="dark"] .issue-create-form input[type="text"],
    [data-theme="dark"] .issue-create-form select,
    [data-theme="dark"] .issue-create-form textarea {
      background: rgba(26, 29, 35, 0.75);
      border-color: rgba(148, 163, 184, 0.5);
      color: rgba(226, 232, 240, 0.95);
    }
    .issue-create-form textarea {
      min-height: 120px;
      resize: vertical;
    }
    .issue-create-summary {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      background: rgba(241, 245, 249, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    [data-theme="dark"] .issue-create-summary {
      background: rgba(30, 41, 59, 0.75);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .form-hint {
      font-size: 0.85rem;
      color: rgba(71, 85, 105, 0.9);
    }
    [data-theme="dark"] .form-hint {
      color: rgba(226, 232, 240, 0.65);
    }
    .form-error {
      font-size: 0.85rem;
      color: #dc2626;
    }
    .issue-create-custom-fields {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
    }
    .issue-create-assignee select option.is-disabled {
      color: rgba(148, 163, 184, 0.8);
    }
    .issue-create-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.25rem;
    }

    /* Issue description styling (from communications) */
    .issue-card__description {
      line-height: 1.4;
      color: var(--pico-color-slate-800);
      word-wrap: break-word;
      margin: 0.25rem 0 0 0;
      padding: 0;
      background: transparent;
      border-radius: 0;
      border-left: none;
    }
    [data-theme="dark"] .issue-card__description {
      color: rgba(226, 232, 240, 0.85);
      background: transparent;
    }
    .issue-card__description p {
      margin: 0.15rem 0;
    }
    .issue-card__description p:first-child {
      margin-top: 0;
    }
    .issue-card__description p:last-child {
      margin-bottom: 0;
    }
    .issue-card__description a {
      color: var(--md-primary);
      text-decoration: underline;
    }
    [data-theme="dark"] .issue-card__description a {
      color: #42a5f5;
    }
    .issue-card__description code,
    .issue-card__description tt {
      background: rgba(148, 163, 184, 0.1);
      padding: 0.2rem 0.4rem;
      border-radius: 0.2rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    [data-theme="dark"] .issue-card__description code,
    [data-theme="dark"] .issue-card__description tt {
      background: rgba(148, 163, 184, 0.2);
    }
    /* Jira preformatted panels */
    .issue-card__description .preformatted.panel {
      background: rgba(26, 29, 35, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.4rem;
      margin: 0.5rem 0;
    }
    [data-theme="dark"] .issue-card__description .preformatted.panel {
      background: rgba(26, 29, 35, 0.35);
      border-color: rgba(148, 163, 184, 0.35);
    }
    .issue-card__description .panelContent {
      padding: 0.5rem;
    }
    .issue-card__description .panelContent pre {
      margin: 0;
      background: transparent;
      border: none;
    }
    .issue-card__description pre {
      background: rgba(26, 29, 35, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.4rem;
      padding: 0.5rem;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 0.3rem 0;
    }
    [data-theme="dark"] .issue-card__description pre {
      background: rgba(26, 29, 35, 0.35);
      border-color: rgba(148, 163, 184, 0.35);
    }
    .issue-card__description pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
    }
    .issue-card__description blockquote {
      border-left: 3px solid var(--md-primary);
      padding-left: 1rem;
      margin: 0.3rem 0;
      color: #64748b;
      font-style: italic;
    }
    [data-theme="dark"] .issue-card__description blockquote {
      color: rgba(148, 163, 184, 0.75);
    }
    .issue-card__description ul,
    .issue-card__description ol {
      margin: 0.2rem 0;
      padding-left: 1.75rem;
    }
    .issue-card__description li {
      margin: 0.1rem 0;
    }
    .issue-card__description h1,
    .issue-card__description h2,
    .issue-card__description h3,
    .issue-card__description h4,
    .issue-card__description h5,
    .issue-card__description h6 {
      margin: 0.5rem 0 0.2rem 0;
      font-weight: 600;
    }
    .issue-card__description h1 {
      font-size: 1.3rem;
      border-bottom: 2px solid rgba(148, 163, 184, 0.25);
      padding-bottom: 0.3rem;
    }
    .issue-card__description h2 {
      font-size: 1.15rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding-bottom: 0.15rem;
    }
    .issue-card__description h3 {
      font-size: 1.05rem;
    }
    .issue-card__description hr {
      margin: 0.4rem 0;
      border: none;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
    }
    .issue-card__description del {
      color: #64748b;
      text-decoration: line-through;
    }
    [data-theme="dark"] .issue-card__description del {
      color: rgba(148, 163, 184, 0.75);
    }
    .issue-card__description strong {
      font-weight: 700;
    }
    .issue-card__description em {
      font-style: italic;
    }

    .issue-card__details summary {
      cursor: pointer;
      font-weight: 500;
      color: var(--pico-primary);
      margin-bottom: 0.35rem;
    }
    .provider-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(148, 163, 184, 0.15);
    }
    [data-theme="dark"] .provider-badge {
      background: rgba(148, 163, 184, 0.25);
    }
  </style>
{% endblock %}
{% block content %}
<div class="issues-header">
  <h1>Issues</h1>
</div>

<!-- Filters Section -->
<div class="issues-filters">
  <form method="get" class="issues-filter-form">
    <select id="issue-status-filter" name="status" onchange="this.form.submit()" aria-label="Filter by issue status">
      {% for option in status_options %}
        <option value="{{ option.value }}" {% if option.value == status_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <select id="issue-tenant-filter" name="tenant" onchange="this.form.submit()" aria-label="Filter by tenant">
      {% for option in tenant_options %}
        <option value="{{ option.value }}" {% if option.value == tenant_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <select id="issue-project-filter" name="project" onchange="this.form.submit()" aria-label="Filter by project">
      {% for option in project_options %}
        <option value="{{ option.value }}" {% if option.value == project_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <select id="issue-assignee-filter" name="assignee" onchange="this.form.submit()" aria-label="Filter by assignee">
      {% for option in assignee_options %}
        <option value="{{ option.value }}" {% if option.value == assignee_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <input type="hidden" name="sort" value="{{ sort_state.key }}">
    <input type="hidden" name="direction" value="{{ sort_state.direction }}">
  </form>
  <input
    type="text"
    id="issueSearchInput"
    placeholder="Search issues..."
    aria-label="Search issues"
  >
</div>

<!-- Actions Section -->
<div class="issues-actions">
  {% set has_issue_targets = issue_create_form.project_integration_id.choices|length > 0 %}
  <button
    type="button"
    class="primary"
    data-issue-create-open
    {% if not has_issue_targets %}disabled title="Link a project integration before creating issues"{% endif %}
  >
    New Issue
  </button>

  <a href="{{ url_for('admin.create_assisted_issue') }}" class="secondary" role="button">
    ü§ñ AI-Assisted Issue
  </a>

  {% if current_user_name %}
    <a href="{{ url_for('admin.manage_issues', status=status_filter if status_filter != 'all' else None, tenant=tenant_filter if tenant_filter != 'all' else None, project=project_filter if project_filter != 'all' else None, assignee='__me__', sort=sort_state.key, direction=sort_state.direction) }}" class="secondary" role="button">
      My Issues
    </a>
  {% endif %}

  <form method="post" action="{{ url_for('admin.refresh_all_issues') }}" class="issue-refresh-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <button type="submit" class="secondary">Refresh All Issues</button>
    <button type="submit" class="secondary outline" name="force_full" value="1" title="Fetch all issues from every provider, ignoring incremental tracking.">
      Force Full Resync
    </button>
  </form>
</div>

<div
  id="issue-create-modal"
  class="issue-create-modal{% if issue_create_modal_open %} is-open{% endif %}"
  data-options='{{ issue_create_options|tojson }}'
  data-custom-values='{{ issue_custom_field_values|tojson }}'
  data-custom-errors='{{ issue_custom_field_errors|tojson }}'
>
  <div
    class="issue-create-modal__dialog"
    role="dialog"
    aria-modal="true"
    aria-labelledby="issue-create-title"
  >
    <button type="button" class="issue-create-modal__close" data-issue-create-dismiss aria-label="Close issue form">
      &times;
    </button>
    <h2 id="issue-create-title">Create New Issue</h2>
    {% if has_issue_targets %}
      <form method="post" class="issue-create-form" action="{{ url_for('admin.manage_issues') }}" novalidate>
        {{ issue_create_form.hidden_tag() }}
        <div class="form-group">
          <label for="issue-create-target">Project</label>
          <select
            id="issue-create-target"
            name="{{ issue_create_form.project_integration_id.name }}"
            data-issue-create-target
            required
          >
            {% set selected_target = issue_create_form.project_integration_id.data %}
            {% for value, label in issue_create_form.project_integration_id.choices %}
              <option value="{{ value }}" {% if value == selected_target %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
          {% if issue_create_form.project_integration_id.errors %}
            <div class="form-error">{{ issue_create_form.project_integration_id.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="issue-create-summary" data-issue-create-summary>
          <p>Select a project integration to load provider-specific fields.</p>
        </div>

        <div class="form-group">
          <label for="issue-create-summary-input">Title</label>
          {{ issue_create_form.summary(id="issue-create-summary-input") }}
          {% if issue_create_form.summary.errors %}
            <div class="form-error">{{ issue_create_form.summary.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="issue-create-description">Description</label>
          {{ issue_create_form.description(id="issue-create-description") }}
          {% if issue_create_form.description.errors %}
            <div class="form-error">{{ issue_create_form.description.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group" data-issue-field="issue-type">
          <label for="issue-create-type">Issue Type (Jira)</label>
          {{ issue_create_form.issue_type(id="issue-create-type") }}
          <p class="form-hint">Defaults to the integration's configured issue type.</p>
          {% if issue_create_form.issue_type.errors %}
            <div class="form-error">{{ issue_create_form.issue_type.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group" data-issue-field="milestone">
          <label for="issue-create-milestone">Milestone</label>
          {{ issue_create_form.milestone(id="issue-create-milestone") }}
          <p class="form-hint">GitHub accepts number or title; GitLab matches the milestone title.</p>
          {% if issue_create_form.milestone.errors %}
            <div class="form-error">{{ issue_create_form.milestone.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group" data-issue-field="priority">
          <label for="issue-create-priority">Priority (Jira)</label>
          {{ issue_create_form.priority(id="issue-create-priority") }}
          {% if issue_create_form.priority.errors %}
            <div class="form-error">{{ issue_create_form.priority.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="issue-create-labels">Labels / Tags</label>
          {{ issue_create_form.labels(id="issue-create-labels") }}
          {% if issue_create_form.labels.errors %}
            <div class="form-error">{{ issue_create_form.labels.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="form-group issue-create-assignee">
          <label for="issue-create-assignee">Assignee</label>
          <select
            id="issue-create-assignee"
            name="{{ issue_create_form.assignee_user_id.name }}"
            data-issue-create-assignee
          >
            {% set selected_assignee = issue_create_form.assignee_user_id.data or 0 %}
            {% for value, label in issue_create_form.assignee_user_id.choices %}
              {% if value == 0 %}
                <option value="0" {% if selected_assignee == 0 %}selected{% endif %}>{{ label }}</option>
              {% else %}
                {% set capability = issue_create_capabilities.get(value, {}) %}
                <option
                  value="{{ value }}"
                  data-has-github="{{ 1 if capability.get('github') else 0 }}"
                  data-has-gitlab="{{ 1 if capability.get('gitlab') else 0 }}"
                  data-has-jira="{{ 1 if capability.get('jira') else 0 }}"
                  {% if selected_assignee == value %}selected{% endif %}
                >
                  {{ label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
          <p class="form-hint">Only users with mapped identities for the provider can be assigned.</p>
          {% if issue_create_form.assignee_user_id.errors %}
            <div class="form-error">{{ issue_create_form.assignee_user_id.errors[0] }}</div>
          {% endif %}
        </div>

        <div class="issue-create-custom-fields" data-custom-fields-wrapper hidden>
          <p class="form-hint">Additional required fields for the selected provider.</p>
          <div data-custom-fields></div>
        </div>

        <div class="issue-create-actions">
          <button type="button" class="secondary outline" data-issue-create-dismiss>Cancel</button>
          <button
            type="submit"
            class="primary"
            name="{{ issue_create_form.submit.name }}"
            value="1"
          >
            {{ issue_create_form.submit.label.text }}
          </button>
        </div>
      </form>
    {% else %}
      <p class="text-muted">
        No project integrations with issue creation support are configured yet. Link a project to GitHub, GitLab, or Jira to enable this form.
      </p>
    {% endif %}
  </div>
</div>

{% if issues %}
  <p class="text-muted">
    Showing {{ total_issue_count }} of {{ total_issue_full_count }}
    issue{{ '' if total_issue_full_count == 1 else 's' }}
    {% if status_filter != 'all' %}
      (status: {{ status_filter_label }})
    {% endif %}
    {% if tenant_filter != 'all' %}
      (tenant: {{ tenant_filter_label }})
    {% endif %}
    {% if project_filter != 'all' %}
      (project: {{ project_filter_label }})
    {% endif %}
    {% if assignee_filter != 'all' %}
      (assignee: {{ assignee_filter_label }})
    {% endif %}.
  </p>

    {% for issue in issues %}
      <article class="issue-card">
        <header class="issue-card__header">
          <div>
            <h3>
              {% if issue.url %}
                <a href="{{ issue.url }}" target="_blank" rel="noopener">{{ issue.external_id }}</a>
              {% else %}
                {{ issue.external_id }}
              {% endif %}
              <span class="text-muted" style="font-size: 0.75rem; margin-left: 0.5rem; font-weight: 400;">(DB: {{ issue.id }})</span>
            </h3>
            <p class="issue-card__title">{{ issue.title }}</p>
          </div>
          <div>
            {% if issue.status %}
              <span class="badge {% if issue.status_key == 'closed' %}success{% elif issue.status_key == 'open' %}secondary{% endif %}">
                {{ issue.status }}
              </span>
            {% else %}
              <span class="badge">Unspecified</span>
            {% endif %}
          </div>
        </header>
        <div class="issue-card__meta">
          <span class="provider-badge">{{ issue.provider|capitalize }}</span>
          <span>üìÅ {{ issue.project_name or "Unknown project" }}</span>
          {% if issue.tenant_name %}
            <span class="tenant-badge" style="--tenant-color: {{ issue.tenant_color or default_tenant_color }}">
              <span class="tenant-badge__swatch" aria-hidden="true"></span>
              {{ issue.tenant_name }}
            </span>
          {% endif %}
          {% if issue.assignee %}
            <span>üë§ {{ issue.assignee }}</span>
          {% else %}
            <span class="text-muted">Unassigned</span>
          {% endif %}
          <span class="text-muted">Updated {{ issue.updated_display or "Unknown" }}</span>
        </div>
        <details class="issue-card__details">
          <summary>View details</summary>
          <div class="issue-card__description">
            {% if issue.description_html %}
              {# Pre-rendered HTML from Jira API - sanitize and display directly #}
              {{ issue.description_html|sanitize_html }}
            {% elif issue.description_available %}
              {# Markdown/plain text - render using text_rendering #}
              {{ issue.description|render_issue_content }}
            {% else %}
              <span class="text-muted">{{ issue.description_fallback }}</span>
            {% endif %}
          </div>
          {% if issue.comments %}
            <div class="issue-comments" style="margin-top: 1rem;">
              <strong>Comments ({{ issue.comment_count }})</strong>
              {% for comment in issue.comments %}
                <div class="issue-comment" id="comment-{{ comment.id }}" style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(148, 163, 184, 0.1); border-radius: 0.4rem;">
                  <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.25rem;">
                    <span>
                      <strong>{{ comment.author or 'Unknown' }}</strong>
                      {% if comment.created_display %} ¬∑ {{ comment.created_display }}{% endif %}
                      {% if comment.url %} ¬∑ <a href="{{ comment.url }}" target="_blank" rel="noopener">View</a>{% endif %}
                    </span>
                    <button type="button" class="pin-comment-btn tertiary outline" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;"
                            data-issue-id="{{ issue.id }}"
                            data-comment-id="{{ comment.id }}">
                      üìå Pin
                    </button>
                  </div>
                  <div class="comment-body">
                    {% if comment.body_html %}
                      {# Pre-rendered HTML from Jira API #}
                      {{ comment.body_html|sanitize_html }}
                    {% else %}
                      {{ comment.body|render_issue_content }}
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          {% if issue.url %}
            <p><a href="{{ issue.url }}" target="_blank" rel="noopener">Open in tracker</a></p>
          {% endif %}
        </details>
        {% if issue.project_id %}
          <div class="issues-actions">
            {% if issue.is_pinned %}
              <form
                method="post"
                class="inline-form"
                action="{{ url_for('projects.unpin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
              >
                <input type="hidden" name="next" value="{{ current_view_url }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="tertiary outline" style="color:#f59e0b;">‚òÖ Unpin</button>
              </form>
            {% else %}
              <form
                method="post"
                class="inline-form"
                action="{{ url_for('projects.pin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
              >
                <input type="hidden" name="next" value="{{ current_view_url }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="tertiary outline">‚òÜ Pin</button>
              </form>
            {% endif %}
            {% if issue.codex_target and issue.prepare_endpoint and issue.codex_payload %}
              <label style="margin-right: 1em; font-size: 0.9em;">
                <input type="checkbox" class="yolo-mode-checkbox-issue" data-issue-id="{{ issue.id }}" data-project-id="{{ issue.project_id }}" />
                <span style="color: #ff6b6b;" title="Skip all permissions (dangerous)">‚ö†Ô∏è Yolo</span>
              </label>
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
                data-tool="claude"
                data-command="{{ ai_tool_commands.get('claude') or default_ai_shell }}"
                data-issue-id="{{ issue.id }}"
              >
                Claude
              </button>
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
                data-tool="codex"
                data-command="{{ ai_tool_commands.get('codex') or default_ai_shell }}"
                data-issue-id="{{ issue.id }}"
              >
                Codex
              </button>
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
                data-tool="shell"
                data-command="{{ ai_tool_commands.get('shell') or default_ai_shell }}"
                data-issue-id="{{ issue.id }}"
              >
                Shell
              </button>
            {% endif %}
            {% if issue.populate_endpoint %}
              <button
                type="button"
                class="tertiary issues-populate-agents"
                data-populate="{{ issue.populate_endpoint }}"
              >
                Populate AGENTS.override.md
              </button>
            {% endif %}
            {% if issue.can_close and issue.close_endpoint %}
              <form method="post" action="{{ issue.close_endpoint }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="secondary outline">‚úï Close Issue</button>
              </form>
            {% endif %}
            {% if issue.tenant_id and issue.tenant_id in tenants_with_multiple_projects %}
              <select class="move-to-project-select tertiary outline"
                      data-issue-id="{{ issue.id }}"
                      data-current-project="{{ issue.project_id }}"
                      data-tenant-id="{{ issue.tenant_id }}"
                      style="padding: 0.25rem 0.5rem; font-size: 0.85rem; min-width: 140px;">
                <option value="">üì¶ Move to...</option>
              </select>
            {% endif %}
          </div>
        {% endif %}
      </article>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">No issues found for the selected filter.</p>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const detailButtons = document.querySelectorAll('.issue-detail-toggle');
    detailButtons.forEach(button => {
      button.addEventListener('click', () => {
        const issueId = button.dataset.issueId;
        if (!issueId) {
          return;
        }
        const detailRow = document.getElementById(`issue-detail-${issueId}`);
        if (!detailRow) {
          return;
        }
        const isHidden = detailRow.hasAttribute('hidden');
        if (isHidden) {
          detailRow.removeAttribute('hidden');
          button.setAttribute('aria-expanded', 'true');
        } else {
          detailRow.setAttribute('hidden', '');
          button.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Auto-expand issue if issue_id is in URL query parameters or passed via template
    const urlParams = new URLSearchParams(window.location.search);
    const targetIssueId = urlParams.get('issue_id') || {{ ('"' + target_issue_id|string + '"') if target_issue_id else 'null' }};

    // Function to scroll to and highlight a comment
    function scrollToComment(commentId) {
      const commentElement = document.getElementById(commentId);
      if (commentElement) {
        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Add highlight effect
        commentElement.style.transition = 'background-color 0.3s';
        commentElement.style.backgroundColor = 'rgba(88, 166, 255, 0.2)';
        setTimeout(() => {
          commentElement.style.backgroundColor = '';
        }, 3000);
        return true;
      }
      return false;
    }

    if (targetIssueId) {
      const targetButton = document.querySelector(`.issue-detail-toggle[data-issue-id="${targetIssueId}"]`);
      const targetDetailRow = document.getElementById(`issue-detail-${targetIssueId}`);

      if (targetButton && targetDetailRow) {
        // Expand the issue detail
        targetDetailRow.removeAttribute('hidden');
        targetButton.setAttribute('aria-expanded', 'true');

        // Scroll to the issue with smooth behavior
        setTimeout(() => {
          targetButton.scrollIntoView({ behavior: 'smooth', block: 'center' });

          // After expanding, check for comment hash and scroll to it
          if (window.location.hash && window.location.hash.startsWith('#comment-')) {
            const commentId = window.location.hash.substring(1);
            setTimeout(() => scrollToComment(commentId), 200);
          }
        }, 100);
      } else {
        // Issue not found on this page - might be filtered out or on different page
        console.warn(`Issue ${targetIssueId} not found on page. Check status filter.`);
      }
    }

    // Also handle direct comment hash navigation (without issue_id param)
    if (window.location.hash && window.location.hash.startsWith('#comment-')) {
      const commentId = window.location.hash.substring(1);
      // Try to scroll to comment after a short delay (in case issue needs to load)
      setTimeout(() => {
        if (!scrollToComment(commentId)) {
          console.warn(`Comment element ${commentId} not found. Issue may need to be expanded first.`);
        }
      }, 300);
    }

    // Pin comment button handler
    document.querySelectorAll('.pin-comment-btn').forEach(button => {
      button.addEventListener('click', async (event) => {
        event.preventDefault();
        event.stopPropagation();

        const issueId = button.dataset.issueId;
        const commentId = button.dataset.commentId;
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

        try {
          const response = await fetch(`/api/v1/issues/${issueId}/comments/${commentId}/pin`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken,
            },
            body: JSON.stringify({}),
          });

          const data = await response.json();

          if (response.ok) {
            button.textContent = '‚úì Pinned';
            button.disabled = true;
            button.style.color = '#22c55e';
            setTimeout(() => {
              button.textContent = 'üìå Pin';
              button.disabled = false;
              button.style.color = '';
            }, 2000);
          } else {
            alert(data.error || 'Failed to pin comment');
          }
        } catch (err) {
          console.error('Pin comment error:', err);
          alert('Failed to pin comment');
        }
      });
    });

    const codexButtons = document.querySelectorAll('.issues-start-codex');
    const populateButtons = document.querySelectorAll('.issues-populate-agents');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenValue = csrfMeta ? csrfMeta.getAttribute('content') : '';

    codexButtons.forEach(button => {
      button.addEventListener('click', () => {
        const projectId = button.dataset.projectId;
        const target = button.dataset.target;
        const prepareEndpoint = button.dataset.prepare;
        const payloadRaw = button.dataset.context;
        const toolOverride = button.dataset.tool;
        const commandOverride = button.dataset.command;
        const issueId = button.dataset.issueId;
        if (!projectId || !target || !prepareEndpoint || !payloadRaw) {
          return;
        }

        // Check if yolo mode is enabled
        const yoloCheckbox = document.querySelector(`.yolo-mode-checkbox-issue[data-issue-id="${issueId}"][data-project-id="${projectId}"]`);
        const yoloMode = yoloCheckbox && yoloCheckbox.checked;

        let payload;
        try {
          payload = JSON.parse(payloadRaw);
        } catch (error) {
          return;
        }

        // Override the tool if specified on the button
        if (toolOverride) {
          payload.tool = toolOverride;
          if (commandOverride) {
            payload.command = commandOverride;
          }
        }

        const storageKey = `aiops-session-context-${projectId}`;

        const finalize = (context) => {
          // Add yolo mode if checked
          if (yoloMode) {
            context.permissionMode = 'yolo';
          }
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(context));
          } catch (error) {
            /* ignore storage errors */
          }
          window.location.href = target;
        };

        const preparePayload = {};
        if (payload.tool) {
          preparePayload.tool = payload.tool;
        }

        fetch(prepareEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify(preparePayload),
        })
          .then((response) => (
            response.ok
              ? response.json()
              : response.json().then((data) => Promise.reject(data))
          ))
          .then((data) => {
            finalize({
              prompt: data.prompt,
              command: data.command,
              tool: data.tool || payload.tool,
              autoStart: true,
              tmuxTarget: data.tmux_target || null,
              issueId: issueId,
            });
          })
          .catch(() => {
            finalize({
              prompt: payload.prompt,
              command: payload.command,
              tool: payload.tool,
              autoStart: payload.autoStart,
              tmuxTarget: payload.tmuxTarget || null,
              issueId: issueId,
            });
          });
      });
    });

    populateButtons.forEach(button => {
      button.addEventListener('click', () => {
        const endpoint = button.dataset.populate;
        if (!endpoint) {
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Populating...';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then(response => (
            response.ok
              ? response.json()
              : response.json().then(data => Promise.reject(data))
          ))
          .then(data => {
            button.textContent = 'AGENTS.override.md updated';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2000);
            if (data && data.tracked_path) {
              console.info(`Updated agent context at ${data.tracked_path}`);
            }
          })
          .catch(error => {
            console.error('Failed to populate AGENTS.override.md', error);
            button.textContent = 'Update failed';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2500);
          });
      });
    });

    const creationModal = document.getElementById('issue-create-modal');
    if (creationModal) {
      const openButtons = document.querySelectorAll('[data-issue-create-open]');
      const closeSelectors = creationModal.querySelectorAll('[data-issue-create-dismiss]');
      const targetSelect = creationModal.querySelector('[data-issue-create-target]');
      const summaryBlock = creationModal.querySelector('[data-issue-create-summary]');
      const issueTypeGroup = creationModal.querySelector('[data-issue-field="issue-type"]');
      const issueTypeInput = creationModal.querySelector('#issue-create-type');
      const milestoneGroup = creationModal.querySelector('[data-issue-field="milestone"]');
      const priorityGroup = creationModal.querySelector('[data-issue-field="priority"]');
      const customFieldsWrapper = creationModal.querySelector('[data-custom-fields-wrapper]');
      const customFieldsHost = creationModal.querySelector('[data-custom-fields]');
      const assigneeSelect = creationModal.querySelector('[data-issue-create-assignee]');
      const integrationOptions = JSON.parse(creationModal.dataset.options || '[]');
      const integrationMap = new Map(
        integrationOptions.map((option) => [String(option.id), option]),
      );
      const customValues = JSON.parse(creationModal.dataset.customValues || '{}');
      const customErrors = JSON.parse(creationModal.dataset.customErrors || '{}');
      const providerCapabilityKeys = {
        github: 'hasGithub',
        gitlab: 'hasGitlab',
        jira: 'hasJira',
      };

      const toggleModal = (open) => {
        creationModal.classList.toggle('is-open', open);
        if (open && targetSelect) {
          targetSelect.focus();
        }
      };

      openButtons.forEach((button) => {
        if (button.disabled) {
          return;
        }
        button.addEventListener('click', () => toggleModal(true));
      });

      closeSelectors.forEach((button) => {
        button.addEventListener('click', () => toggleModal(false));
      });
      creationModal.addEventListener('click', (event) => {
        if (event.target === creationModal) {
          toggleModal(false);
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && creationModal.classList.contains('is-open')) {
          toggleModal(false);
        }
      });

      const updateSummary = (meta) => {
        if (!summaryBlock) {
          return;
        }
        if (!meta) {
          summaryBlock.innerHTML = '<p>Select a project integration to load provider-specific fields.</p>';
          return;
        }
        summaryBlock.innerHTML = `
          <p><strong>${meta.project_name}</strong></p>
          <p>${meta.tenant_name} ‚Ä¢ ${meta.provider_label}</p>
        `;
      };

      const updateFieldVisibility = (meta) => {
        const supports = meta?.supports || {};
        if (issueTypeGroup) {
          issueTypeGroup.hidden = !supports.issue_type;
        }
        if (issueTypeInput) {
          issueTypeInput.placeholder = meta?.issue_type_default
            ? `Default: ${meta.issue_type_default}`
            : '';
        }
        if (milestoneGroup) {
          milestoneGroup.hidden = !supports.milestone;
        }
        if (priorityGroup) {
          priorityGroup.hidden = !supports.priority;
        }
      };

      const renderCustomFields = (meta) => {
        if (!customFieldsWrapper || !customFieldsHost) {
          return;
        }
        customFieldsHost.innerHTML = '';
        const fields = meta?.custom_fields || [];
        if (!meta || !meta.supports?.custom_fields || fields.length === 0) {
          customFieldsWrapper.hidden = true;
          return;
        }
        customFieldsWrapper.hidden = false;
        fields.forEach((field) => {
          const group = document.createElement('div');
          group.className = 'form-group';
          const label = document.createElement('label');
          const labelSuffix = field.required ? ' *' : '';
          label.htmlFor = `${field.input_name}-${meta.id}`;
          label.textContent = `${field.label}${labelSuffix}`;
          let input;
          if (field.type === 'select') {
            input = document.createElement('select');
            input.appendChild(new Option('Select‚Ä¶', ''));
            (field.options || []).forEach((option) => {
              const opt = document.createElement('option');
              opt.value = option.value;
              opt.textContent = option.label;
              input.appendChild(opt);
            });
          } else {
            input = document.createElement('input');
            input.type = field.type === 'number' ? 'number' : 'text';
          }
          input.name = field.input_name;
          input.id = `${field.input_name}-${meta.id}`;
          if (field.required) {
            input.required = true;
          }
          if (customValues[field.input_name] !== undefined) {
            input.value = customValues[field.input_name];
          }
          group.appendChild(label);
          group.appendChild(input);
          if (field.description) {
            const hint = document.createElement('p');
            hint.className = 'form-hint';
            hint.textContent = field.description;
            group.appendChild(hint);
          }
          if (customErrors[field.input_name]) {
            const error = document.createElement('div');
            error.className = 'form-error';
            error.textContent = customErrors[field.input_name];
            group.appendChild(error);
          }
          customFieldsHost.appendChild(group);
        });
      };

      const updateAssigneeOptions = (provider) => {
        if (!assigneeSelect) {
          return;
        }
        const datasetKey = providerCapabilityKeys[provider] || null;
        const options = assigneeSelect.querySelectorAll('option');
        options.forEach((option) => {
          if (!datasetKey || option.value === '0') {
            option.disabled = false;
            option.classList.remove('is-disabled');
            return;
          }
          const allowed = option.dataset[datasetKey];
          const isEnabled = allowed === undefined || allowed === '1';
          option.disabled = !isEnabled;
          option.classList.toggle('is-disabled', !isEnabled);
        });
        if (assigneeSelect.selectedOptions.length && assigneeSelect.selectedOptions[0].disabled) {
          assigneeSelect.value = '0';
        }
      };

      const applyIntegrationMeta = () => {
        const selectedId = targetSelect ? String(targetSelect.value || '') : '';
        const meta = integrationMap.get(selectedId);
        updateSummary(meta);
        updateFieldVisibility(meta);
        renderCustomFields(meta);
        updateAssigneeOptions(meta ? meta.provider : null);
      };

      if (targetSelect) {
        targetSelect.addEventListener('change', applyIntegrationMeta);
        applyIntegrationMeta();
      }
      if (creationModal.classList.contains('is-open')) {
        toggleModal(true);
      }
    }

    const statusForms = document.querySelectorAll('[data-issue-status-form]');
    statusForms.forEach(form => {
      const select = form.querySelector('[data-status-select]');
      const customInput = form.querySelector('[data-status-custom]');
      const hiddenInput = form.querySelector('[data-status-hidden]');
      if (!select || !hiddenInput) {
        return;
      }

      const syncState = () => {
        const choice = select.value;
        if (choice === '__custom__') {
          if (customInput) {
            customInput.removeAttribute('hidden');
            customInput.removeAttribute('disabled');
            hiddenInput.value = customInput.value.trim();
            customInput.focus();
          } else {
            hiddenInput.value = '';
          }
        } else {
          if (customInput) {
            customInput.value = '';
            customInput.setAttribute('hidden', '');
            customInput.setAttribute('disabled', '');
          }
          hiddenInput.value = choice;
        }
      };

      select.addEventListener('change', syncState);
      if (customInput) {
        customInput.addEventListener('input', () => {
          if (select.value === '__custom__') {
            hiddenInput.value = customInput.value.trim();
          }
        });
      }
      form.addEventListener('submit', () => {
        if (select.value === '__custom__' && customInput) {
          hiddenInput.value = customInput.value.trim();
        }
      });

      syncState();
    });
  })();

  // Client-side search filter
  (function() {
    const searchInput = document.getElementById('issueSearchInput');
    const issueCards = document.querySelectorAll('.issue-card');

    if (!searchInput) return;

    searchInput.addEventListener('input', function() {
      const searchQuery = this.value.toLowerCase().trim();

      issueCards.forEach(card => {
        if (!searchQuery) {
          card.style.display = '';
          return;
        }

        const title = card.querySelector('.issue-card__title')?.textContent.toLowerCase() || '';
        const description = card.querySelector('.issue-card__description')?.textContent.toLowerCase() || '';
        const meta = card.querySelector('.issue-card__meta')?.textContent.toLowerCase() || '';

        const matches = title.includes(searchQuery) ||
                       description.includes(searchQuery) ||
                       meta.includes(searchQuery);

        card.style.display = matches ? '' : 'none';
      });
    });
  })();

  // Move issue to different project
  (function() {
    const moveSelects = document.querySelectorAll('.move-to-project-select');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // Cache for tenant projects
    const projectCache = new Map();

    async function loadTenantProjects(tenantId) {
      if (projectCache.has(tenantId)) {
        return projectCache.get(tenantId);
      }

      try {
        const response = await fetch(`/api/v1/projects?tenant_id=${tenantId}`, {
          credentials: 'same-origin',
        });
        if (!response.ok) throw new Error('Failed to load projects');
        const data = await response.json();
        const projects = data.projects || data || [];
        projectCache.set(tenantId, projects);
        return projects;
      } catch (error) {
        console.error('Failed to load tenant projects:', error);
        return [];
      }
    }

    // Preload projects for all dropdowns on page load
    const tenantIds = new Set();
    moveSelects.forEach(select => {
      tenantIds.add(select.dataset.tenantId);
    });
    tenantIds.forEach(tenantId => loadTenantProjects(tenantId));

    moveSelects.forEach(select => {
      const tenantId = select.dataset.tenantId;
      const currentProjectId = parseInt(select.dataset.currentProject, 10);
      const issueId = select.dataset.issueId;

      // Populate options from cache (or wait for preload)
      async function populateOptions() {
        if (select.options.length > 1) return;

        const projects = await loadTenantProjects(tenantId);
        projects.forEach(project => {
          if (project.id !== currentProjectId) {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            select.appendChild(option);
          }
        });
      }

      // Populate immediately (projects should already be loading/loaded)
      populateOptions();

      // Handle move
      select.addEventListener('change', async function() {
        const targetProjectId = this.value;
        if (!targetProjectId) return;

        const targetProjectName = this.options[this.selectedIndex].text;

        if (!confirm(`Move this issue to "${targetProjectName}"?`)) {
          this.value = '';
          return;
        }

        this.disabled = true;
        const originalText = this.options[0].text;
        this.options[0].text = 'Moving...';
        this.value = '';

        try {
          const response = await fetch(`/api/v1/issues/${issueId}/move`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
              'X-CSRF-Token': csrfToken,
            },
            credentials: 'same-origin',
            body: JSON.stringify({ project_id: parseInt(targetProjectId, 10) }),
          });

          const data = await response.json();

          if (response.ok) {
            this.options[0].text = '‚úì Moved!';
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            throw new Error(data.error || 'Failed to move issue');
          }
        } catch (error) {
          alert('Failed to move issue: ' + error.message);
          this.options[0].text = originalText;
          this.disabled = false;
        }
      });
    });
  })();
</script>
{% endblock %}
