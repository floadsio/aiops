{% extends "base.html" %}
{% block title %}Integrations | aiops Control Panel{% endblock %}
{% block content %}
<h1>Issue Integrations</h1>
<p>Register tenant-level credentials for GitHub, GitLab, or Jira and map repositories or projects so issues can be synchronized.</p>
<style>
  .button-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .integration-inline-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }
  .integration-inline-form button {
    align-self: flex-start;
  }
</style>

<div class="grid">
  <article>
    <header>
      <h2>Add Integration</h2>
    </header>
    <form method="post">
      {{ integration_form.hidden_tag() }}
      <label>
        {{ integration_form.tenant_id.label }}
        {{ integration_form.tenant_id() }}
        {% for error in integration_form.tenant_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.name.label }}
        {{ integration_form.name() }}
        {% for error in integration_form.name.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.provider.label }}
        {{ integration_form.provider() }}
        {% for error in integration_form.provider.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.base_url.label }}
        {{ integration_form.base_url(placeholder="Optional override for self-hosted instances") }}
        {% for error in integration_form.base_url.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.api_token.label }}
        {{ integration_form.api_token() }}
        {% for error in integration_form.api_token.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label id="jira-email-field">
        {{ integration_form.jira_email.label }}
        {{ integration_form.jira_email(placeholder=integration_form.jira_email.description) }}
        {% for error in integration_form.jira_email.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label class="checkbox">
        {{ integration_form.enabled() }}
        {{ integration_form.enabled.label }}
      </label>
      <div class="button-row">
        <button type="button" class="secondary" id="test-integration">Test Integration</button>
        <button type="submit" name="{{ integration_form.save.name }}" value="1">{{ integration_form.save.label.text }}</button>
      </div>
      <p id="integration-test-result" class="text-muted" hidden></p>
    </form>
  </article>

  <article>
    <header>
      <h2>Link Project</h2>
    </header>
    <form method="post">
      {{ project_form.hidden_tag() }}
      <label>
        {{ project_form.project_id.label }}
        {{ project_form.project_id() }}
        {% for error in project_form.project_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.integration_id.label }}
        {{ project_form.integration_id() }}
        {% for error in project_form.integration_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.external_identifier.label }}
        {{ project_form.external_identifier(placeholder=project_form.external_identifier.description) }}
        {% for error in project_form.external_identifier.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.jira_jql.label }}
        {{ project_form.jira_jql(rows=3, placeholder=project_form.jira_jql.description) }}
        {% for error in project_form.jira_jql.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <button type="submit" name="{{ project_form.link.name }}" value="1">{{ project_form.link.label.text }}</button>
    </form>
  </article>
</div>

<h2>Configured Integrations</h2>
{% if integrations %}
<table>
  <thead>
    <tr>
      <th>Tenant</th>
      <th>Name</th>
      <th>Provider</th>
      <th>Base URL</th>
      <th>Status</th>
      <th>Linked Projects</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for integration in integrations %}
    <tr>
      <td>{{ integration.tenant.name if integration.tenant else "Unknown" }}</td>
      <td>{{ integration.name }}</td>
      <td>{{ integration.provider|capitalize }}</td>
      <td>{% if integration.base_url %}<code>{{ integration.base_url }}</code>{% else %}<span class="text-muted">Default</span>{% endif %}</td>
      <td>
        {% if integration.enabled %}
          <span class="badge success">Enabled</span>
        {% else %}
          <span class="badge">Disabled</span>
        {% endif %}
      </td>
      <td>
        {% if integration.project_integrations %}
          <ul>
            {% for project_integration in integration.project_integrations %}
              <li>
                {{ project_integration.project.name if project_integration.project else "Unknown project" }}
                <br />
                <small>
                  Identifier: <code>{{ project_integration.external_identifier }}</code>
                  {% if project_integration.issues %}
                    &bull; {{ project_integration.issues|length }} cached issue{{ '' if project_integration.issues|length == 1 else 's' }}
                  {% endif %}
                  {% if project_integration.last_synced_at %}
                    &bull; Synced {{ project_integration.last_synced_at.strftime("%Y-%m-%d %H:%M") }} UTC
                  {% endif %}
                </small>
                <details>
                  <summary>Edit link</summary>
                  {% set update_form = integration_update_forms[project_integration.id] %}
                  {% set delete_form = integration_delete_forms[project_integration.id] %}
                  <form method="post" action="{{ url_for('admin.update_project_integration', project_integration_id=project_integration.id) }}" class="integration-inline-form">
                    {{ update_form.hidden_tag() }}
                    <label>
                      {{ update_form.external_identifier.label }}
                      {{ update_form.external_identifier() }}
                    </label>
                    {% if integration.provider == 'jira' %}
                      <label>
                        {{ update_form.jira_jql.label }}
                        {{ update_form.jira_jql(rows=2) }}
                      </label>
                    {% endif %}
                    <button type="submit" class="secondary">{{ update_form.submit.label.text }}</button>
                  </form>
                  <form method="post" action="{{ url_for('admin.delete_project_integration', project_integration_id=project_integration.id) }}" class="integration-inline-form">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="secondary outline">{{ delete_form.submit.label.text }}</button>
                  </form>
                </details>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted">No linked projects.</span>
        {% endif %}
      </td>
      <td>
        <form method="post" class="inline-form">
          {{ integration_delete_form.csrf_token }}
          {{ integration_delete_form.integration_id(value=integration.id) }}
          <button type="submit" class="link-button danger" onclick="return confirm('Remove integration {{ integration.name }} and all linked issues?')">
            Remove
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>No integrations configured yet.</p>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const testButton = document.getElementById('test-integration');
    if (!testButton) {
      return;
    }
    const form = testButton.closest('form');
    const resultElement = document.getElementById('integration-test-result');
    const provider = form ? form.elements['provider'] : null;
    const tenant = form ? form.elements['tenant_id'] : null;
    const baseUrl = form ? form.elements['base_url'] : null;
    const apiToken = form ? form.elements['api_token'] : null;
    const jiraEmail = form ? form.elements['jira_email'] : null;
    const csrfToken = form ? form.elements['csrf_token'] : null;
    const jiraEmailField = document.getElementById('jira-email-field');

    function toggleJiraField() {
      if (!jiraEmailField) {
        return;
      }
      const needsEmail = provider && provider.value === 'jira';
      jiraEmailField.style.display = needsEmail ? '' : 'none';
    }
    toggleJiraField();
    if (provider) {
      provider.addEventListener('change', toggleJiraField);
    }

    function setResult(message, tone) {
      if (!resultElement) {
        return;
      }
      resultElement.hidden = false;
      resultElement.textContent = message;
      if (tone === 'success') {
        resultElement.style.color = 'var(--pico-color-success)';
      } else if (tone === 'error') {
        resultElement.style.color = 'var(--pico-color-danger)';
      } else {
        resultElement.style.color = 'inherit';
      }
    }

    testButton.addEventListener('click', async () => {
      if (!form) {
        return;
      }
      if (!provider || !tenant || !apiToken || !csrfToken) {
        setResult('Integration form is incomplete.', 'error');
        return;
      }

      const payload = {
        provider: provider.value,
        tenant_id: tenant.value,
        base_url: baseUrl ? baseUrl.value : '',
        api_token: apiToken.value,
        jira_email: jiraEmail ? jiraEmail.value : ''
      };

      setResult('Testing credentials...', 'neutral');
      testButton.disabled = true;
      try {
        const response = await fetch('{{ url_for("admin.test_integration") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
          },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok && data && data.ok) {
          setResult(data.message || 'Integration credentials verified.', 'success');
        } else {
          const message = data && data.message ? data.message : 'Failed to verify integration.';
          setResult(message, 'error');
        }
      } catch (error) {
        setResult('Unable to reach the server to test credentials.', 'error');
      } finally {
        testButton.disabled = false;
      }
    });
  })();
</script>
{% endblock %}
