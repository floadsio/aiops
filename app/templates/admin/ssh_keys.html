{% extends "base.html" %}
{% block title %}SSH Keys | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .ssh-keys-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .ssh-keys-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 2rem;
  }
  .ssh-key-card {
    padding: 1rem 1.25rem;
    border-radius: 0.7rem;
    background: rgba(26, 29, 35, 0.04);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  [data-theme="dark"] .ssh-key-card {
    background: rgba(148, 163, 184, 0.08);
    border-color: rgba(148, 163, 184, 0.3);
  }
  .ssh-key-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }
  .ssh-key-card__title-section {
    flex: 1;
    min-width: 0;
  }
  .ssh-key-card__name {
    font-size: 1.05rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    word-break: break-word;
    color: var(--pico-color-slate-900);
  }
  [data-theme="dark"] .ssh-key-card__name {
    color: rgba(226, 232, 240, 0.95);
  }
  .ssh-key-card__meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    font-size: 0.8rem;
    color: #64748b;
  }
  [data-theme="dark"] .ssh-key-card__meta {
    color: rgba(148, 163, 184, 0.75);
  }
  .ssh-key-card__fingerprint {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
    background: rgba(148, 163, 184, 0.1);
    border-radius: 0.2rem;
    margin: 0.5rem 0;
    word-break: break-all;
  }
  [data-theme="dark"] .ssh-key-card__fingerprint {
    background: rgba(148, 163, 184, 0.2);
  }
  .ssh-key-card__actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
  }
  .ssh-key-card__actions a,
  .ssh-key-card__actions button {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    margin: 0;
    white-space: nowrap;
  }
  .storage-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .storage-badge--database {
    background: rgba(76, 175, 80, 0.15);
    color: #4caf50;
  }
  [data-theme="dark"] .storage-badge--database {
    background: rgba(76, 175, 80, 0.25);
  }
  .storage-badge--filesystem {
    background: rgba(148, 163, 184, 0.15);
    color: #64748b;
  }
  [data-theme="dark"] .storage-badge--filesystem {
    background: rgba(148, 163, 184, 0.25);
  }
  .ssh-keys-filters {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .ssh-keys-filters select,
  .ssh-keys-filters input[type="text"] {
    margin: 0;
    border-radius: 0.5rem;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: rgba(255, 255, 255, 0.92);
    min-width: 180px;
  }
  [data-theme="dark"] .ssh-keys-filters select,
  [data-theme="dark"] .ssh-keys-filters input[type="text"] {
    border-color: rgba(148, 163, 184, 0.5);
    background: rgba(26, 29, 35, 0.65);
    color: rgba(226, 232, 240, 0.9);
  }
  @media (max-width: 768px) {
    .ssh-keys-filters {
      flex-direction: column;
      gap: 0.5rem;
    }
    .ssh-keys-filters select,
    .ssh-keys-filters input {
      width: 100%;
      min-width: 0;
      font-size: 1rem;
    }
  }
  .add-key-section {
    padding: 1.5rem;
    border-radius: 0.7rem;
    background: rgba(26, 29, 35, 0.02);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  [data-theme="dark"] .add-key-section {
    background: rgba(148, 163, 184, 0.05);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .add-key-section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #64748b;
  }
  [data-theme="dark"] .empty-state {
    color: rgba(148, 163, 184, 0.75);
  }
  @media (max-width: 768px) {
    .ssh-key-card__header {
      flex-direction: column;
    }
    .ssh-key-card__actions {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>
{% endblock %}
{% block content %}
<div class="ssh-keys-header">
  <h1>SSH Keys</h1>
</div>

<!-- Filters -->
<form method="get" class="ssh-keys-filters">
  <select name="tenant" onchange="this.form.submit()" aria-label="Filter by tenant">
    {% for option in tenant_options %}
      <option value="{{ option.value }}" {% if option.value == tenant_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <select name="owner" onchange="this.form.submit()" aria-label="Filter by owner">
    {% for option in owner_options %}
      <option value="{{ option.value }}" {% if option.value == owner_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <select name="storage" onchange="this.form.submit()" aria-label="Filter by storage">
    {% for option in storage_options %}
      <option value="{{ option.value }}" {% if option.value == storage_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <input
    type="text"
    name="search"
    value="{{ search_query }}"
    placeholder="Search SSH keys..."
    aria-label="Search"
  />
</form>

<p class="text-muted">
  Showing {{ filtered_count }} of {{ total_count }} SSH key{{ 's' if total_count != 1 else '' }}
  {% if tenant_filter != 'all' %}
    (tenant: {{ tenant_filter_label }})
  {% endif %}
  {% if owner_filter != 'all' %}
    (owner: {{ owner_filter_label }})
  {% endif %}
  {% if storage_filter != 'all' %}
    (storage: {{ storage_filter_label }})
  {% endif %}
  {% if search_query %}
    (search: "{{ search_query }}")
  {% endif %}.
</p>

<!-- SSH Keys List -->
<div class="ssh-keys-list">
  {% for key in ssh_keys %}
    <article class="ssh-key-card">
      <div class="ssh-key-card__header">
        <div class="ssh-key-card__title-section">
          <h3 class="ssh-key-card__name">{{ key.name }}</h3>
          <div class="ssh-key-card__meta">
            {% if key.tenant %}
              <span class="tenant-badge" style="--tenant-color: {{ key.tenant.color or default_tenant_color }}">
                <span class="tenant-badge__swatch" aria-hidden="true"></span>
                {{ key.tenant.name }}
              </span>
            {% else %}
              <span class="text-muted">Unassigned tenant</span>
            {% endif %}
            <span>üìÖ Added {{ key.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
            {% if key.encrypted_private_key %}
              <span class="storage-badge storage-badge--database" title="Encrypted in database">üîí Database</span>
            {% elif key.private_key_path %}
              <span class="storage-badge storage-badge--filesystem" title="Stored on filesystem">üìÅ Filesystem</span>
            {% endif %}
          </div>
          <div class="ssh-key-card__fingerprint">{{ key.fingerprint }}</div>
        </div>
        <div class="ssh-key-card__actions">
          <a href="{{ url_for('admin.edit_ssh_key', key_id=key.id) }}" role="button" class="secondary">Edit</a>
          <form
            method="post"
            action="{{ url_for('admin.delete_ssh_key', key_id=key.id) }}"
            style="display: inline; margin: 0;"
          >
            {{ delete_form.csrf_token }}
            {{ delete_form.key_id(value=key.id) }}
            <button type="submit" class="contrast" onclick="return confirm('Remove SSH key {{ key.name }}?')">
              Remove
            </button>
          </form>
        </div>
      </div>
    </article>
  {% else %}
    <div class="empty-state">
      <p>No SSH keys configured.</p>
    </div>
  {% endfor %}
</div>

<!-- Add SSH Key Form -->
<section class="add-key-section">
  <h2>Add SSH Key</h2>
  <form method="post">
    {{ form.hidden_tag() }}
    <label>
      {{ form.name.label }}
      {{ form.name() }}
      {% for error in form.name.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.public_key.label }}
      {{ form.public_key(rows=4) }}
      {% for error in form.public_key.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.private_key.label }}
      {{ form.private_key(rows=6, placeholder="Paste private key content here (will be encrypted and stored in database)") }}
      {% if form.private_key.description %}
        <small class="text-muted">{{ form.private_key.description }}</small>
      {% else %}
        <small class="text-muted">üîí Private key will be encrypted with Fernet and stored securely in the database. Never stored in plain text on filesystem.</small>
      {% endif %}
      {% for error in form.private_key.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.tenant_id.label }}
      {{ form.tenant_id() }}
      {% for error in form.tenant_id.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <button type="submit">Add Key</button>
  </form>
</section>
{% endblock %}
