{% extends "base.html" %}
{% block title %}Dashboard | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .dashboard-hero {
    margin: 0 0 2rem;
  }
  .dashboard-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .metric-card {
    flex: 1 1 160px;
    padding: 0.85rem 1.1rem;
    border-radius: 0.9rem;
    background: rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(148, 163, 184, 0.25);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
  }
  .metric-card strong {
    display: block;
    margin-top: 0.25rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0;
  }
  .dashboard-section {
    margin-bottom: 1.75rem;
  }
  .dashboard-section > header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 1.25rem;
    gap: 0.75rem;
  }
  .dashboard-section-heading {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .dashboard-section h2 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: #0f172a;
  }
  [data-theme="dark"] .dashboard-section h2 {
    color: #e2e8f0;
  }
  .dashboard-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: 1fr;
  }
  @media (min-width: 1100px) {
    .dashboard-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: stretch;
    }
  }
@media (max-width: 640px) {
  .dashboard-filter-form {
    width: 100%;
  }
  .dashboard-filter-form select {
    width: 100%;
  }
}
.responsive-stack {
  display: contents;
}
.project-card h3 {
  margin: 0 0 0.5rem;
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.55rem;
  flex-wrap: wrap;
}
  .project-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    align-items: stretch;
  }
  .project-actions form {
    margin: 0;
    display: flex;
    gap: 0.35rem;
    align-items: center;
    flex: 1 1 280px;
  }
  .project-actions select,
  .project-actions input {
    flex: 1 1 auto;
    min-width: 140px;
  }
  .project-actions button {
    flex: 1 1 auto;
    min-width: 120px;
  }
  @media (max-width: 900px) {
    .project-actions form {
      flex-direction: column;
    }
    .project-actions button,
    .project-actions select,
    .project-actions input {
      width: 100%;
    }
  }
.project-branch-tools {
  margin-top: 0.65rem;
  border: 1px dashed rgba(15, 23, 42, 0.15);
  border-radius: 0.9rem;
  padding: 0.75rem;
}
.project-branch-form {
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
}
.project-branch-row {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}
.project-branch-field {
  display: flex;
  gap: 0.45rem;
  align-items: center;
}
.project-branch-field input[type="text"],
.project-branch-field select {
  min-width: 0;
  flex: 1 1 auto;
}
.project-branch-field button {
  flex: 0 0 auto;
  padding: 0.3rem 0.65rem;
  font-size: 0.85rem;
}
.dashboard-filter-form {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  font-size: 0.85rem;
}
.dashboard-filter-form label {
  font-weight: 600;
  color: #475569;
}
.dashboard-filter-form select {
  min-width: 220px;
}
.tenant-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
@media (max-width: 768px) {
  .dashboard-card {
    padding: 1.05rem;
  }
  .project-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .project-actions form {
    width: 100%;
    flex-direction: column;
    gap: 0.35rem;
  }
  .project-actions select,
  .project-actions button {
    width: 100%;
  }
  .project-branch-field {
    flex-direction: column;
    align-items: stretch;
    gap: 0.3rem;
  }
  .project-branch-field input,
  .project-branch-field select,
  .project-branch-field button {
    width: 100%;
  }
  .tenant-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 0.4rem;
  }
  .tenant-actions a {
    width: 100%;
    justify-content: center;
  }
}
  .dashboard-card {
    padding: 1.75rem;
    border-radius: 1.25rem;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 16px 45px rgba(15, 23, 42, 0.08);
    backdrop-filter: blur(6px);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  [data-theme="dark"] .dashboard-card {
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 18px 40px rgba(2, 6, 23, 0.6);
  }
  .dashboard-card:hover {
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
  }
  .tenant-card h3 {
    margin: 0 0 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #0f172a;
  }
  [data-theme="dark"] .tenant-card h3 {
    color: #f1f5f9;
  }
  .tenant-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    font-size: 0.9rem;
    color: #475569;
  }
  [data-theme="dark"] .tenant-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .tenant-description {
    margin: 0 0 1.25rem;
    color: #334155;
    font-size: 0.95rem;
  }
  [data-theme="dark"] .tenant-description {
    color: rgba(226, 232, 240, 0.85);
  }
.tenant-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
  .project-card h3 {
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.55rem;
    flex-wrap: wrap;
  }
.project-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.75rem 0 0;
  align-items: center;
}
.project-actions form {
  margin: 0;
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex: 1 1 10rem;
}
  .project-actions input[type="text"],
  .project-actions input[type="search"] {
    width: 9rem;
  }
  .project-actions button {
    min-width: 0;
    justify-content: center;
  }
  .project-branch-tools {
    margin-top: 0.65rem;
    border: 1px dashed rgba(15, 23, 42, 0.15);
    border-radius: 0.9rem;
    padding: 0.75rem;
  }
  [data-theme="dark"] .project-branch-tools {
    border-color: rgba(148, 163, 184, 0.3);
  }
  .project-branch-form {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
  }
  .project-branch-row {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
.project-branch-field {
  display: flex;
  gap: 0.45rem;
  align-items: center;
}
  .project-branch-field input[type="text"],
  .project-branch-field select {
    min-width: 0;
    flex: 1 1 auto;
  }
  .project-branch-field button {
    flex: 0 0 auto;
    padding: 0.3rem 0.65rem;
    font-size: 0.85rem;
  }
.dashboard-filter-form {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  font-size: 0.85rem;
}
  .dashboard-filter-form label {
    font-weight: 600;
    color: #475569;
  }
  [data-theme="dark"] .dashboard-filter-form label {
    color: rgba(226, 232, 240, 0.85);
  }
  .dashboard-filter-form select {
    min-width: 220px;
  }
  .issue-overview {
    margin-top: 1.1rem;
    padding: 1rem 1.2rem;
    border-radius: 1rem;
    background: rgba(15, 23, 42, 0.05);
    border: 1px solid rgba(148, 163, 184, 0.3);
  }
  [data-theme="dark"] .issue-overview {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.35);
  }
  .issue-overview header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .issue-overview h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
  }
  .issue-total {
    font-size: 0.85rem;
    color: #475569;
  }
  [data-theme="dark"] .issue-total {
    color: rgba(226, 232, 240, 0.7);
  }
  .issue-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0 0 0.75rem;
  }
  .issue-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.65rem;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.12);
    color: #1d4ed8;
    font-size: 0.8rem;
    font-weight: 600;
  }
  [data-theme="dark"] .issue-chip {
    background: rgba(96, 165, 250, 0.25);
    color: #bfdbfe;
  }
  .issue-sources {
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
  }
  .issue-source {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .issue-source-heading {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: baseline;
    font-size: 0.9rem;
  }
  .issue-provider {
    font-weight: 600;
  }
  .issue-target {
    font-weight: 500;
    letter-spacing: 0.01em;
  }
  .issue-status-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.55rem;
  }
  .text-muted {
    color: #64748b;
    font-size: 0.85rem;
  }
  [data-theme="dark"] .text-muted {
    color: rgba(203, 213, 225, 0.7);
  }
  .warning-note {
    color: #b45309;
    font-size: 0.85rem;
    font-weight: 600;
  }
  [data-theme="dark"] .warning-note {
    color: #facc15;
  }
  .tenant-badge.tenant-badge--tiny {
    font-size: 0.7rem;
    padding: 0.1rem 0.4rem;
    gap: 0.25rem;
  }
  .tenant-badge.tenant-badge--tiny .tenant-badge__swatch {
    width: 0.55rem;
    height: 0.55rem;
  }
  .tmux-session-panel {
    margin-top: 1.1rem;
    padding: 1rem 1.2rem;
    border-radius: 1rem;
    background: rgba(148, 163, 184, 0.18);
    border: 1px solid rgba(148, 163, 184, 0.45);
    box-sizing: border-box;
  }
  [data-theme="dark"] .tmux-session-panel {
    background: rgba(30, 41, 59, 0.65);
    border-color: rgba(148, 163, 184, 0.4);
  }
  .tmux-session-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.85rem;
  }
  .tmux-session-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e293b;
  }
  [data-theme="dark"] .tmux-session-header h4 {
    color: rgba(226, 232, 240, 0.9);
  }
  .tmux-session-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.16);
    color: #1d4ed8;
  }
  [data-theme="dark"] .tmux-session-count {
    background: rgba(96, 165, 250, 0.25);
    color: #bfdbfe;
  }
  .dashboard-filter-note {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin: 0 0 1rem;
    font-size: 0.9rem;
  }
  .dashboard-filter-note .inline-link {
    font-weight: 600;
  }
  .tmux-session-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .tmux-session-row {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 0.75rem;
    padding: 0.75rem 0.9rem;
    border-radius: 0.75rem;
    background: rgba(148, 163, 184, 0.12);
    width: 100%;
    word-break: break-word;
    box-sizing: border-box;
  }
  [data-theme="dark"] .tmux-session-row {
    background: rgba(148, 163, 184, 0.16);
  }
  .tmux-session-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
  }
  .tmux-recent-card {
    min-width: 0;
    width: 100%;
  }
  .tmux-recent-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
    min-width: 0;
    box-sizing: border-box;
  }
  .tmux-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.15);
    color: #1d4ed8;
    min-width: 0;
  }
  .tmux-meta {
    flex: 0 1 auto;
    min-width: 0;
    overflow-wrap: anywhere;
  }
  [data-theme="dark"] .tmux-chip {
    background: rgba(96, 165, 250, 0.2);
    color: #bfdbfe;
  }
  .tmux-chip--tool {
    background: rgba(16, 185, 129, 0.15);
    color: #047857;
  }
  [data-theme="dark"] .tmux-chip--tool {
    background: rgba(16, 185, 129, 0.3);
    color: #bbf7d0;
  }
  .tmux-session-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    width: 100%;
    box-sizing: border-box;
  }
  .tmux-session-actions a,
  .tmux-session-actions form {
    flex: 1 1 auto;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
  }
  .tmux-session-actions form {
    margin: 0;
    display: flex;
  }
  .tmux-session-actions button,
  .tmux-session-actions a[role="button"] {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    justify-content: center;
  }
  @media (min-width: 768px) {
    .tmux-session-row {
      grid-template-columns: minmax(0, 2.75fr) minmax(0, 1.25fr);
      align-items: center;
    }
    .tmux-session-actions {
      justify-content: flex-end;
      flex-wrap: nowrap;
      width: 100%;
    }
    .tmux-session-actions a,
    .tmux-session-actions form {
      flex: 0 1 auto;
      width: auto;
      max-width: none;
    }
    .tmux-session-actions button,
    .tmux-session-actions a[role="button"] {
      width: auto;
      max-width: none;
      min-width: 7rem;
    }
  }
  @media (max-width: 640px) {
    .tmux-session-actions {
      flex-direction: column;
      align-items: stretch;
      width: 100%;
    }
    .tmux-session-actions a,
    .tmux-session-actions form {
      flex: none;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .tmux-session-actions button,
    .tmux-session-actions a[role="button"] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
  }
  .tmux-recent-grid {
    display: grid;
    gap: 0.85rem;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    box-sizing: border-box;
  }
  .tmux-section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .tmux-scope-controls {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .tmux-scope-pill {
    background: rgba(148, 163, 184, 0.2);
    border-radius: 999px;
    padding: 0.2rem 0.8rem;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  [data-theme="dark"] .tmux-scope-pill {
    background: rgba(148, 163, 184, 0.35);
    color: rgba(15, 23, 42, 0.9);
  }
  .tmux-recent-card {
    padding: 0.85rem 1rem;
    border-radius: 0.85rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(241, 245, 249, 0.5);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    flex-wrap: wrap;
    min-height: 200px;
    box-sizing: border-box;
    overflow: hidden;
  }
  [data-theme="dark"] .tmux-recent-card {
    border-color: rgba(148, 163, 184, 0.25);
    background: rgba(30, 41, 59, 0.55);
  }
  .tmux-recent-meta {
    flex: 1 1 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
    font-size: 0.9rem;
    color: #475569;
    box-sizing: border-box;
  }
  [data-theme="dark"] .tmux-recent-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .tmux-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  .tmux-recent-actions {
    display: flex;
    width: 100%;
    gap: 0.5rem;
    box-sizing: border-box;
    flex: 1 1 100%;
  }
  .tmux-recent-actions .tmux-action {
    flex: 1 1 auto;
    display: flex;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
  }
  .tmux-recent-actions form {
    margin: 0;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .tmux-recent-actions .tmux-action-btn {
    width: 100%;
    max-width: 100%;
    justify-content: center;
    align-items: center;
    display: inline-flex;
    padding: 0.4rem 0.65rem;
    min-height: 2.5rem;
    box-sizing: border-box;
  }
  @media (max-width: 640px) {
    .tmux-recent-card {
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }
    .tmux-recent-actions {
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      flex: 1 1 100%;
    }
    .tmux-recent-actions .tmux-action {
      flex: none;
      width: 100%;
      max-width: 100%;
    }
    .tmux-recent-actions .tmux-action,
    .tmux-recent-actions form,
    .tmux-recent-actions .tmux-action-btn {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
  }
  .update-form {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .update-form .checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .update-form .form-helper {
    font-size: 0.85rem;
  }
  .update-log {
    display: block;
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: rgba(241, 245, 249, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    max-height: 18rem;
    overflow: auto;
  }
  [data-theme="dark"] .update-log {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .empty-state {
    padding: 1.5rem;
    border-radius: 1.25rem;
    border: 1px dashed rgba(71, 85, 105, 0.35);
    text-align: center;
    color: #475569;
  }
  [data-theme="dark"] .empty-state {
    color: rgba(226, 232, 240, 0.65);
    border-color: rgba(148, 163, 184, 0.35);
  }
</style>
{% endblock %}
{% block content %}
<section class="dashboard-search" aria-label="Dashboard search">
  <form method="get" action="{{ url_for('admin.dashboard') }}" style="margin: 0;">
    <input
      type="search"
      id="dashboard-search-input"
      name="q"
      value="{{ dashboard_query }}"
      placeholder="Search tenants or projects‚Ä¶"
      autocomplete="off"
    >
    {% if request.args.get('tmux_scope') %}
      <input type="hidden" name="tmux_scope" value="{{ request.args.get('tmux_scope') }}">
    {% endif %}
  </form>
</section>

{% if pinned_issues %}
<style>
  /* Pinned issues styling with dark mode support */
  .pinned-issues-subtitle {
    margin: 0;
    font-size: 0.9rem;
    color: #64748b;
  }
  [data-theme="dark"] .pinned-issues-subtitle {
    color: #94a3b8;
  }
  .issue-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.25rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    background: #ffffff;
    transition: all 0.2s ease;
  }
  .issue-row:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }
  [data-theme="dark"] .issue-row {
    background: #1e293b;
    border-color: #334155;
  }
  [data-theme="dark"] .issue-row:hover {
    border-color: #475569;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
  }
  .issue-row-content {
    flex: 1;
    min-width: 0;
  }
  .issue-row-header {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  .issue-project-link {
    font-weight: 600;
    color: #0f172a;
    text-decoration: none;
  }
  .issue-project-link:hover {
    text-decoration: underline;
  }
  [data-theme="dark"] .issue-project-link {
    color: #e2e8f0;
  }
  .issue-row-header .separator {
    color: #cbd5e1;
    margin: 0 0.4rem;
  }
  [data-theme="dark"] .issue-row-header .separator {
    color: #475569;
  }
  .issue-id {
    color: #64748b;
    font-size: 0.9rem;
  }
  [data-theme="dark"] .issue-id {
    color: #94a3b8;
  }
  .issue-title {
    margin: 0.25rem 0 0.5rem;
    font-size: 1rem;
    font-weight: 500;
  }
  .issue-title-link {
    color: #0f172a;
    text-decoration: none;
  }
  .issue-title-link:hover {
    color: #0969da;
  }
  [data-theme="dark"] .issue-title-link {
    color: #e2e8f0;
  }
  [data-theme="dark"] .issue-title-link:hover {
    color: #58a6ff;
  }
  .issue-row-meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    font-size: 0.85rem;
    color: #64748b;
  }
  [data-theme="dark"] .issue-row-meta {
    color: #94a3b8;
  }
  .issue-status-badge {
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    background: #f1f5f9;
    color: #475569;
    font-weight: 500;
  }
  [data-theme="dark"] .issue-status-badge {
    background: #334155;
    color: #cbd5e1;
  }
  .issue-label-badge {
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    background: #ede9fe;
    color: #7c3aed;
    font-size: 0.75rem;
    font-weight: 500;
  }
  [data-theme="dark"] .issue-label-badge {
    background: #4c1d95;
    color: #ddd6fe;
  }
  .issue-label-more {
    color: #94a3b8;
  }
  [data-theme="dark"] .issue-label-more {
    color: #64748b;
  }
  .issue-row-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: flex-start;
    margin-left: 1rem;
  }
  .issue-row-actions button,
  .issue-row-actions a {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    white-space: nowrap;
    min-height: 44px;
    min-width: 44px;
  }

  /* Text overflow handling */
  .issue-title-link {
    overflow-wrap: break-word;
    word-break: break-word;
  }

  /* Mobile responsive layout */
  @media (max-width: 768px) {
    .issue-row {
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }

    .issue-row-actions {
      width: 100%;
      margin-left: 0;
      flex-direction: column;
      gap: 0.75rem;
    }

    .issue-row-actions button,
    .issue-row-actions a {
      width: 100%;
      justify-content: center;
      min-height: 44px;
      font-size: 1rem;
      padding: 0.6rem 1rem;
    }

    .issue-row-actions form {
      width: 100%;
      display: flex;
    }

    .issue-row-actions form button {
      width: 100%;
    }

    .issue-row-meta {
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .pinned-issues-subtitle {
      font-size: 0.85rem;
    }
  }
</style>
<section class="dashboard-section">
  <header>
    <div class="dashboard-section-heading">
      <h2>
        Pinned Issues
        <span class="metric-card" style="text-transform:none;font-size:0.85rem;margin-left:0.5rem;padding:0.2rem 0.7rem;display:inline-flex;align-items:center;gap:0.4rem;">
          <strong style="margin:0;font-size:1rem;">{{ pinned_issues|length }}</strong>
        </span>
      </h2>
      <p class="pinned-issues-subtitle">Issues you've pinned for quick access</p>
    </div>
  </header>
  <div class="issue-list" style="margin-top:0;">
    {% for pinned in pinned_issues %}
      {% set issue = pinned.issue %}
      {% set integration = issue.project_integration %}
      {% set project = integration.project if integration else none %}
      <article class="issue-row">
        <div class="issue-row-content">
          <div class="issue-row-header">
            {% if project %}
              <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="issue-project-link">
                {{ project.name }}
              </a>
              <span class="separator">¬∑</span>
            {% endif %}
            <span class="issue-id">#{{ issue.external_id }}</span>
          </div>
          <h3 class="issue-title">
            <a href="{{ url_for('admin.manage_issues') }}?issue_id={{ issue.id }}" class="issue-title-link">
              {{ issue.title }}
            </a>
          </h3>
          <div class="issue-row-meta">
            {% if issue.status %}
              <span class="issue-status-badge">
                {{ issue.status }}
              </span>
            {% endif %}
            {% if issue.assignee %}
              <span>Assigned to {{ issue.assignee }}</span>
            {% endif %}
            {% if issue.labels %}
              <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                {% for label in issue.labels[:3] %}
                  <span class="issue-label-badge">
                    {{ label }}
                  </span>
                {% endfor %}
                {% if issue.labels|length > 3 %}
                  <span class="issue-label-more">+{{ issue.labels|length - 3 }} more</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
        <div class="issue-row-actions">
          {% if project %}
            <a href="{{ url_for('projects.project_ai_console', project_id=project.id) }}?tool=claude&issue_id={{ issue.id }}" class="secondary">
              ü§ñ Claude
            </a>
            <a href="{{ url_for('projects.project_ai_console', project_id=project.id) }}?tool=codex&issue_id={{ issue.id }}" class="secondary">
              üíª Codex
            </a>
            <a href="{{ url_for('projects.project_ai_console', project_id=project.id) }}?tool=gemini&issue_id={{ issue.id }}" class="secondary">
              ‚ú® Gemini
            </a>
            <button
              type="button"
              class="secondary outline close-pinned-issue-btn"
              data-project-id="{{ project.id }}"
              data-issue-id="{{ issue.id }}"
              data-issue-title="{{ issue.title }}"
              data-external-id="{{ issue.external_id }}"
            >
              ‚úï Close Issue
            </button>
            <form method="post" action="{{ url_for('projects.unpin_issue', project_id=project.id, issue_id=issue.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="secondary outline">
                Unpin
              </button>
            </form>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>
</section>
{% endif %}

<section class="dashboard-section">
  <header class="tmux-section-header">
    <div>
      <h2>
        tmux Sessions
        <span class="metric-card" style="text-transform:none;font-size:0.85rem;margin-left:0.5rem;padding:0.2rem 0.7rem;display:inline-flex;align-items:center;gap:0.4rem;">
          <strong style="margin:0;font-size:1rem;">{{ recent_tmux_windows|length }}</strong>
        </span>
      </h2>
    </div>
    <div class="tmux-scope-controls">
      <span class="tmux-scope-pill">Scope: {{ tmux_scope_label }}</span>
      <a class="tertiary" href="{{ tmux_scope_toggle_url }}">{{ tmux_scope_toggle_label }}</a>
    </div>
  </header>
  {% if recent_tmux_error %}
    <p class="warning-note">tmux unavailable: {{ recent_tmux_error }}</p>
  {% elif recent_tmux_windows %}
            <div class="tmux-recent-grid">
      {% for window in recent_tmux_windows %}
        <article class="tmux-recent-card">
          <div class="tmux-recent-meta">
            {% if window.project %}
              <a
                class="tenant-badge tenant-badge--tiny"
                style="--tenant-color: {{ window.project.tenant_color or default_tenant_color }}"
                href="{{ url_for('admin.dashboard', q=window.project.tenant_name) }}"
                title="Filter for {{ window.project.tenant_name }}"
              >
                <span class="tenant-badge__swatch" aria-hidden="true"></span>
                {{ window.project.tenant_name }}
              </a>
            {% endif %}
            <span class="tmux-meta">
              <strong>Session:</strong> {{ window.session }}
            </span>
            {% if window.project and window.project.workspace_path %}
              <span class="tmux-meta">
                <strong>Path:</strong> {{ window.project.workspace_path }}
              </span>
            {% endif %}
            <span class="tmux-chip">{{ window.window }}</span>
            {% if window.tool %}
              <span class="tmux-chip tmux-chip--tool">{{ window.tool }}</span>
            {% endif %}
            {% if window.ssh_keys %}
              <span class="tmux-meta">
                <strong>SSH:</strong>
                {% for key in window.ssh_keys %}
                  {{ key.label }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </span>
            {% else %}
              <span class="tmux-meta text-muted">
                SSH: user-provided keys
              </span>
            {% endif %}
            <span class="tmux-meta">
              {{ window.panes }} pane{{ '' if window.panes == 1 else 's' }}
              {% if window.created_display %}
                ‚Ä¢ {{ window.created_display }}
              {% endif %}
            </span>
          </div>
          <div class="tmux-recent-actions">
            {% if window.project %}
              <div class="tmux-action">
                <a
                  role="button"
                  class="secondary outline tmux-action-btn"
                  href="{{ url_for('projects.project_ai_console', project_id=window.project.project_id, attach=window.target) }}"
                >
                  üîó Reattach
                </a>
              </div>
              <div class="tmux-action">
                <button
                  type="button"
                  class="secondary outline tmux-action-btn close-tmux-window"
                  data-project-id="{{ window.project.project_id }}"
                  data-tmux-target="{{ window.target }}"
                  data-window-name="{{ window.window }}"
                >‚úï Close</button>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No tmux windows detected for this scope.</p>
  {% endif %}
</section>

<section class="dashboard-section">
  <header>
    <div class="dashboard-section-heading">
      <h2>Recent Projects</h2>
      <small><a href="{{ url_for('admin.manage_projects') }}">All projects ‚Üí</a></small>
      {% if dashboard_query %}
        <small class="text-muted">Filtering ‚Äú{{ dashboard_query }}‚Äù</small>
      {% endif %}
    </div>
  </header>
  {% if tenant_filter_active %}
    <div class="dashboard-filter-note">
      <small class="text-muted">
        Filtered by {{ tenant_filter_label or 'Selected tenant' }}
      </small>
      <a class="inline-link" href="{{ url_for('admin.dashboard') }}">Clear filter</a>
    </div>
  {% endif %}
  {% if project_cards %}
    <div class="dashboard-grid">
      {% for card in project_cards %}
        {% set project = card.project %}
        {% set status = card.status %}
        {% set tenant_color = project.tenant.color or default_tenant_color %}
        <article
          class="dashboard-card project-card tenant-accent"
          style="
            --tenant-color: {{ tenant_color }};
            --tenant-color-bg: {{ tenant_color }}1a;
            --tenant-color-bg-dark: {{ tenant_color }}30;
          "
        >
          <h3>
            <a
              class="tenant-badge"
              style="--tenant-color: {{ project.tenant.color or default_tenant_color }}"
              href="{{ url_for('admin.dashboard', q=project.tenant.name) }}"
              title="Filter dashboard by {{ project.tenant.name }}"
            >
              <span class="tenant-badge__swatch" aria-hidden="true"></span>
              {{ project.tenant.name }}
            </a>
            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}">
              {{ project.name }}
            </a>
          </h3>
          {% set issue_form = card.issue_sync_form %}
          {% set git_form = card.git_refresh_form %}
          {% set branch_name = status.get("branch") or project.default_branch %}
          {% if status.get("last_commit_display") and status.get("last_commit_author") %}
            <p>
              Last modified by {{ status.get("last_commit_author") }}
              on {{ status.get("last_commit_display") }} (branch {{ branch_name }})
            </p>
            {% if status.get("last_commit_hash") or status.get("last_commit_subject") %}
              <p class="text-muted">
                Commit
                {% if status.get("last_commit_hash") %}
                  <code>{{ status.get("last_commit_hash") }}</code>
                {% endif %}
                {% if status.get("last_commit_subject") %}
                  &mdash; {{ status.get("last_commit_subject") }}
                {% endif %}
              </p>
            {% endif %}
          {% elif status.get("last_commit_display") %}
            <p>Last modified on {{ status.get("last_commit_display") }} (branch {{ branch_name }})</p>
          {% elif status.get("last_pull_display") %}
            <p>Last pull on {{ status.get("last_pull_display") }} (branch {{ branch_name }})</p>
          {% else %}
            <p class="text-muted">No pull recorded yet (branch {{ branch_name }}).</p>
          {% endif %}
          {% if status.get("workspace_path") %}
            <p class="text-muted" style="font-size: 0.85em;">
              <code>{{ status.get("workspace_path") }}</code>
            </p>
          {% endif %}
          {% if status.get("dirty") %}
            <p class="critical-note">Uncommitted changes detected</p>
          {% endif %}
          {% if status.get("error") %}
            <p class="warning-note">Status unavailable: {{ status.get("error") }}</p>
          {% endif %}
          {% if card.issue_integrations %}
            <div class="issue-overview">
              <header>
                <h4>Issues</h4>
                {% if card.issue_summary.total %}
                  <span class="issue-total">{{ card.issue_summary.total }} total</span>
                {% else %}
                  <span class="issue-total text-muted">No issues cached yet</span>
                {% endif %}
              </header>
              <div class="issue-sources">
                {% for integration in card.issue_integrations %}
                  <div class="issue-source">
                    <div class="issue-source-heading">
                      <span class="issue-provider">{{ integration.provider_display }}</span>
                      {% if integration.project_identifier %}
                        <span class="issue-target">{{ integration.project_identifier }}</span>
                      {% endif %}
                      {% if integration.integration_name %}
                        <span class="text-muted">{{ integration.integration_name }}</span>
                      {% endif %}
                      {% if integration.source_label %}
                        <span class="text-muted">{{ integration.source_label }}</span>
                      {% endif %}
                      {% if not integration.enabled %}
                        <span class="badge">Disabled</span>
                      {% endif %}
                    </div>
                    {% if integration.status_entries %}
                      <div class="issue-status-list">
                        {% for entry in integration.status_entries %}
                          <a
                            class="issue-chip"
                            href="{{ url_for(
                              'projects.project_detail',
                              project_id=project.id,
                              issue_status=entry.key
                            ) }}"
                          >
                            {{ entry.label }}: {{ entry.count }}
                          </a>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="text-muted">No issues cached yet.</p>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {% if card.tmux_error %}
            <p class="warning-note">tmux: {{ card.tmux_error }}</p>
          {% elif card.tmux_windows %}
            <div class="tmux-session-panel">
              <header class="tmux-session-header">
                <h4>Running tmux windows</h4>
                <span class="tmux-session-count">{{ card.tmux_windows|length }}</span>
              </header>
              <div class="tmux-session-list">
                {% for session in card.tmux_windows %}
                  <div class="tmux-session-row">
                    <div class="tmux-session-meta">
                      {% if project.tenant %}
                        <a
                          class="tenant-badge tenant-badge--tiny"
                          style="--tenant-color: {{ project.tenant.color or default_tenant_color }}"
                          href="{{ url_for('admin.dashboard', q=project.tenant.name) }}"
                          title="Filter for {{ project.tenant.name }}"
                        >
                          <span class="tenant-badge__swatch" aria-hidden="true"></span>
                          {{ project.tenant.name }}
                        </a>
                      {% endif %}
                      <span class="tmux-meta">
                        <strong>Session:</strong> {{ session.session }}
                      </span>
                      <span class="tmux-chip">{{ session.window }}</span>
                      {% if session.tool %}
                        <span class="tmux-chip tmux-chip--tool">{{ session.tool }}</span>
                      {% endif %}
                      {% if session.ssh_keys %}
                        <span class="tmux-meta">
                          <strong>SSH:</strong>
                          {% for key in session.ssh_keys %}
                            {{ key.label }}{% if not loop.last %}, {% endif %}
                          {% endfor %}
                        </span>
                      {% else %}
                        <span class="tmux-meta text-muted">
                          SSH: user-provided keys
                        </span>
                      {% endif %}
                      <span class="tmux-meta">
                        {{ session.panes }} pane{{ '' if session.panes == 1 else 's' }}
                        {% if session.created_display %}
                          ‚Ä¢ {{ session.created_display }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="tmux-session-actions">
                      <a
                        role="button"
                        class="secondary outline tmux-action-btn"
                        href="{{ url_for(
                          'projects.project_ai_console',
                          project_id=project.id,
                          attach=session.target
                        ) }}"
                      >
                        Reattach
                      </a>
                      <button
                        type="button"
                        class="secondary outline tmux-action-btn close-tmux-window"
                        data-project-id="{{ project.id }}"
                        data-tmux-target="{{ session.target }}"
                        data-window-name="{{ session.window }}"
                      >‚úï Close</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {% set branch_form = card.branch_form %}
          <div class="project-branch-tools">
            <form method="post" action="{{ url_for('admin.manage_project_branch', project_id=project.id) }}" class="project-branch-form">
              {{ branch_form.hidden_tag() }}
              {{ branch_form.project_id() }}
              <div class="project-branch-row">
                <div class="project-branch-field">
                  {{ branch_form.branch_name(placeholder="feature/my-work") }}
                </div>
                <div class="project-branch-field">
                  <select name="{{ branch_form.base_branch.name }}" aria-label="Base branch">
                    {% for branch in card.branch_choices %}
                      <option value="{{ branch }}" {% if (branch_form.base_branch.data or '') == branch %}selected{% endif %}>
                        {{ branch }}
                      </option>
                    {% endfor %}
                  </select>
                  {{ branch_form.checkout_submit(class="secondary outline") }}
                </div>
              </div>
              <div class="project-branch-row">
                <div class="project-branch-field">
                  <select name="{{ branch_form.merge_source.name }}" aria-label="Source branch">
                    {% for branch in card.branch_choices %}
                      <option value="{{ branch }}" {% if (branch_form.merge_source.data or '') == branch %}selected{% endif %}>
                        {{ branch }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="project-branch-field">
                  <select name="{{ branch_form.merge_target.name }}" aria-label="Target branch">
                    {% for branch in card.branch_choices %}
                      <option value="{{ branch }}" {% if (branch_form.merge_target.data or '') == branch %}selected{% endif %}>
                        {{ branch }}
                      </option>
                    {% endfor %}
                  </select>
                  {{ branch_form.merge_submit(class="secondary outline") }}
                </div>
              </div>
              <div class="project-branch-row">
                <div class="project-branch-field">
                  <select name="{{ branch_form.delete_branch.name }}" aria-label="Delete branch">
                    <option value="">Select branch to delete</option>
                    {% for branch in card.branch_choices %}
                      {% if branch != project.default_branch %}
                        <option value="{{ branch }}" {% if (branch_form.delete_branch.data or '') == branch %}selected{% endif %}>
                          {{ branch }}
                        </option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <div class="project-branch-field">
                  {{ branch_form.delete_submit(
                    class="critical outline",
                    onclick="return confirm('Delete this branch locally?')"
                  ) }}
                </div>
              </div>
            </form>
          </div>
          <div class="project-actions">
            <form method="post" action="{{ url_for('admin.refresh_project_issues', project_id=project.id) }}">
              {{ issue_form.hidden_tag() }}
              {{ issue_form.project_id() }}
              <button type="submit" class="secondary">Refresh Issues</button>
            </form>
            <form method="post" action="{{ url_for('admin.refresh_project_git', project_id=project.id) }}">
              {{ git_form.hidden_tag() }}
              {{ git_form.project_id() }}
              <select name="{{ git_form.branch.name }}" aria-label="Branch">
                <option value="">Default ({{ project.default_branch }})</option>
                {% for branch in card.branch_choices %}
                  <option value="{{ branch }}" {% if (git_form.branch.data or '') == branch %}selected{% endif %}>
                    {{ branch }}
                  </option>
                {% endfor %}
              </select>
              {{ git_form.submit(class="secondary outline") }}
              {{ git_form.clean_submit(class="critical outline", title="Discard local changes before pulling.") }}
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      {% if tenant_filter_active %}
        <p>No projects match the selected tenant.</p>
        <a role="button" href="{{ url_for('admin.dashboard') }}">Clear filter</a>
      {% elif dashboard_query %}
        <p>No projects match ‚Äú{{ dashboard_query }}‚Äù.</p>
        <a role="button" href="{{ url_for('admin.dashboard') }}">Clear filter</a>
      {% else %}
        <p>No projects configured. Connect a repository to see automation insights here.</p>
        <a role="button" href="{{ url_for('admin.manage_projects') }}">Add project</a>
      {% endif %}
    </div>
  {% endif %}
</section>

<section class="dashboard-section">
  <header class="tmux-section-header">
    <div class="dashboard-section-heading">
      <h2>AI Session History</h2>
      <small>Resume past Claude, Codex, and Gemini sessions</small>
    </div>
    <div class="tmux-scope-controls">
      <label>
        <select id="ai-session-filter" aria-label="Filter by tool">
          <option value="">All tools</option>
          <option value="claude">ü§ñ Claude</option>
          <option value="codex">üíª Codex</option>
          <option value="gemini">‚ú® Gemini</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="ai-session-active-only" role="switch" />
        Active only
      </label>
    </div>
  </header>
  <div id="ai-sessions-container">
    <p style="text-align: center; color: #64748b;">Loading sessions...</p>
  </div>
</section>

<section class="dashboard-section">
  <header>
    <h2>Tenants</h2>
    <small><a href="{{ url_for('admin.manage_tenants') }}">Manage tenants ‚Üí</a></small>
  </header>
  {% if tenants %}
    <div class="dashboard-grid">
      {% for tenant in tenants %}
        {% set tenant_color = tenant.color or default_tenant_color %}
        <article
          class="dashboard-card tenant-card tenant-accent"
          style="
            --tenant-color: {{ tenant_color }};
            --tenant-color-bg: {{ tenant_color }}12;
            --tenant-color-bg-dark: {{ tenant_color }}28;
          "
        >
          <div class="tenant-meta">
            <span>
              {{ tenant.projects|length }} project{{ '' if tenant.projects|length == 1 else 's' }}
            </span>
          </div>
          <h3>
            <span class="tenant-badge" style="--tenant-color: {{ tenant.color or default_tenant_color }}">
              <span class="tenant-badge__swatch" aria-hidden="true"></span>
              {{ tenant.name }}
            </span>
          </h3>
          <p class="tenant-description">
            {{
              tenant.description or
              "No description yet ‚Äî keep your operators informed with a quick summary."
            }}
          </p>
          <div class="tenant-actions">
            <a
              role="button"
              class="secondary outline"
              href="{{ url_for('admin.manage_projects') }}?tenant={{ tenant.id }}"
            >
              View projects
            </a>
            <a
              role="button"
              class="secondary"
              href="{{ url_for('admin.manage_tenants') }}#tenant-{{ tenant.id }}"
            >
              Edit tenant
            </a>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <p>No tenants yet. Kickstart automation by creating your first tenant.</p>
      <a role="button" href="{{ url_for('admin.manage_tenants') }}">Create tenant</a>
    </div>
  {% endif %}
</section>
{% block extra_body %}
<script>
  (function () {
    const closeButtons = document.querySelectorAll('.close-tmux-window');
    if (!closeButtons.length) {
      return;
    }

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

    closeButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const projectId = button.dataset.projectId;
        const tmuxTarget = button.dataset.tmuxTarget;
        const windowName = button.dataset.windowName;

        if (!projectId || !tmuxTarget) {
          return;
        }

        if (!confirm(`Are you sure you want to close tmux window ${windowName || tmuxTarget}?`)) {
          return;
        }

        const url = `/projects/${projectId}/tmux/close`;
        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Closing...';

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({
            tmux_target: tmuxTarget,
            next: window.location.pathname + window.location.search,
          }),
        })
        .then(response => {
          if (response.ok) {
            // Try to find the card to remove it
            const recentCard = button.closest('.tmux-recent-card');
            if (recentCard) {
              recentCard.remove();
            } else {
              const sessionRow = button.closest('.tmux-session-row');
              if (sessionRow) {
                sessionRow.remove();
              } else {
                // If we can't find the card, just reload
                window.location.reload();
              }
            }
          } else {
            return response.json().then(data => {
              throw new Error(data.error || 'Failed to close session.');
            });
          }
        })
        .catch(error => {
          alert(`Error: ${error.message}`);
          button.disabled = false;
          button.textContent = originalLabel;
        });
      });
    });
  })();

  // Close Pinned Issue Handler
  (function () {
    const closePinnedIssueButtons = document.querySelectorAll('.close-pinned-issue-btn');
    if (!closePinnedIssueButtons.length) {
      return;
    }

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

    closePinnedIssueButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const projectId = button.dataset.projectId;
        const issueId = button.dataset.issueId;
        const issueTitle = button.dataset.issueTitle;
        const externalId = button.dataset.externalId;

        if (!projectId || !issueId) {
          return;
        }

        if (!confirm(`Are you sure you want to close issue #${externalId}: "${issueTitle}"?`)) {
          return;
        }

        const url = `/projects/${projectId}/issues/${issueId}/close`;
        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Closing...';

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
          },
          credentials: 'same-origin',
        })
        .then(response => {
          if (response.ok) {
            // Remove the issue card from the DOM
            const issueRow = button.closest('.issue-row');
            if (issueRow) {
              issueRow.style.opacity = '0';
              issueRow.style.transition = 'opacity 0.3s ease';
              setTimeout(() => {
                issueRow.remove();
                // Check if there are no more pinned issues
                const pinnedIssuesList = document.querySelector('.pinned-issues-subtitle')?.closest('.dashboard-section');
                const remainingIssues = document.querySelectorAll('.close-pinned-issue-btn').length;
                if (remainingIssues === 0 && pinnedIssuesList) {
                  pinnedIssuesList.remove();
                }
              }, 300);
            }

            // Show success message
            alert(`Issue #${externalId} closed successfully.`);
          } else {
            return response.text().then(text => {
              throw new Error('Failed to close issue.');
            });
          }
        })
        .catch(error => {
          alert(`Error: ${error.message}`);
          button.disabled = false;
          button.textContent = originalLabel;
        });
      });
    });
  })();

  // AI Session History
  (function() {
    const container = document.getElementById('ai-sessions-container');
    const filterSelect = document.getElementById('ai-session-filter');
    const activeOnlyCheckbox = document.getElementById('ai-session-active-only');

    if (!container || !filterSelect || !activeOnlyCheckbox) {
      return;
    }

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}h ${mins}m`;
    }

    function formatTimestamp(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short'
      });
    }

    function renderSessions(sessions) {
      if (!sessions || sessions.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No AI sessions found.</p></div>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'tmux-recent-grid';

      sessions.forEach(session => {
        const card = document.createElement('div');
        card.className = 'tmux-recent-card';
        card.style.minHeight = 'auto';

        const toolClass = session.tool ? `tmux-chip--tool` : '';
        const statusBadge = session.is_active
          ? '<span class="tmux-chip" style="background: #10b981;">Active</span>'
          : '<span class="tmux-chip" style="background: #64748b;">Ended</span>';

        card.innerHTML = `
          <div class="tmux-recent-meta">
            <strong>${session.project_name}</strong>
            <span class="tmux-chip ${toolClass}">${session.tool}</span>
            ${statusBadge}
            ${session.branch ? `<span class="tmux-meta">Branch: ${session.branch}</span>` : ''}
          </div>
          <div class="tmux-recent-meta" style="font-size: 0.85rem; margin-top: 0.5rem;">
            <span>Started: ${formatTimestamp(session.started_at)}</span>
            ${session.ended_at ? `<span>Ended: ${formatTimestamp(session.ended_at)}</span>` : ''}
            <span>Duration: ${formatDuration(session.elapsed_seconds)}</span>
          </div>
          ${session.description ? `
            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #64748b;">
              ${session.description}
            </div>
          ` : ''}
          <div class="tmux-recent-actions" style="margin-top: 0.75rem;">
            <div class="tmux-action">
              <button
                class="secondary outline tmux-action-btn resume-session-btn"
                data-session-id="${session.id}"
                data-project-name="${session.project_name}"
                data-tool="${session.tool}"
              >
                Resume Session
              </button>
            </div>
            <div class="tmux-action">
              <button
                class="secondary outline tmux-action-btn copy-command-btn"
                data-command="${session.resume_command.replace(/"/g, '&quot;')}"
                title="${session.resume_command}"
              >
                Copy Command
              </button>
            </div>
          </div>
        `;

        grid.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(grid);

      // Add event listeners for resume buttons
      grid.querySelectorAll('.resume-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sessionId = this.dataset.sessionId;
          const projectName = this.dataset.projectName;
          const tool = this.dataset.tool;

          if (!confirm(`Resume ${tool} session in project ${projectName}?`)) {
            return;
          }

          const originalText = this.textContent;
          this.disabled = true;
          this.textContent = 'Resuming...';

          fetch(`/api/v1/ai/sessions/${sessionId}/resume`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({}),
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                throw new Error(data.error || 'Failed to resume session');
              });
            }
            return response.json();
          })
          .then(data => {
            alert(`Session resumed successfully! Session ID: ${data.session_id}`);
            loadSessions();
          })
          .catch(error => {
            alert(`Error: ${error.message}`);
            this.disabled = false;
            this.textContent = originalText;
          });
        });
      });

      // Add event listeners for copy buttons
      grid.querySelectorAll('.copy-command-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const command = this.dataset.command;
          navigator.clipboard.writeText(command).then(() => {
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => {
              this.textContent = originalText;
            }, 2000);
          }).catch(err => {
            alert('Failed to copy command: ' + err);
          });
        });
      });
    }

    function loadSessions() {
      const tool = filterSelect.value;
      const activeOnly = activeOnlyCheckbox.checked;

      const params = new URLSearchParams();
      if (tool) params.set('tool', tool);
      if (activeOnly) params.set('active_only', 'true');
      params.set('limit', '20');

      fetch(`/api/v1/ai/sessions?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          renderSessions(data.sessions);
        })
        .catch(error => {
          container.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Error loading sessions: ${error.message}</p></div>`;
        });
    }

    // Load sessions on page load
    loadSessions();

    // Reload on filter change
    filterSelect.addEventListener('change', loadSessions);
    activeOnlyCheckbox.addEventListener('change', loadSessions);
  })();
</script>
{% endblock %}
{% endblock %}
