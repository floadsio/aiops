{% extends "base.html" %}
{% block title %}Dashboard | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .dashboard-hero {
    margin: 0 0 2rem;
  }
  .dashboard-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .metric-card {
    flex: 1 1 160px;
    padding: 0.85rem 1.1rem;
    border-radius: 0.9rem;
    background: rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(148, 163, 184, 0.25);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
  }
  .metric-card strong {
    display: block;
    margin-top: 0.25rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0;
  }
  .dashboard-section {
    margin-bottom: 1.75rem;
  }
  .dashboard-section > header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 1.25rem;
    gap: 0.75rem;
  }
  .dashboard-section h2 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: #0f172a;
  }
  [data-theme="dark"] .dashboard-section h2 {
    color: #e2e8f0;
  }
  .dashboard-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: 1fr;
  }
  @media (min-width: 1100px) {
    .dashboard-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: stretch;
    }
  }
  .dashboard-card {
    padding: 1.75rem;
    border-radius: 1.25rem;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 16px 45px rgba(15, 23, 42, 0.08);
    backdrop-filter: blur(6px);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  [data-theme="dark"] .dashboard-card {
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 18px 40px rgba(2, 6, 23, 0.6);
  }
  .dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 22px 60px rgba(15, 23, 42, 0.18);
  }
  .tenant-card h3 {
    margin: 0 0 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #0f172a;
  }
  [data-theme="dark"] .tenant-card h3 {
    color: #f1f5f9;
  }
  .tenant-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    font-size: 0.9rem;
    color: #475569;
  }
  [data-theme="dark"] .tenant-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .tenant-description {
    margin: 0 0 1.25rem;
    color: #334155;
    font-size: 0.95rem;
  }
  [data-theme="dark"] .tenant-description {
    color: rgba(226, 232, 240, 0.85);
  }
  .tenant-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  .project-card h3 {
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
  }
  .project-card p {
    margin: 0;
    color: #475569;
    font-size: 0.95rem;
  }
  [data-theme="dark"] .project-card p {
    color: rgba(226, 232, 240, 0.75);
  }
  .project-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0.75rem 0 0;
  }
  .project-actions form {
    margin: 0;
    display: flex;
    gap: 0.5rem;
  }
  .project-actions button {
    min-width: 9.5rem;
    justify-content: center;
  }
  .issue-overview {
    margin-top: 1.1rem;
    padding: 1rem 1.2rem;
    border-radius: 1rem;
    background: rgba(15, 23, 42, 0.05);
    border: 1px solid rgba(148, 163, 184, 0.3);
  }
  [data-theme="dark"] .issue-overview {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.35);
  }
  .issue-overview header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .issue-overview h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
  }
  .issue-total {
    font-size: 0.85rem;
    color: #475569;
  }
  [data-theme="dark"] .issue-total {
    color: rgba(226, 232, 240, 0.7);
  }
  .issue-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0 0 0.75rem;
  }
  .issue-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.65rem;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.12);
    color: #1d4ed8;
    font-size: 0.8rem;
    font-weight: 600;
  }
  [data-theme="dark"] .issue-chip {
    background: rgba(96, 165, 250, 0.25);
    color: #bfdbfe;
  }
  .issue-sources {
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
  }
  .issue-source {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .issue-source-heading {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: baseline;
    font-size: 0.9rem;
  }
  .issue-provider {
    font-weight: 600;
  }
  .issue-target {
    font-weight: 500;
    letter-spacing: 0.01em;
  }
  .issue-status-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.55rem;
  }
  .text-muted {
    color: #64748b;
    font-size: 0.85rem;
  }
  [data-theme="dark"] .text-muted {
    color: rgba(203, 213, 225, 0.7);
  }
  .warning-note {
    color: #b45309;
    font-size: 0.85rem;
    font-weight: 600;
  }
  [data-theme="dark"] .warning-note {
    color: #facc15;
  }
  .tmux-session-panel {
    margin-top: 1.1rem;
    padding: 1rem 1.2rem;
    border-radius: 1rem;
    background: rgba(148, 163, 184, 0.18);
    border: 1px solid rgba(148, 163, 184, 0.45);
  }
  [data-theme="dark"] .tmux-session-panel {
    background: rgba(30, 41, 59, 0.65);
    border-color: rgba(148, 163, 184, 0.4);
  }
  .tmux-session-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.85rem;
  }
  .tmux-session-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e293b;
  }
  [data-theme="dark"] .tmux-session-header h4 {
    color: rgba(226, 232, 240, 0.9);
  }
  .tmux-session-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.16);
    color: #1d4ed8;
  }
  [data-theme="dark"] .tmux-session-count {
    background: rgba(96, 165, 250, 0.25);
    color: #bfdbfe;
  }
  .tmux-session-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .tmux-session-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 0.9rem;
    border-radius: 0.75rem;
    background: rgba(148, 163, 184, 0.12);
  }
  [data-theme="dark"] .tmux-session-row {
    background: rgba(148, 163, 184, 0.16);
  }
  .tmux-session-meta {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .tmux-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.15);
    color: #1d4ed8;
  }
  [data-theme="dark"] .tmux-chip {
    background: rgba(96, 165, 250, 0.2);
    color: #bfdbfe;
  }
  .tmux-session-actions {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
  }
  .tmux-command {
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
  }
  .tmux-recent-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }
  .tmux-recent-card {
    padding: 1rem 1.1rem;
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(241, 245, 249, 0.6);
  }
  [data-theme="dark"] .tmux-recent-card {
    border-color: rgba(148, 163, 184, 0.25);
    background: rgba(30, 41, 59, 0.65);
  }
  .tmux-recent-meta {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    margin-bottom: 0.75rem;
  }
  .tmux-recent-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .update-form {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .update-form .checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .update-form .form-helper {
    font-size: 0.85rem;
  }
  .update-log {
    display: block;
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: rgba(241, 245, 249, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    max-height: 18rem;
    overflow: auto;
  }
  [data-theme="dark"] .update-log {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .empty-state {
    padding: 1.5rem;
    border-radius: 1.25rem;
    border: 1px dashed rgba(71, 85, 105, 0.35);
    text-align: center;
    color: #475569;
  }
  [data-theme="dark"] .empty-state {
    color: rgba(226, 232, 240, 0.65);
    border-color: rgba(148, 163, 184, 0.35);
  }
</style>
{% endblock %}
{% block content %}
<section class="dashboard-hero">
  <div class="dashboard-metrics">
    <div class="metric-card">
      Tenants
      <strong>{{ tenants|length }}</strong>
    </div>
    <div class="metric-card">
      Projects
      <strong>{{ projects|length }}</strong>
    </div>
    <div class="metric-card">
      Pending Tasks
      <strong>{{ pending_tasks }}</strong>
    </div>
  </div>
</section>

<section class="dashboard-section">
  <header>
    <h2>Recent tmux Windows</h2>
    <small class="text-muted">Quickly reattach to active AI consoles.</small>
  </header>
  {% if recent_tmux_error %}
    <p class="warning-note">tmux unavailable: {{ recent_tmux_error }}</p>
  {% elif recent_tmux_windows %}
    <div class="tmux-recent-grid">
      {% for window in recent_tmux_windows %}
        <article class="tmux-recent-card">
          <div class="tmux-recent-meta">
            <span class="tmux-chip">{{ window.window }}</span>
            <span class="text-muted">Session {{ window.session }}</span>
            {% if window.project %}
              <span class="text-muted">Project {{ window.project.project_name }}</span>
            {% endif %}
            <span class="text-muted">
              {{ window.panes }} pane{{ '' if window.panes == 1 else 's' }}
              {% if window.created_display %}
                • Started {{ window.created_display }}
              {% endif %}
            </span>
          </div>
          <div class="tmux-recent-actions">
            {% if window.project %}
              <a
                role="button"
                class="secondary outline"
                href="{{ url_for('projects.project_ai_console', project_id=window.project.project_id, attach=window.target) }}"
              >
                Reattach
              </a>
            {% endif %}
            <code class="tmux-command">tmux attach -t {{ window.target }}</code>
            <button type="button" class="secondary outline copy-tmux-command" data-command="tmux attach -t {{ window.target }}">
              Copy command
            </button>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No tmux windows detected yet.</p>
  {% endif %}
</section>

<section class="dashboard-section">
  <header>
    <h2>Recent Projects</h2>
    <small><a href="{{ url_for('admin.manage_projects') }}">All projects →</a></small>
  </header>
  {% if project_cards %}
    <div class="dashboard-grid">
      {% for card in project_cards %}
        {% set project = card.project %}
        {% set status = card.status %}
        <article class="dashboard-card project-card">
          <h3>
            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}">
              {{ project.name }}
            </a>
          </h3>
          <p>Tenant: {{ project.tenant.name }}</p>
          {% set issue_form = card.issue_sync_form %}
          {% set git_form = card.git_refresh_form %}
          <div class="project-actions">
            <form method="post" action="{{ url_for('admin.refresh_project_issues', project_id=project.id) }}">
              {{ issue_form.hidden_tag() }}
              {{ issue_form.project_id() }}
              <button type="submit" class="secondary">Refresh Issues</button>
              <button type="submit" class="secondary outline" name="force_full" value="1" title="Force a full resync of all cached issues for this project.">
                Force Full Resync
              </button>
            </form>
            <form method="post" action="{{ url_for('admin.refresh_project_git', project_id=project.id) }}">
              {{ git_form.hidden_tag() }}
              {{ git_form.project_id() }}
              {{ git_form.submit(class="secondary outline") }}
              {{ git_form.clean_submit(class="critical outline", title="Discard local changes before pulling.") }}
            </form>
          </div>
          {% set branch_name = status.get("branch") or project.default_branch %}
          {% if status.get("last_commit_display") and status.get("last_commit_author") %}
            <p>
              Last modified by {{ status.get("last_commit_author") }}
              on {{ status.get("last_commit_display") }} (branch {{ branch_name }})
            </p>
            {% if status.get("last_commit_hash") or status.get("last_commit_subject") %}
              <p class="text-muted">
                Commit
                {% if status.get("last_commit_hash") %}
                  <code>{{ status.get("last_commit_hash") }}</code>
                {% endif %}
                {% if status.get("last_commit_subject") %}
                  &mdash; {{ status.get("last_commit_subject") }}
                {% endif %}
              </p>
            {% endif %}
          {% elif status.get("last_commit_display") %}
            <p>Last modified on {{ status.get("last_commit_display") }} (branch {{ branch_name }})</p>
          {% elif status.get("last_pull_display") %}
            <p>Last pull on {{ status.get("last_pull_display") }} (branch {{ branch_name }})</p>
          {% else %}
            <p class="text-muted">No pull recorded yet (branch {{ branch_name }}).</p>
          {% endif %}
          {% if status.get("dirty") %}
            <p class="critical-note">Uncommitted changes detected</p>
          {% endif %}
          {% if status.get("error") %}
            <p class="warning-note">Status unavailable: {{ status.get("error") }}</p>
          {% endif %}
          {% if card.issue_integrations %}
            <div class="issue-overview">
              <header>
                <h4>External Issues</h4>
                {% if card.issue_summary.total %}
                  <span class="issue-total">{{ card.issue_summary.total }} total</span>
                {% else %}
                  <span class="issue-total text-muted">No issues cached yet</span>
                {% endif %}
              </header>
              <div class="issue-sources">
                {% for integration in card.issue_integrations %}
                  <div class="issue-source">
                    <div class="issue-source-heading">
                      <span class="issue-provider">{{ integration.provider_display }}</span>
                      {% if integration.project_identifier %}
                        <span class="issue-target">{{ integration.project_identifier }}</span>
                      {% endif %}
                      {% if integration.integration_name %}
                        <span class="text-muted">{{ integration.integration_name }}</span>
                      {% endif %}
                      {% if integration.source_label %}
                        <span class="text-muted">{{ integration.source_label }}</span>
                      {% endif %}
                      {% if not integration.enabled %}
                        <span class="badge">Disabled</span>
                      {% endif %}
                    </div>
                    {% if integration.status_entries %}
                      <div class="issue-status-list">
                        {% for entry in integration.status_entries %}
                          <a
                            class="issue-chip"
                            href="{{ url_for(
                              'projects.project_detail',
                              project_id=project.id,
                              issue_status=entry.key
                            ) }}"
                          >
                            {{ entry.label }}: {{ entry.count }}
                          </a>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="text-muted">No issues cached yet.</p>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {% if card.tmux_error %}
            <p class="warning-note">tmux: {{ card.tmux_error }}</p>
          {% elif card.tmux_windows %}
            <div class="tmux-session-panel">
              <header class="tmux-session-header">
                <h4>Running tmux windows</h4>
                <span class="tmux-session-count">{{ card.tmux_windows|length }}</span>
              </header>
              <div class="tmux-session-list">
                {% for session in card.tmux_windows %}
                  <div class="tmux-session-row">
                    <div class="tmux-session-meta">
                      <span class="tmux-chip">{{ session.window }}</span>
                      <span class="text-muted">
                        {{ session.panes }} pane{{ '' if session.panes == 1 else 's' }}
                      </span>
                      {% if session.created_display %}
                        <span class="text-muted">Started {{ session.created_display }}</span>
                      {% endif %}
                    </div>
                    <div class="tmux-session-actions">
                      <a
                        role="button"
                        class="secondary outline"
                        href="{{ url_for(
                          'projects.project_ai_console',
                          project_id=project.id,
                          attach=session.target
                        ) }}"
                      >
                        Reattach
                      </a>
                      <span class="text-muted tmux-command">tmux attach -t {{ session.target }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <p>No projects configured. Connect a repository to see automation insights here.</p>
      <a role="button" href="{{ url_for('admin.manage_projects') }}">Add project</a>
    </div>
  {% endif %}
</section>

<section class="dashboard-section">
  <header>
    <h2>Tenants</h2>
    <small><a href="{{ url_for('admin.manage_tenants') }}">Manage tenants →</a></small>
  </header>
  {% if tenants %}
    <div class="dashboard-grid">
      {% for tenant in tenants %}
        <article class="dashboard-card tenant-card">
          <div class="tenant-meta">
            <span>
              {{ tenant.projects|length }} project{{ '' if tenant.projects|length == 1 else 's' }}
            </span>
          </div>
          <h3>{{ tenant.name }}</h3>
          <p class="tenant-description">
            {{
              tenant.description or
              "No description yet — keep your operators informed with a quick summary."
            }}
          </p>
          <div class="tenant-actions">
            <a
              role="button"
              class="secondary outline"
              href="{{ url_for('admin.manage_projects') }}?tenant={{ tenant.id }}"
            >
              View projects
            </a>
            <a
              role="button"
              class="secondary"
              href="{{ url_for('admin.manage_tenants') }}#tenant-{{ tenant.id }}"
            >
              Edit tenant
            </a>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <p>No tenants yet. Kickstart automation by creating your first tenant.</p>
      <a role="button" href="{{ url_for('admin.manage_tenants') }}">Create tenant</a>
    </div>
  {% endif %}
</section>
<script>
  document.querySelectorAll('.copy-tmux-command').forEach(button => {
    button.addEventListener('click', () => {
      const command = button.dataset.command;
      if (!command) {
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(command).then(() => {
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.textContent = 'Copy command';
          }, 1500);
        }).catch(() => {
          button.textContent = 'Copy failed';
          setTimeout(() => {
            button.textContent = 'Copy command';
          }, 1500);
        });
      }
    });
  });
</script>
{% endblock %}
