{% extends "base.html" %}
{% block title %}AI-Assisted Issue Creation | aiops Control Panel{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    .create-assisted-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .create-assisted-card {
      padding: 2rem;
      border-radius: 1.25rem;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 16px 45px rgba(15, 23, 42, 0.08);
    }
    [data-theme="dark"] .create-assisted-card {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.25);
    }
    .form-section {
      margin-bottom: 2rem;
    }
    .form-section h3 {
      margin: 0 0 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: #0f172a;
    }
    [data-theme="dark"] .form-section h3 {
      color: #e2e8f0;
    }
    .form-section p {
      margin: 0 0 1rem;
      color: #64748b;
      font-size: 0.95rem;
    }
    [data-theme="dark"] .form-section p {
      color: #94a3b8;
    }
    .description-textarea {
      min-height: 200px;
      font-family: system-ui, -apple-system, sans-serif;
      resize: vertical;
    }
    .form-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loading-overlay.active {
      display: flex;
    }
    .loading-container {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 400px;
      text-align: center;
    }
    [data-theme="dark"] .loading-container {
      background: #1e293b;
    }
    .loading-container h3 {
      margin: 0 0 0.5rem;
      color: #0f172a;
    }
    [data-theme="dark"] .loading-container h3 {
      color: #e2e8f0;
    }
    .loading-container p {
      margin: 0 0 1.5rem;
      color: #64748b;
      font-size: 0.95rem;
    }
    [data-theme="dark"] .loading-container p {
      color: #94a3b8;
    }

    /* Approval section (hidden by default) */
    #approval-section {
      display: none;
    }
    #approval-section.active {
      display: block;
    }
    #input-section.hidden {
      display: none;
    }

    /* Approval content */
    .approval-field {
      margin-bottom: 1.5rem;
    }
    .approval-field label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #0f172a;
    }
    [data-theme="dark"] .approval-field label {
      color: #e2e8f0;
    }
    .approval-field textarea,
    .approval-field input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.5rem;
      font-family: system-ui, -apple-system, sans-serif;
      color: #0f172a;
      background: white;
    }
    [data-theme="dark"] .approval-field textarea,
    [data-theme="dark"] .approval-field input {
      background: #0f172a;
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.25);
    }
    .approval-field textarea {
      min-height: 150px;
      resize: vertical;
    }
    .approval-field input {
      min-height: 45px;
    }

    /* Labels display */
    .labels-display {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .label-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    [data-theme="dark"] .label-badge {
      background: #312e81;
      color: #c7d2fe;
    }

    /* Info box */
    .info-box {
      padding: 1rem;
      background: #f0f9ff;
      border-left: 4px solid #0284c7;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    [data-theme="dark"] .info-box {
      background: #082f49;
      border-left-color: #0ea5e9;
    }
    .info-box p {
      margin: 0;
      color: #0369a1;
      font-size: 0.95rem;
    }
    [data-theme="dark"] .info-box p {
      color: #0ea5e9;
    }

    /* Approval actions */
    .approval-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    @media (max-width: 640px) {
      .approval-actions {
        flex-direction: column;
      }
    }
  </style>
{% endblock %}
{% block content %}
<div class="create-assisted-container">
  <h1>AI-Assisted Issue Creation</h1>
  <p style="margin-bottom: 2rem; color: #64748b;">
    Describe what you want to work on in natural language, and AI will help create a properly formatted issue.
  </p>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <h3>AI is working...</h3>
      <p>Reformulating your description into a proper issue.</p>
      <article aria-busy="true"></article>
    </div>
  </div>

  <div class="create-assisted-card">
    <!-- Error Message Container -->
    <div id="errorContainer" style="display: none; margin-bottom: 1.5rem;">
      <article style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 1rem; border-radius: 0.5rem;">
        <p style="margin: 0; color: #991b1b;">
          <strong style="display: block; margin-bottom: 0.25rem;">Error</strong>
          <span id="errorMessage"></span>
        </p>
      </article>
    </div>

    <!-- Input Section (Step 1) -->
    <div id="input-section">
      <form id="create-assisted-form" method="post">
        {{ form.hidden_tag() }}

        <div class="form-section">
          <h3>What do you want to work on?</h3>
          <p>Describe your feature idea or bug fix in plain language. The AI will help structure it into a proper issue.</p>
          {{ form.description(class="description-textarea", placeholder="Example: I want to add user authentication with OAuth2 support. Users should be able to login with Google and GitHub. Need to store user sessions securely.") }}
        </div>

        <div class="form-section">
          <label for="{{ form.project_id.id }}">
            <h3>Project</h3>
          </label>
          {{ form.project_id(required=True) }}
        </div>

        <div class="form-section">
          <label for="{{ form.ai_tool.id }}">
            <h3>AI Tool</h3>
          </label>
          <p>Select which AI tool to use for the session</p>
          {{ form.ai_tool(required=True) }}
        </div>

        <div class="form-grid">
          <div class="form-section">
            <label for="{{ form.issue_type.id }}">
              <h3>Issue Type (Optional)</h3>
            </label>
            {{ form.issue_type() }}
          </div>

          <div class="form-section">
            <h3>Options</h3>
            <div class="checkbox-group">
              <label class="checkbox-label">
                {{ form.create_branch() }}
                <span>Create feature/fix branch after creating the issue</span>
              </label>
              <label class="checkbox-label">
                {{ form.pin_issue() }}
                <span>Pin issue to dashboard</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="primary" id="reformulateBtn">
            <span>Reformulate with AI</span>
          </button>
          <a href="{{ url_for('admin.manage_issues') }}" role="button" class="secondary outline">Cancel</a>
        </div>
      </form>
    </div>

    <!-- Approval Section (Step 2) -->
    <div id="approval-section">
      <div class="info-box">
        <p>✓ AI has reformulated your description. Review and approve before creating the issue.</p>
      </div>

      <form id="approval-form" method="post">
        {{ form.hidden_tag() }}
        <input type="hidden" id="reformulatedData" name="reformulated_data" value="">

        <div class="approval-field">
          <label for="approvalTitle">Issue Title</label>
          <input type="text" id="approvalTitle" name="title" required>
        </div>

        <div class="approval-field">
          <label for="approvalDescription">Issue Description</label>
          <textarea id="approvalDescription" name="description" required></textarea>
        </div>

        <div class="approval-field">
          <label>Generated Labels</label>
          <div class="labels-display" id="approvalLabels"></div>
        </div>

        <div class="approval-field">
          <label>Branch Prefix</label>
          <input type="text" id="approvalBranchPrefix" readonly>
        </div>

        <div class="approval-actions">
          <button type="submit" class="primary" id="approveBtn">
            <span>Approve & Create Issue</span>
          </button>
          <button type="button" class="secondary outline" id="editBtn">
            <span>Edit & Re-run AI</span>
          </button>
          <button type="button" class="secondary outline" id="cancelBtn">
            <span>Cancel</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Configuration
  const API_BASE = '/api/v1';

  // DOM Elements
  const loadingOverlay = document.getElementById('loadingOverlay');
  const inputSection = document.getElementById('input-section');
  const approvalSection = document.getElementById('approval-section');
  const createForm = document.getElementById('create-assisted-form');
  const approvalForm = document.getElementById('approval-form');
  const reformulateBtn = document.getElementById('reformulateBtn');
  const approveBtn = document.getElementById('approveBtn');
  const editBtn = document.getElementById('editBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const descriptionField = createForm.description;
  const projectField = createForm.project_id;
  const issueTypeField = createForm.issue_type;
  const errorContainer = document.getElementById('errorContainer');
  const errorMessage = document.getElementById('errorMessage');

  // Helper functions
  function showError(message) {
    errorMessage.textContent = message;
    errorContainer.style.display = 'block';
    // Scroll to error
    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function hideError() {
    errorContainer.style.display = 'none';
    errorMessage.textContent = '';
  }

  // Form submission handlers
  reformulateBtn.addEventListener('click', handleReformulate);
  editBtn.addEventListener('click', handleEditAndRerun);
  cancelBtn.addEventListener('click', handleCancel);
  approvalForm.addEventListener('submit', handleApprove);

  async function handleReformulate(e) {
    e.preventDefault();
    hideError();

    // Validate input
    const description = descriptionField.value.trim();
    if (!description) {
      showError('Please describe what you want to work on.');
      descriptionField.focus();
      return;
    }

    // Show loading
    loadingOverlay.classList.add('active');

    try {
      const issueType = issueTypeField.value || null;

      // Debug logging
      console.log('Reformulation request:');
      console.log('  description length:', description.length);
      console.log('  issue_type:', issueType);

      // Call reformulation endpoint
      const response = await fetch(`${API_BASE}/issues/reformulate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          description: description,
          issue_type: issueType
        })
      });

      console.log('Response status:', response.status);

      if (!response.ok) {
        let errorMsg = `HTTP ${response.status}: Failed to reformulate issue`;
        try {
          // Clone response so we can read it
          const clonedResponse = response.clone();
          const errorData = await clonedResponse.json();
          // Prefer details over error message
          if (errorData.details) {
            errorMsg = errorData.details;
          } else if (errorData.error) {
            errorMsg = errorData.error;
          }
          console.error('API error response:', errorData);
        } catch (parseErr) {
          console.error('Could not parse error response:', parseErr);
          // Try to get text
          try {
            const text = await response.text();
            console.error('Response body:', text);
            errorMsg = text || errorMsg;
          } catch (textErr) {
            console.error('Could not read response text:', textErr);
          }
        }
        throw new Error(errorMsg);
      }

      const data = await response.json();
      console.log('Reformulation response:', {
        title: data.title?.substring(0, 50),
        description_length: data.description?.length,
        labels: data.labels,
        branch_prefix: data.branch_prefix
      });

      // Validate response data
      if (!data.title || !data.description) {
        throw new Error('Invalid response: missing title or description');
      }

      // Populate approval section
      document.getElementById('approvalTitle').value = data.title;
      document.getElementById('approvalDescription').value = data.description;
      document.getElementById('approvalBranchPrefix').value = data.branch_prefix || 'feature';

      // Display labels
      const labelsContainer = document.getElementById('approvalLabels');
      labelsContainer.innerHTML = (data.labels || []).map(label =>
        `<span class="label-badge">${label}</span>`
      ).join('');

      // Store reformulated data
      document.getElementById('reformulatedData').value = JSON.stringify({
        title: data.title,
        description: data.description,
        labels: data.labels || [],
        branch_prefix: data.branch_prefix || 'feature'
      });

      // Show approval section
      inputSection.classList.add('hidden');
      approvalSection.classList.add('active');

    } catch (error) {
      console.error('Reformulation error:', error);
      loadingOverlay.classList.remove('active');
      // Extract the actual error message from nested error messages
      let errorMsg = error.message;
      if (errorMsg.startsWith('Failed to reformulate issue: Failed to reformulate issue:')) {
        errorMsg = errorMsg.replace('Failed to reformulate issue: Failed to reformulate issue: ', '');
      } else if (errorMsg.startsWith('Failed to reformulate issue: ')) {
        errorMsg = errorMsg.substring('Failed to reformulate issue: '.length);
      }
      showError(`⚠️ ${errorMsg}`);
    } finally {
      if (loadingOverlay.classList.contains('active')) {
        loadingOverlay.classList.remove('active');
      }
    }
  }

  function handleEditAndRerun(e) {
    e.preventDefault();

    // Get updated description from approval form
    const updatedDescription = document.getElementById('approvalDescription').value;
    descriptionField.value = updatedDescription;

    // Return to input section and re-run
    approvalSection.classList.remove('active');
    inputSection.classList.remove('hidden');

    // Auto-focus and reformulate
    setTimeout(() => {
      handleReformulate(new Event('click'));
    }, 100);
  }

  function handleCancel(e) {
    e.preventDefault();

    // Return to input section
    approvalSection.classList.remove('active');
    inputSection.classList.remove('hidden');
  }

  async function handleApprove(e) {
    e.preventDefault();
    hideError();

    // Show loading
    loadingOverlay.classList.add('active');

    try {
      // Get approved data
      const title = document.getElementById('approvalTitle').value;
      const description = document.getElementById('approvalDescription').value;
      const branchPrefix = document.getElementById('approvalBranchPrefix').value;

      // Get all form data from the CREATE form, including hidden fields
      const formData = new FormData(createForm);

      // Add approved content - these will override the form fields
      formData.set('title', title);
      formData.set('description', description);
      formData.set('branch_prefix', branchPrefix);

      // Debug: Log what we're sending
      console.log('Form data being submitted:');
      for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${typeof value === 'string' ? value.substring(0, 50) : value}`);
      }

      // Submit to create-assisted endpoint
      const response = await fetch(createForm.action || '', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        let errorData = {};
        try {
          errorData = await response.json();
        } catch (parseError) {
          console.error('Could not parse error response:', parseError);
        }

        const errorMsg = errorData.error || errorData.message || 'Failed to create issue';
        throw new Error(errorMsg);
      }

      // Success - redirect or show message
      const result = await response.json();
      if (result.issue_url) {
        window.location.href = result.issue_url;
      } else if (result.success) {
        // Redirect to issues list
        window.location.href = '/admin/issues';
      } else {
        throw new Error(result.error || 'Issue creation failed');
      }

    } catch (error) {
      console.error('Approval error:', error);
      loadingOverlay.classList.remove('active');
      showError(`Error creating issue: ${error.message}`);
    }
  }
</script>
{% endblock %}
