{% extends "base.html" %}
{% block title %}Issues | aiops Control Panel{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    .issues-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .issue-filter-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }
    .issue-filter-form select {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.92);
      min-width: 10rem;
    }
    [data-theme="dark"] .issue-filter-form select {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.65);
      color: rgba(226, 232, 240, 0.9);
    }
    .issue-refresh-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }
    .issues-table table {
      width: 100%;
    }
    .issues-table th {
      white-space: nowrap;
    }
    .issues-table .sort-link {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }
    .issues-table .sort-link:hover,
    .issues-table .sort-link:focus {
      text-decoration: underline;
    }
    .issues-table .sort-indicator {
      font-size: 0.8rem;
      opacity: 0.65;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }
    .issues-table .sort-link.is-active .sort-indicator {
      opacity: 1;
    }
    .issue-title-button {
      background: none;
      border: none;
      color: #2563eb;
      font: inherit;
      padding: 0;
      cursor: pointer;
      text-align: left;
    }
    .issue-title-button:hover,
    .issue-title-button:focus {
      text-decoration: underline;
    }
    [data-theme="dark"] .issue-title-button {
      color: #93c5fd;
    }
    .issue-detail-row[hidden] {
      display: none;
    }
    .issue-detail {
      padding: 1.25rem 1.4rem;
      border-radius: 1rem;
      background: rgba(241, 245, 249, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: grid;
      gap: 0.8rem;
    }
    [data-theme="dark"] .issue-detail {
      background: rgba(30, 41, 59, 0.7);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .issue-detail__header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: flex-start;
    }
    .issue-detail__description {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    /* Markdown styling for issue descriptions */
    .issue-detail__description h1,
    .issue-detail__description h2,
    .issue-detail__description h3,
    .issue-detail__description h4,
    .issue-detail__description h5,
    .issue-detail__description h6 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
      line-height: 1.25;
    }
    .issue-detail__description h1 { font-size: 1.75em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .issue-detail__description h2 { font-size: 1.5em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .issue-detail__description h3 { font-size: 1.25em; }
    .issue-detail__description h4 { font-size: 1.1em; }
    .issue-detail__description h5 { font-size: 1em; }
    .issue-detail__description h6 { font-size: 0.9em; color: #64748b; }
    .issue-detail__description p {
      margin-bottom: 1em;
    }
    .issue-detail__description code {
      background-color: rgba(175, 184, 193, 0.2);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .issue-detail__description pre {
      background-color: #f6f8fa;
      border-radius: 6px;
      padding: 16px;
      overflow: auto;
      margin: 1em 0;
      font-size: 0.85em;
      line-height: 1.45;
    }
    .issue-detail__description pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    .issue-detail__description blockquote {
      border-left: 4px solid #dfe2e5;
      padding-left: 1em;
      margin: 1em 0;
      color: #6a737d;
    }
    .issue-detail__description ul,
    .issue-detail__description ol {
      padding-left: 2em;
      margin-bottom: 1em;
    }
    .issue-detail__description li {
      margin-bottom: 0.25em;
    }
    .issue-detail__description table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    .issue-detail__description table th,
    .issue-detail__description table td {
      border: 1px solid #dfe2e5;
      padding: 0.5em 1em;
    }
    .issue-detail__description table th {
      background-color: #f6f8fa;
      font-weight: 600;
    }
    .issue-detail__description hr {
      border: 0;
      border-top: 1px solid #e2e8f0;
      margin: 1.5em 0;
    }
    .issue-detail__description a {
      color: #0969da;
      text-decoration: none;
    }
    .issue-detail__description a:hover {
      text-decoration: underline;
    }
    /* Dark theme adjustments */
    [data-theme="dark"] .issue-detail__description h1,
    [data-theme="dark"] .issue-detail__description h2 {
      border-bottom-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description h6 {
      color: #8b949e;
    }
    [data-theme="dark"] .issue-detail__description code {
      background-color: rgba(110, 118, 129, 0.4);
    }
    [data-theme="dark"] .issue-detail__description pre {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-detail__description blockquote {
      border-left-color: #3b434b;
      color: #8b949e;
    }
    [data-theme="dark"] .issue-detail__description table th,
    [data-theme="dark"] .issue-detail__description table td {
      border-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description table th {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-detail__description hr {
      border-top-color: #30363d;
    }
    [data-theme="dark"] .issue-detail__description a {
      color: #58a6ff;
    }
    /* Apply same Markdown styling to comment bodies */
    .issue-comment__body {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .issue-comment__body h1,
    .issue-comment__body h2,
    .issue-comment__body h3,
    .issue-comment__body h4,
    .issue-comment__body h5,
    .issue-comment__body h6 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
      line-height: 1.25;
    }
    .issue-comment__body h1 { font-size: 1.5em; }
    .issue-comment__body h2 { font-size: 1.3em; }
    .issue-comment__body h3 { font-size: 1.15em; }
    .issue-comment__body h4 { font-size: 1.05em; }
    .issue-comment__body h5 { font-size: 0.95em; }
    .issue-comment__body h6 { font-size: 0.85em; color: #64748b; }
    .issue-comment__body p {
      margin-bottom: 1em;
    }
    .issue-comment__body code {
      background-color: rgba(175, 184, 193, 0.2);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .issue-comment__body pre {
      background-color: #f6f8fa;
      border-radius: 6px;
      padding: 16px;
      overflow: auto;
      margin: 1em 0;
      font-size: 0.85em;
      line-height: 1.45;
    }
    .issue-comment__body pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    .issue-comment__body blockquote {
      border-left: 4px solid #dfe2e5;
      padding-left: 1em;
      margin: 1em 0;
      color: #6a737d;
    }
    .issue-comment__body ul,
    .issue-comment__body ol {
      padding-left: 2em;
      margin-bottom: 1em;
    }
    .issue-comment__body li {
      margin-bottom: 0.25em;
    }
    .issue-comment__body table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    .issue-comment__body table th,
    .issue-comment__body table td {
      border: 1px solid #dfe2e5;
      padding: 0.5em 1em;
    }
    .issue-comment__body table th {
      background-color: #f6f8fa;
      font-weight: 600;
    }
    .issue-comment__body hr {
      border: 0;
      border-top: 1px solid #e2e8f0;
      margin: 1.5em 0;
    }
    .issue-comment__body a {
      color: #0969da;
      text-decoration: none;
    }
    .issue-comment__body a:hover {
      text-decoration: underline;
    }
    [data-theme="dark"] .issue-comment__body h6 {
      color: #8b949e;
    }
    [data-theme="dark"] .issue-comment__body code {
      background-color: rgba(110, 118, 129, 0.4);
    }
    [data-theme="dark"] .issue-comment__body pre {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-comment__body blockquote {
      border-left-color: #3b434b;
      color: #8b949e;
    }
    [data-theme="dark"] .issue-comment__body table th,
    [data-theme="dark"] .issue-comment__body table td {
      border-color: #30363d;
    }
    [data-theme="dark"] .issue-comment__body table th {
      background-color: #161b22;
    }
    [data-theme="dark"] .issue-comment__body hr {
      border-top-color: #30363d;
    }
    [data-theme="dark"] .issue-comment__body a {
      color: #58a6ff;
    }
    .issue-detail__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    .issue-detail__meta dt {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(71, 85, 105, 0.9);
      margin: 0;
    }
    .issue-detail__meta dd {
      margin: 0.1rem 0 0;
      font-weight: 600;
    }
    [data-theme="dark"] .issue-detail__meta dt {
      color: rgba(226, 232, 240, 0.72);
    }
    .issue-detail__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    .issue-detail__status {
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .issue-card__details {
      margin-top: 1rem;
    }
    .issue-card__description {
      margin-top: 0.75rem;
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.45;
    }
  .issues-card-list {
    display: none;
    gap: 1rem;
    margin-top: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
    .issue-status-form {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .issue-status-form--table {
      justify-content: flex-start;
    }
    .issue-status-select {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.92);
      font-size: 0.85rem;
      min-width: 9rem;
      appearance: none;
      position: relative;
    }
    .issue-status-input {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.85rem;
      min-width: 9rem;
    }
    [data-theme="dark"] .issue-status-input {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.6);
      color: rgba(226, 232, 240, 0.9);
    }
    [data-theme="dark"] .issue-status-select {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.65);
      color: rgba(226, 232, 240, 0.9);
    }
    .issue-card {
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 1rem;
      padding: 1rem 1.15rem;
      background: rgba(255, 255, 255, 0.86);
      width: 100%;
    }
    [data-theme="dark"] .issue-card {
      background: rgba(15, 23, 42, 0.65);
      border-color: rgba(148, 163, 184, 0.4);
    }
    .issue-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .issue-card__header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .issue-card__title {
      margin: 0.25rem 0 0;
      font-size: 0.95rem;
    }
    .issue-card__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.6rem 1rem;
      margin: 1rem 0 0;
      padding: 0;
    }
    .issue-card__meta-item {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .issue-card__meta dt {
      margin: 0;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(71, 85, 105, 0.9);
    }
    .issue-card__meta dd {
      margin: 0;
      font-weight: 600;
    }
    [data-theme="dark"] .issue-card__meta dt {
      color: rgba(226, 232, 240, 0.72);
    }
    @media (max-width: 900px) {
      .issues-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .issue-filter-form,
      .issue-refresh-form {
        width: 100%;
      }
      .issue-filter-form select,
      .issue-refresh-form button {
        flex: 1;
        min-width: 0;
      }
    }
    @media (max-width: 720px) {
      .table-scroll.issues-table {
        display: none;
      }
      .issues-card-list {
        display: grid;
      }
      /* Make pin/unpin buttons visible and full-width on mobile */
      .issues-actions .inline-form {
        display: block !important;
        width: 100%;
      }
      .issues-actions .inline-form button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
{% endblock %}
{% block content %}
<h1>Issues</h1>

<div class="issues-actions">
  <form method="get" class="issue-filter-form">
    <select id="issue-status-filter" name="status" onchange="this.form.submit()" aria-label="Filter by issue status">
      {% for option in status_options %}
        <option value="{{ option.value }}" {% if option.value == status_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <select id="issue-tenant-filter" name="tenant" onchange="this.form.submit()" aria-label="Filter by tenant">
      {% for option in tenant_options %}
        <option value="{{ option.value }}" {% if option.value == tenant_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <select id="issue-assignee-filter" name="assignee" onchange="this.form.submit()" aria-label="Filter by assignee">
      {% for option in assignee_options %}
        <option value="{{ option.value }}" {% if option.value == assignee_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <input type="hidden" name="sort" value="{{ sort_state.key }}">
    <input type="hidden" name="direction" value="{{ sort_state.direction }}">
  </form>

  {% if current_user_name %}
    <a href="{{ url_for('admin.manage_issues', status=status_filter if status_filter != 'all' else None, tenant=tenant_filter if tenant_filter != 'all' else None, assignee='__me__', sort=sort_state.key, direction=sort_state.direction) }}" class="secondary" role="button">
      My Issues
    </a>
  {% endif %}

  <form method="post" action="{{ url_for('admin.refresh_all_issues') }}" class="issue-refresh-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <button type="submit" class="secondary">Refresh All Issues</button>
    <button type="submit" class="secondary outline" name="force_full" value="1" title="Fetch all issues from every provider, ignoring incremental tracking.">
      Force Full Resync
    </button>
  </form>
</div>

{% if issues %}
  <p class="text-muted">
    Showing {{ total_issue_count }} of {{ total_issue_full_count }}
    issue{{ '' if total_issue_full_count == 1 else 's' }}
    {% if status_filter != 'all' %}
      (status: {{ status_filter_label }})
    {% endif %}
    {% if assignee_filter != 'all' %}
      (assignee: {{ assignee_filter_label }})
    {% endif %}.
  </p>

  <div class="table-scroll issues-table">
    <table>
      <thead>
        <tr>
          {% for column in sort_columns %}
            {% set header = sort_headers.get(column.key) %}
            <th scope="col" aria-sort="{{ header.aria_sort }}">
              <a href="{{ header.url }}" class="sort-link{% if header.is_active %} is-active{% endif %}">
                {{ column.label }}
                <span class="sort-indicator" aria-hidden="true">
                  {% if header.is_active %}
                    {% if sort_state.direction == 'asc' %}▲{% else %}▼{% endif %}
                  {% else %}
                    ↕
                  {% endif %}
                </span>
              </a>
            </th>
          {% endfor %}
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
          <tr>
            <td>
              {% if issue.url %}
                <a href="{{ issue.url }}" target="_blank" rel="noopener">{{ issue.external_id }}</a>
              {% else %}
                {{ issue.external_id }}
              {% endif %}
            </td>
            <td>
              <button
                type="button"
                class="issue-title-button issue-detail-toggle"
                data-issue-id="{{ issue.id }}"
                aria-expanded="false"
                aria-controls="issue-detail-{{ issue.id }}"
              >
                {{ issue.title }}
              </button>
            </td>
            <td>
              {% set requires_custom = issue.status and issue.status not in issue.status_choices %}
              <form method="post" action="{{ issue.status_update_endpoint }}" class="issue-status-form issue-status-form--table" data-issue-status-form>
                <select name="status_choice" class="issue-status-select" aria-label="Update status for {{ issue.external_id }}" data-status-select>
                  <option value="" {% if not issue.status %}selected{% endif %}>Unspecified</option>
                  {% for choice in issue.status_choices %}
                    <option value="{{ choice }}" {% if issue.status == choice %}selected{% endif %}>{{ choice }}</option>
                  {% endfor %}
                  <option value="__custom__" {% if requires_custom %}selected{% endif %}>Custom status…</option>
                </select>
                <input
                  type="text"
                  name="status_custom"
                  value="{{ issue.status if requires_custom else '' }}"
                  maxlength="{{ issue_status_max_length }}"
                  class="issue-status-input issue-status-input--custom"
                  placeholder="Enter custom status"
                  data-status-custom
                  {% if not requires_custom %}hidden disabled{% endif %}
                />
                <input type="hidden" name="status" value="{{ issue.status or '' }}" data-status-hidden />
                <input type="hidden" name="next" value="{{ current_view_url }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="secondary outline">Save</button>
              </form>
            </td>
            <td>{{ issue.provider|capitalize }}</td>
            <td>{{ issue.project_name or "Unknown project" }}</td>
            <td>
              {% if issue.tenant_name %}
                <span class="tenant-badge" style="--tenant-color: {{ issue.tenant_color or default_tenant_color }}">
                  <span class="tenant-badge__swatch" aria-hidden="true"></span>
                  {{ issue.tenant_name }}
                </span>
              {% else %}
                <span class="text-muted">Unknown tenant</span>
              {% endif %}
            </td>
            <td>{{ issue.updated_display or "Unknown" }}</td>
            <td>{{ issue.assignee or "Unassigned" }}</td>
            <td>
              {% if issue.labels %}
                {{ issue.labels|join(', ') }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
            <td>
              {% if issue.project_id %}
                <div class="issues-actions">
                  {% if issue.is_pinned %}
                    <form
                      method="post"
                      class="inline-form"
                      action="{{ url_for('projects.unpin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
                    >
                      <input type="hidden" name="next" value="{{ current_view_url }}" />
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="tertiary outline" style="color:#f59e0b;">★ Unpin</button>
                    </form>
                  {% else %}
                    <form
                      method="post"
                      class="inline-form"
                      action="{{ url_for('projects.pin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
                    >
                      <input type="hidden" name="next" value="{{ current_view_url }}" />
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="tertiary outline">☆ Pin</button>
                    </form>
                  {% endif %}
                  {% if issue.codex_target and issue.prepare_endpoint and issue.codex_payload %}
                    <button
                      type="button"
                      class="secondary outline issues-start-codex"
                      data-project-id="{{ issue.project_id }}"
                      data-target="{{ issue.codex_target }}"
                      data-prepare="{{ issue.prepare_endpoint }}"
                      data-context='{{ issue.codex_payload|tojson }}'
                      data-tool="claude"
                      data-command="{{ ai_tool_commands.get('claude') or default_ai_shell }}"
                    >
                      Claude
                    </button>
                    <button
                      type="button"
                      class="secondary outline issues-start-codex"
                      data-project-id="{{ issue.project_id }}"
                      data-target="{{ issue.codex_target }}"
                      data-prepare="{{ issue.prepare_endpoint }}"
                      data-context='{{ issue.codex_payload|tojson }}'
                      data-tool="codex"
                      data-command="{{ ai_tool_commands.get('codex') or default_ai_shell }}"
                    >
                      Codex
                    </button>
                  {% endif %}
                  {% if issue.populate_endpoint %}
                    <button
                      type="button"
                      class="tertiary issues-populate-agents"
                      data-populate="{{ issue.populate_endpoint }}"
                    >
                      Populate AGENTS.override.md
                    </button>
                  {% endif %}
                  {% if issue.can_close and issue.close_endpoint %}
                    <form method="post" action="{{ issue.close_endpoint }}" class="inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="secondary outline">Close Issue</button>
                    </form>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-muted">Unavailable</span>
              {% endif %}
            </td>
          </tr>
          <tr id="issue-detail-{{ issue.id }}" class="issue-detail-row" hidden>
            <td colspan="10">
              <div class="issue-detail">
                <div class="issue-detail__header">
                  <div>
                    <h3 class="issue-card__title">{{ issue.title }}</h3>
                    <p class="text-muted">
                      ID: <code>{{ issue.external_id }}</code>
                    </p>
                  </div>
                  <div class="issue-detail__status">
                    <div>
                      {% if issue.status %}
                        <span class="badge {% if issue.status_key == 'closed' %}success{% elif issue.status_key == 'open' %}secondary{% endif %}">
                          {{ issue.status }}
                        </span>
                      {% else %}
                        <span class="badge">Unspecified</span>
                      {% endif %}
                    </div>
                    {% set requires_custom_detail = issue.status and issue.status not in issue.status_choices %}
                    <form method="post" action="{{ issue.status_update_endpoint }}" class="issue-status-form" data-issue-status-form>
                      <select name="status_choice" class="issue-status-select" aria-label="Update status for {{ issue.external_id }}" data-status-select>
                        <option value="" {% if not issue.status %}selected{% endif %}>Unspecified</option>
                        {% for choice in issue.status_choices %}
                          <option value="{{ choice }}" {% if issue.status == choice %}selected{% endif %}>{{ choice }}</option>
                        {% endfor %}
                        <option value="__custom__" {% if requires_custom_detail %}selected{% endif %}>Custom status…</option>
                      </select>
                      <input
                        type="text"
                        name="status_custom"
                        value="{{ issue.status if requires_custom_detail else '' }}"
                        maxlength="{{ issue_status_max_length }}"
                        class="issue-status-input issue-status-input--custom"
                        placeholder="Enter custom status"
                        data-status-custom
                        {% if not requires_custom_detail %}hidden disabled{% endif %}
                      />
                      <input type="hidden" name="status" value="{{ issue.status or '' }}" data-status-hidden />
                      <input type="hidden" name="next" value="{{ current_view_url }}" />
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="secondary outline">Save</button>
                    </form>
                    {% if issue.url %}
                      <a href="{{ issue.url }}" target="_blank" rel="noopener">Open in tracker</a>
                    {% endif %}
                  </div>
                </div>
                <dl class="issue-detail__meta">
                  <div>
                    <dt>Provider</dt>
                    <dd>{{ issue.provider|capitalize }}</dd>
                  </div>
                  <div>
                    <dt>Project</dt>
                    <dd>{{ issue.project_name or "Unknown project" }}</dd>
                  </div>
                  <div>
                    <dt>Tenant</dt>
                    <dd>
                      {% if issue.tenant_name %}
                        <span class="tenant-badge" style="--tenant-color: {{ issue.tenant_color or default_tenant_color }}">
                          <span class="tenant-badge__swatch" aria-hidden="true"></span>
                          {{ issue.tenant_name }}
                        </span>
                      {% else %}
                        <span class="text-muted">Unknown tenant</span>
                      {% endif %}
                    </dd>
                  </div>
                  <div>
                    <dt>Last Updated</dt>
                    <dd>{{ issue.updated_display or "Unknown" }}</dd>
                  </div>
                  <div>
                    <dt>Assignee</dt>
                    <dd>{{ issue.assignee or "Unassigned" }}</dd>
                  </div>
                  <div>
                    <dt>Labels</dt>
                    <dd>
                      {% if issue.labels %}
                        {{ issue.labels|join(', ') }}
                      {% else %}
                        <span class="text-muted">None</span>
                      {% endif %}
                    </dd>
                  </div>
                </dl>
                <div>
                  <h4>Issue Description</h4>
                  <div class="issue-detail__description">
                    {% if issue.description_available %}
                      {{ issue.description|render_issue_content }}
                    {% else %}
                      <span class="text-muted">{{ issue.description_fallback }}</span>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <h4>Recent Comments</h4>
                  {% if issue.comment_count %}
                    <ul class="issue-comments">
                      {% for comment in issue.comments %}
                        <li>
                          <small>
                            {% if comment.author %}
                              {{ comment.author }}
                            {% else %}
                              <span class="text-muted">Unknown author</span>
                            {% endif %}
                            {% if comment.created_display %}
                              • {{ comment.created_display }}
                            {% endif %}
                            {% if comment.url %}
                              • <a href="{{ comment.url }}" target="_blank" rel="noopener">View</a>
                            {% endif %}
                          </small>
                          <div class="issue-comment__body">
                            {{ comment.body|render_issue_content }}
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted">No comments cached.</p>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="issues-card-list">
    {% for issue in issues %}
      <article class="issue-card">
        <header class="issue-card__header">
          <div>
            <h3>
              {% if issue.url %}
                <a href="{{ issue.url }}" target="_blank" rel="noopener">{{ issue.external_id }}</a>
              {% else %}
                {{ issue.external_id }}
              {% endif %}
            </h3>
            <p class="issue-card__title">{{ issue.title }}</p>
          </div>
          <div>
            {% if issue.status %}
              <span class="badge {% if issue.status_key == 'closed' %}success{% elif issue.status_key == 'open' %}secondary{% endif %}">
                {{ issue.status }}
              </span>
            {% else %}
              <span class="badge">Unspecified</span>
            {% endif %}
          </div>
        </header>
        <dl class="issue-card__meta">
          <div class="issue-card__meta-item">
            <dt>Provider</dt>
            <dd>{{ issue.provider|capitalize }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Project</dt>
            <dd>{{ issue.project_name or "Unknown project" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Tenant</dt>
            <dd>
              {% if issue.tenant_name %}
                <span class="tenant-badge" style="--tenant-color: {{ issue.tenant_color or default_tenant_color }}">
                  <span class="tenant-badge__swatch" aria-hidden="true"></span>
                  {{ issue.tenant_name }}
                </span>
              {% else %}
                <span class="text-muted">Unknown tenant</span>
              {% endif %}
            </dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Updated</dt>
            <dd>{{ issue.updated_display or "Unknown" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Assignee</dt>
            <dd>{{ issue.assignee or "Unassigned" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Labels</dt>
            <dd>
              {% if issue.labels %}
                {{ issue.labels|join(', ') }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </dd>
          </div>
        </dl>
        <details class="issue-card__details">
          <summary>View details</summary>
          <div class="issue-card__description">
            {% if issue.description_available %}
              {{ issue.description|render_issue_content }}
            {% else %}
              <span class="text-muted">{{ issue.description_fallback }}</span>
            {% endif %}
          </div>
          {% if issue.url %}
            <p><a href="{{ issue.url }}" target="_blank" rel="noopener">Open in tracker</a></p>
          {% endif %}
        </details>
        {% if issue.project_id %}
          <div class="issues-actions">
            {% if issue.is_pinned %}
              <form
                method="post"
                class="inline-form"
                action="{{ url_for('projects.unpin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
              >
                <input type="hidden" name="next" value="{{ current_view_url }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="tertiary outline" style="color:#f59e0b;">★ Unpin</button>
              </form>
            {% else %}
              <form
                method="post"
                class="inline-form"
                action="{{ url_for('projects.pin_issue', project_id=issue.project_id, issue_id=issue.id) }}"
              >
                <input type="hidden" name="next" value="{{ current_view_url }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="tertiary outline">☆ Pin</button>
              </form>
            {% endif %}
            {% if issue.codex_target and issue.prepare_endpoint and issue.codex_payload %}
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
                data-tool="claude"
                data-command="{{ ai_tool_commands.get('claude') or default_ai_shell }}"
              >
                Claude
              </button>
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
                data-tool="codex"
                data-command="{{ ai_tool_commands.get('codex') or default_ai_shell }}"
              >
                Codex
              </button>
            {% endif %}
            {% if issue.populate_endpoint %}
              <button
                type="button"
                class="tertiary issues-populate-agents"
                data-populate="{{ issue.populate_endpoint }}"
              >
                Populate AGENTS.override.md
              </button>
            {% endif %}
            {% if issue.can_close and issue.close_endpoint %}
              <form method="post" action="{{ issue.close_endpoint }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="secondary outline">Close Issue</button>
              </form>
            {% endif %}
          </div>
        {% endif %}
      </article>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">No issues found for the selected filter.</p>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const detailButtons = document.querySelectorAll('.issue-detail-toggle');
    detailButtons.forEach(button => {
      button.addEventListener('click', () => {
        const issueId = button.dataset.issueId;
        if (!issueId) {
          return;
        }
        const detailRow = document.getElementById(`issue-detail-${issueId}`);
        if (!detailRow) {
          return;
        }
        const isHidden = detailRow.hasAttribute('hidden');
        if (isHidden) {
          detailRow.removeAttribute('hidden');
          button.setAttribute('aria-expanded', 'true');
        } else {
          detailRow.setAttribute('hidden', '');
          button.setAttribute('aria-expanded', 'false');
        }
      });
    });

    const codexButtons = document.querySelectorAll('.issues-start-codex');
    const populateButtons = document.querySelectorAll('.issues-populate-agents');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenValue = csrfMeta ? csrfMeta.getAttribute('content') : '';

    codexButtons.forEach(button => {
      button.addEventListener('click', () => {
        const projectId = button.dataset.projectId;
        const target = button.dataset.target;
        const prepareEndpoint = button.dataset.prepare;
        const payloadRaw = button.dataset.context;
        const toolOverride = button.dataset.tool;
        const commandOverride = button.dataset.command;
        if (!projectId || !target || !prepareEndpoint || !payloadRaw) {
          return;
        }

        let payload;
        try {
          payload = JSON.parse(payloadRaw);
        } catch (error) {
          return;
        }

        // Override the tool if specified on the button
        if (toolOverride) {
          payload.tool = toolOverride;
          if (commandOverride) {
            payload.command = commandOverride;
          }
        }

        const storageKey = `aiops-session-context-${projectId}`;

        const finalize = (context) => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(context));
          } catch (error) {
            /* ignore storage errors */
          }
          window.location.href = target;
        };

        const preparePayload = {};
        if (payload.tool) {
          preparePayload.tool = payload.tool;
        }

        fetch(prepareEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify(preparePayload),
        })
          .then((response) => (
            response.ok
              ? response.json()
              : response.json().then((data) => Promise.reject(data))
          ))
          .then((data) => {
            finalize({
              prompt: data.prompt,
              command: data.command,
              tool: data.tool || payload.tool,
              autoStart: true,
              tmuxTarget: data.tmux_target || null,
            });
          })
          .catch(() => {
            finalize({
              prompt: payload.prompt,
              command: payload.command,
              tool: payload.tool,
              autoStart: payload.autoStart,
              tmuxTarget: payload.tmuxTarget || null,
            });
          });
      });
    });

    populateButtons.forEach(button => {
      button.addEventListener('click', () => {
        const endpoint = button.dataset.populate;
        if (!endpoint) {
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Populating...';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then(response => (
            response.ok
              ? response.json()
              : response.json().then(data => Promise.reject(data))
          ))
          .then(data => {
            button.textContent = 'AGENTS.override.md updated';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2000);
            if (data && data.tracked_path) {
              console.info(`Updated agent context at ${data.tracked_path}`);
            }
          })
          .catch(error => {
            console.error('Failed to populate AGENTS.override.md', error);
            button.textContent = 'Update failed';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2500);
          });
      });
    });

    const statusForms = document.querySelectorAll('[data-issue-status-form]');
    statusForms.forEach(form => {
      const select = form.querySelector('[data-status-select]');
      const customInput = form.querySelector('[data-status-custom]');
      const hiddenInput = form.querySelector('[data-status-hidden]');
      if (!select || !hiddenInput) {
        return;
      }

      const syncState = () => {
        const choice = select.value;
        if (choice === '__custom__') {
          if (customInput) {
            customInput.removeAttribute('hidden');
            customInput.removeAttribute('disabled');
            hiddenInput.value = customInput.value.trim();
            customInput.focus();
          } else {
            hiddenInput.value = '';
          }
        } else {
          if (customInput) {
            customInput.value = '';
            customInput.setAttribute('hidden', '');
            customInput.setAttribute('disabled', '');
          }
          hiddenInput.value = choice;
        }
      };

      select.addEventListener('change', syncState);
      if (customInput) {
        customInput.addEventListener('input', () => {
          if (select.value === '__custom__') {
            hiddenInput.value = customInput.value.trim();
          }
        });
      }
      form.addEventListener('submit', () => {
        if (select.value === '__custom__' && customInput) {
          hiddenInput.value = customInput.value.trim();
        }
      });

      syncState();
    });
  })();
</script>
{% endblock %}
