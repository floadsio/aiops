{% extends "base.html" %}
{% block title %}Admin Settings | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .settings-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    width: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .settings-category {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .settings-category h2 {
    font-size: 1.5rem;
    margin: 0 0 0.5rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgba(148, 163, 184, 0.3);
  }
  [data-theme="dark"] .settings-category h2 {
    border-bottom-color: rgba(148, 163, 184, 0.2);
  }
  .settings-grid {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    width: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .settings-grid-3 {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    width: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  @media (min-width: 1024px) {
    .settings-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
    }
  }
  .settings-card {
    padding: 1.5rem;
    border-radius: 1.2rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.92);
    width: 100%;
    box-sizing: border-box;
  }
  .settings-card-full {
    width: 100%;
  }
  [data-theme="dark"] .settings-card {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .settings-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
  }
  .settings-card p {
    margin-top: 0;
    margin-bottom: 0.9rem;
  }
  .settings-card form {
    margin: 0;
  }
  .settings-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .settings-actions button {
    min-width: fit-content;
    white-space: nowrap;
  }
  .settings-actions label {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 0;
    width: 100%;
  }
  .settings-actions select,
  .settings-actions input[type="text"],
  .settings-actions input[type="number"],
  .settings-actions input[type="password"] {
    width: 100%;
  }
  .settings-actions .checkbox-inline {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.4rem;
    width: auto;
  }
  .settings-actions .form-helper {
    font-size: 0.85rem;
  }
  .user-table {
    width: 100%;
  }
  .user-table td,
  .user-table th {
    vertical-align: top;
  }
  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .user-actions details {
    margin-bottom: 0.35rem;
  }
  .user-edit-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .user-edit-form label {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .user-actions form {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .user-actions input[type="password"] {
    max-width: 220px;
  }
  .user-meta {
    font-size: 0.9rem;
    color: #475569;
  }
  .ai-tool-actions {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }
  .ai-tool-action form {
    margin: 0;
  }
  .ai-tool-command {
    font-size: 0.85rem;
    color: #475569;
  }
  [data-theme="dark"] .ai-tool-command {
    color: rgba(226, 232, 240, 0.75);
  }
  .ai-tool-command code {
    display: inline-block;
    margin-left: 0.25rem;
  }
  [data-theme="dark"] .user-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .log-output {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 1rem;
    background: rgba(241, 245, 249, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
    max-height: 20rem;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
  [data-theme="dark"] .log-output {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  @media (max-width: 900px) {
    .settings-card {
      padding: 1.1rem;
    }
    .settings-actions {
      flex-direction: column;
      align-items: stretch;
    }
    .settings-actions label,
    .settings-actions .checkbox-inline {
      width: 100%;
    }
    .settings-actions button {
      width: 100% !important;
      min-width: 100%;
      max-width: 100%;
      justify-content: center;
      box-sizing: border-box;
    }
    .settings-actions .form-helper {
      width: 100%;
    }
    .log-output {
      max-width: 100%;
      overflow-x: auto;
    }
  }
  @media (max-width: 480px) {
    .settings-actions button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  }
</style>
{% endblock %}
{% block content %}
<h1>Admin Settings</h1>

<div class="settings-container">
  <section class="settings-category">
    <h2>System Operations</h2>
    <div class="settings-grid-3">
  <article class="settings-card">
    <h3>System Update</h3>
    <p>Run <code>scripts/update.sh</code> without shell access. Optionally request a restart once the update completes.</p>
    {% if restart_command %}
      <p class="text-muted">Configured restart command: <code>{{ restart_command }}</code></p>
    {% else %}
      <p class="text-muted">No restart command configured. Set <code>UPDATE_RESTART_COMMAND</code> in your environment to automatically restart the service.</p>
    {% endif %}
    <form method="post" action="{{ url_for('admin.run_system_update') }}">
      {{ update_form.hidden_tag() }}
      <div class="settings-actions">
        <label>
          {{ update_form.branch.label }}
          {{ update_form.branch() }}
        </label>
        <label class="checkbox-inline" style="width:auto;">
          {{ update_form.restart() }}
          <span>Restart application after update</span>
        </label>
        <button type="submit" class="secondary">Run update script</button>
        <span class="text-muted form-helper">Set AIOPS_UPDATE_BRANCH for this run (default matches current branch).</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h3>Quick Branch Switch</h3>
    <p>Pick a branch and run the update script with restart in one step. Use this when you need to jump between release trains quickly.</p>
    <form method="post" action="{{ url_for('admin.quick_branch_switch') }}">
      {{ quick_branch_form.hidden_tag() }}
      {{ quick_branch_form.next }}
      <div class="settings-actions">
        <label>
          {{ quick_branch_form.branch.label }}
          {{ quick_branch_form.branch() }}
        </label>
        <button type="submit" class="secondary">Switch & Restart</button>
        <span class="text-muted form-helper">Runs the same update script and immediately triggers the configured restart command.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h3>tmux Sessions</h3>
    <p>Ensure each project has an active tmux window and remove orphaned project windows from the shared session.</p>
    <p class="text-muted">Creates missing windows (matching the DB) and prunes stale `-p<ID>` tmux windows.</p>
    <form method="post" action="{{ url_for('admin.resync_tmux_sessions') }}">
      {{ tmux_resync_form.hidden_tag() }}
      <div class="settings-actions">
        <button type="submit" class="secondary">Resync tmux windows</button>
        <span class="text-muted form-helper">Safe to run after importing databases or pruning projects.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h3>Database Schema</h3>
    <p>Apply pending Alembic migrations without shell access. Use this after pulling new releases that add columns or tables.</p>
    <p class="text-muted">Runs <code>flask --app manage.py db upgrade</code> inside the project virtualenv.</p>
    <form method="post" action="{{ url_for('admin.run_database_migrations') }}">
      {{ migration_form.hidden_tag() }}
      <div class="settings-actions">
        <button type="submit" class="secondary">Run migrations</button>
        <span class="text-muted form-helper">Outputs appear below as flash messages.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h3>Instance Permissions</h3>
    <p>Check and fix filesystem permissions on crucial aiops folders to ensure proper multi-user access.</p>
    <p class="text-muted">Verifies that repos, configs, and database are writable by the syseng group. Uses sudo to fix issues.</p>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <form method="post" action="{{ url_for('admin.check_instance_permissions') }}" style="margin: 0;">
        {{ permissions_check_form.hidden_tag() }}
        <button type="submit" class="secondary">Check Permissions</button>
      </form>
      <form method="post" action="{{ url_for('admin.fix_instance_permissions') }}" style="margin: 0;">
        {{ permissions_fix_form.hidden_tag() }}
        <button type="submit" class="primary">Fix Permissions</button>
      </form>
    </div>
    <span class="text-muted form-helper" style="display: block; margin-top: 0.5rem;">Run check first to see issues; fix applies corrections using sudo as syseng user.</span>
  </article>
    </div>

    <div class="settings-grid">
  <article class="settings-card settings-card-full">
    <h3>Database Backups</h3>
    <p>Create, restore, and manage database backups. Backups include the full SQLite database with all settings and data.</p>
    <p class="text-muted">Backup files are stored in <code>instance/backups/</code> and can be downloaded via the API or CLI.</p>

    <form method="post" action="{{ url_for('admin.create_backup_web') }}">
      {{ backup_create_form.hidden_tag() }}
      <div class="settings-actions">
        <label>
          {{ backup_create_form.description.label }}
          {{ backup_create_form.description() }}
        </label>
        <button type="submit" class="secondary">Create Backup</button>
        <span class="text-muted form-helper">Creates a timestamped backup of the current database state.</span>
      </div>
    </form>

    {% if backups %}
      <h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Existing Backups</h4>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th scope="col">Filename</th>
              <th scope="col">Description</th>
              <th scope="col">Size</th>
              <th scope="col">Created</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for backup in backups %}
              {% set restore_form = backup_restore_forms[backup.id] %}
              {% set delete_form = backup_delete_forms[backup.id] %}
              <tr>
                <th scope="row"><code>{{ backup.filename }}</code></th>
                <td>{{ backup.description or "-" }}</td>
                <td>{{ "%.2f"|format(backup.size_bytes / 1024 / 1024) }} MB</td>
                <td><small>{{ backup.created_at }}</small></td>
                <td>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <a href="{{ url_for('admin.download_backup_web', backup_id=backup.id) }}" class="secondary outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem; text-decoration: none; display: inline-block;">Download</a>
                    <form method="post" action="{{ url_for('admin.restore_backup_web', backup_id=backup.id) }}" style="margin: 0;" onsubmit="return confirm('WARNING: This will replace the current database! Are you sure you want to restore from this backup?');">
                      {{ restore_form.hidden_tag() }}
                      <button type="submit" class="secondary outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem;">Restore</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_backup_web', backup_id=backup.id) }}" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this backup?');">
                      {{ delete_form.hidden_tag() }}
                      <button type="submit" class="secondary outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem;">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted" style="margin-top: 1rem;">No backups found. Create your first backup above.</p>
    {% endif %}
  </article>
    </div>
  </section>

  {% if ai_tool_cards %}
  <section class="settings-category">
    <h2>AI Tool Maintenance</h2>
    <div class="settings-grid-3">
      {% for card in ai_tool_cards %}
      <article class="settings-card">
        <h3>{{ card.title }}</h3>
        <p>{{ card.description }}</p>
        {% if card.versions %}
        <div class="ai-tool-version-grid">
          <div>
            <div class="ai-tool-version-label">Installed</div>
            {% if card.versions.installed %}
              <code>{{ card.versions.installed }}</code>
            {% elif card.versions.installed_error %}
              <span class="text-muted">{{ card.versions.installed_error }}</span>
            {% else %}
              <span class="text-muted">Unknown</span>
            {% endif %}
          </div>
          <div>
            <div class="ai-tool-version-label">Available</div>
            {% if card.versions.latest %}
              <code>{{ card.versions.latest }}</code>
            {% elif card.versions.latest_error %}
              <span class="text-muted">{{ card.versions.latest_error }}</span>
            {% else %}
              <span class="text-muted">Unknown</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        <div class="ai-tool-actions">
          {% for action in card.actions %}
          <div class="ai-tool-action">
            <form method="post" action="{{ url_for('admin.run_ai_tool_update_command', tool=card.key) }}">
              {{ action.form.hidden_tag() }}
              <button type="submit" class="secondary">{{ action.label }}</button>
            </form>
            <div class="ai-tool-command">
              {{ action.helper }}
              {% if action.command %}
                <code>{{ action.command }}</code>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </article>
      {% endfor %}
    </div>
  </section>
  {% endif %}

    <section class="settings-category">
    <h2>User Management</h2>
    <div class="settings-grid">
  <article class="settings-card settings-card-full">
    <h3>User Accounts</h3>
    <p>Create and manage application users. Promote additional administrators so critical tasks are not blocked on a single account.</p>
    <details>
      <summary><strong>Create user</strong></summary>
      <form method="post">
        {{ create_user_form.hidden_tag() }}
        <label>
          {{ create_user_form.name.label }}
          {{ create_user_form.name() }}
          {% for error in create_user_form.name.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.email.label }}
          {{ create_user_form.email(type="email") }}
          {% for error in create_user_form.email.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.password.label }}
          {{ create_user_form.password(type="password", autocomplete="new-password") }}
          {% for error in create_user_form.password.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label class="checkbox">
          {{ create_user_form.is_admin() }}
          {{ create_user_form.is_admin.label }}
        </label>
        <button type="submit" class="secondary">{{ create_user_form.submit.label.text }}</button>
      </form>
    </details>

    <h3>Existing users</h3>
    {% if users %}
      <div class="table-scroll">
        <table class="user-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              {% set toggle_form = user_toggle_forms[user.id] %}
              {% set reset_form = user_reset_forms[user.id] %}
              {% set delete_form = user_delete_forms[user.id] %}
              {% set update_form = user_update_forms[user.id] %}
              <tr>
                <th scope="row">
                  {{ user.name or "Unnamed user" }}
                  <div class="user-meta">#{{ user.id }}</div>
                </th>
                <td><code>{{ user.email }}</code></td>
                <td>
                  {% if user.is_admin %}
                    <span class="badge success">Administrator</span>
                  {% else %}
                    <span class="badge">Standard</span>
                  {% endif %}
                  {% if current_user.id == user.id %}
                    <div class="user-meta">(You)</div>
                  {% endif %}
                </td>
                <td>
                  <div class="user-actions">
                    <details>
                      <summary>Edit details</summary>
                      <form method="post" action="{{ url_for('admin.update_user', user_id=user.id) }}" class="user-edit-form">
                        {{ update_form.hidden_tag() }}
                        <label>
                          {{ update_form.name.label }}
                          {{ update_form.name() }}
                        </label>
                        <label>
                          {{ update_form.email.label }}
                          {{ update_form.email(type="email") }}
                        </label>
                        <label>
                          {{ update_form.linux_username.label }}
                          {{ update_form.linux_username() }}
                        </label>
                        <label>
                          AIOPS CLI URL
                          <input type="text" name="aiops_cli_url" value="{{ user.aiops_cli_url or '' }}" placeholder="http://localhost:5000">
                          <small>URL for AIOPS CLI (injected into AI tool sessions)</small>
                        </label>
                        <label>
                          AIOPS CLI API Key
                          <input type="password" name="aiops_cli_api_key" value="{{ user.aiops_cli_api_key or '' }}" placeholder="aiops_...">
                          <small>API key for AIOPS CLI (injected as AIOPS_API_KEY in tmux)</small>
                        </label>
                        <label class="checkbox">
                          {{ update_form.is_admin() }}
                          {{ update_form.is_admin.label }}
                        </label>
                        <button type="submit" class="secondary">{{ update_form.submit.label.text }}</button>
                      </form>
                    </details>
                    <form method="post" action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}">
                      {{ toggle_form.hidden_tag() }}
                      <button type="submit" class="secondary">
                        {% if user.is_admin %}Revoke admin{% else %}Promote to admin{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('admin.reset_user_password', user_id=user.id) }}">
                      {{ reset_form.hidden_tag() }}
                      {{ reset_form.password(type="password", placeholder="New password", autocomplete="new-password") }}
                      <button type="submit" class="secondary outline">Reset password</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
                      {{ delete_form.hidden_tag() }}
                      <button type="submit" class="secondary outline">Delete user</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No users found.</p>
    {% endif %}
  </article>

    </div>
  </section>

  <section class="settings-category">
    <h2>API Keys</h2>
    <div class="settings-grid">
      <article class="settings-card settings-card-full">
        <h3>API Key Management</h3>
        <p>Create and manage API keys for programmatic access to the aiops REST API. Use these keys with the <code>aiops</code> CLI or for custom integrations.</p>

        <details>
          <summary><strong>Create new API key</strong></summary>
          <form method="post" action="{{ url_for('admin.create_api_key_web') }}">
            {{ api_key_create_form.hidden_tag() }}
            <label>
              {{ api_key_create_form.name.label }}
              {{ api_key_create_form.name() }}
              {% for error in api_key_create_form.name.errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </label>
            <label>
              {{ api_key_create_form.scopes.label }}
              {{ api_key_create_form.scopes() }}
              <small>Select the level of access this key will have</small>
              {% for error in api_key_create_form.scopes.errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </label>
            <label>
              {{ api_key_create_form.expires_days.label }}
              {{ api_key_create_form.expires_days() }}
              <small>When the key should expire (optional)</small>
              {% for error in api_key_create_form.expires_days.errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </label>
            <button type="submit" class="secondary">{{ api_key_create_form.submit.label.text }}</button>
          </form>
        </details>

        <h3>Your API Keys</h3>
        {% if api_keys %}
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">Key Prefix</th>
                  <th scope="col">Scopes</th>
                  <th scope="col">Status</th>
                  <th scope="col">Created</th>
                  <th scope="col">Last Used</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for key in api_keys %}
                  {% set revoke_form = api_key_revoke_forms[key.id] %}
                  <tr>
                    <th scope="row">{{ key.name }}</th>
                    <td><code>{{ key.key_prefix }}...</code></td>
                    <td>
                      {% for scope in key.scopes %}
                        <span class="badge">{{ scope }}</span>
                      {% endfor %}
                    </td>
                    <td>
                      {% if key.is_active %}
                        {% if key.expires_at %}
                          {% if key.expires_at > now %}
                            <span class="badge success">Active</span>
                          {% else %}
                            <span class="badge">Expired</span>
                          {% endif %}
                        {% else %}
                          <span class="badge success">Active</span>
                        {% endif %}
                      {% else %}
                        <span class="badge">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <small>{{ key.created_at.strftime('%Y-%m-%d %H:%M UTC') if key.created_at else 'N/A' }}</small>
                    </td>
                    <td>
                      {% if key.last_used_at %}
                        <small>{{ key.last_used_at.strftime('%Y-%m-%d %H:%M UTC') }}</small>
                      {% else %}
                        <small class="text-muted">Never</small>
                      {% endif %}
                    </td>
                    <td>
                      <form method="post" action="{{ url_for('admin.revoke_api_key', key_id=key.id) }}" style="margin: 0;">
                        {{ revoke_form.hidden_tag() }}
                        <button type="submit" class="secondary outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem;">Revoke</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No API keys found. Create one to get started with the REST API.</p>
        {% endif %}

        <details style="margin-top: 1.5rem;">
          <summary><strong>How to use API keys</strong></summary>
          <div style="margin-top: 1rem;">
            <p>Use your API key in requests with either the <code>Authorization</code> header or <code>X-API-Key</code> header:</p>
            <pre style="background: rgba(241, 245, 249, 0.9); padding: 1rem; border-radius: 0.5rem; overflow-x: auto;"><code># Using Authorization header
curl -H "Authorization: Bearer aiops_your_key_here" http://localhost:5000/api/v1/issues

# Using X-API-Key header
curl -H "X-API-Key: aiops_your_key_here" http://localhost:5000/api/v1/issues</code></pre>
            <p>Explore the full API documentation at <a href="/api/docs" target="_blank">/api/docs</a></p>
          </div>
        </details>
      </article>
    </div>
  </section>

  <section class="settings-category">
    <h2>Personal Integration Credentials</h2>
    <div class="settings-grid">
      <article class="settings-card settings-card-full">
        <h3>Your Personal Tokens</h3>
        <p>Configure your personal GitLab/GitHub/Jira tokens to use your own account when creating issues and commenting via the CLI, instead of using the aiops bot's token.</p>
        <p class="text-muted">When set, your comments and issues will appear under your personal account, not the bot.</p>

        <details>
          <summary><strong>Add personal token</strong></summary>
          <form method="post" action="{{ url_for('admin.create_user_credential_web') }}">
            {{ user_credential_create_form.hidden_tag() }}
            <label>
              {{ user_credential_create_form.integration_id.label }}
              {{ user_credential_create_form.integration_id() }}
              <small>Select the integration you want to override with your personal token</small>
              {% for error in user_credential_create_form.integration_id.errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </label>
            <label>
              {{ user_credential_create_form.api_token.label }}
              {{ user_credential_create_form.api_token(type="password", placeholder="glpat-xxx or ghp_xxx") }}
              <small>Your personal access token from GitLab/GitHub/Jira</small>
              {% for error in user_credential_create_form.api_token.errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </label>
            <button type="submit" class="secondary">{{ user_credential_create_form.submit.label.text }}</button>
          </form>
        </details>

        <h3>Your Configured Credentials</h3>
        {% if user_credentials %}
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th scope="col">Integration</th>
                  <th scope="col">Provider</th>
                  <th scope="col">Created</th>
                  <th scope="col">Last Updated</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cred in user_credentials %}
                  {% set delete_form = user_credential_delete_forms[cred.id] %}
                  <tr>
                    <th scope="row">{{ cred.integration.name }}</th>
                    <td><span class="badge">{{ cred.integration.provider }}</span></td>
                    <td>
                      <small>{{ cred.created_at.strftime('%Y-%m-%d %H:%M UTC') if cred.created_at else 'N/A' }}</small>
                    </td>
                    <td>
                      <small>{{ cred.updated_at.strftime('%Y-%m-%d %H:%M UTC') if cred.updated_at else 'N/A' }}</small>
                    </td>
                    <td>
                      <form method="post" action="{{ url_for('admin.delete_user_credential', credential_id=cred.id) }}" style="margin: 0;">
                        {{ delete_form.hidden_tag() }}
                        <button type="submit" class="secondary outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem;" onclick="return confirm('Are you sure you want to remove this personal token?');">Remove</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No personal tokens configured. Add one above to use your own account for issue operations.</p>
        {% endif %}

        <details style="margin-top: 1.5rem;">
          <summary><strong>How to create personal access tokens</strong></summary>
          <div style="margin-top: 1rem;">
            <h4>GitLab</h4>
            <ol>
              <li>Visit: <code>https://your-gitlab.com/-/user_settings/personal_access_tokens</code></li>
              <li>Create token with <code>api</code> scope</li>
              <li>Copy the token (starts with <code>glpat-</code>)</li>
              <li>Add it here using the form above</li>
            </ol>

            <h4>GitHub</h4>
            <ol>
              <li>Visit: <a href="https://github.com/settings/tokens" target="_blank">Settings → Developer settings → Personal access tokens</a></li>
              <li>Create token (classic) with <code>repo</code> scope</li>
              <li>Copy the token (starts with <code>ghp_</code>)</li>
              <li>Add it here using the form above</li>
            </ol>

            <h4>Jira</h4>
            <ol>
              <li>Visit: <code>https://id.atlassian.com/manage-profile/security/api-tokens</code></li>
              <li>Create API token</li>
              <li>Copy the token</li>
              <li>Add it here using the form above</li>
            </ol>

            <p><strong>Required permissions:</strong></p>
            <ul>
              <li><strong>GitLab:</strong> <code>api</code> scope (full API access)</li>
              <li><strong>GitHub:</strong> <code>repo</code> scope (repository access)</li>
              <li><strong>Jira:</strong> API token with write access to issues</li>
            </ul>
          </div>
        </details>
      </article>
    </div>
  </section>

  <!-- Global Agent Context -->
  <section>
    <div>
      <article>
        <header>
          <h3>Global Agent Context</h3>
        </header>

        <p>
          Define global AGENTS.md content that will be included at the top of all AGENTS.override.md files.
          If no global context is set, the system falls back to reading AGENTS.md from each repository.
        </p>

        {% if global_agent_context %}
          <p>
            <strong>Status:</strong> <span class="badge success">Global context active</span><br>
            <small class="text-muted">
              Last updated: {{ global_agent_context.updated_at.strftime('%Y-%m-%d %H:%M UTC') if global_agent_context.updated_at else 'N/A' }}
              {% if global_agent_context.updated_by %}
                by {{ global_agent_context.updated_by.name }}
              {% endif %}
            </small>
          </p>
        {% else %}
          <p>
            <strong>Status:</strong> <span class="badge">No global context</span><br>
            <small class="text-muted">System uses AGENTS.md from repository</small>
          </p>
        {% endif %}

        <form method="post" action="{{ url_for('admin.save_global_agent_context') }}" style="margin-top: 1.5rem;">
          {{ global_agent_context_form.hidden_tag() }}
          <div class="form-group">
            {{ global_agent_context_form.content.label }}
            {{ global_agent_context_form.content(class="form-control") }}
            {% if global_agent_context_form.content.errors %}
              <small class="error">{{ global_agent_context_form.content.errors[0] }}</small>
            {% endif %}
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            {{ global_agent_context_form.submit(class="primary") }}
            {% if global_agent_context %}
              <form method="post" action="{{ url_for('admin.clear_global_agent_context') }}" style="margin: 0;">
                {{ global_agent_context_clear_form.hidden_tag() }}
                <button type="submit" class="secondary" onclick="return confirm('Are you sure you want to clear the global agent context? The system will revert to using AGENTS.md from repositories.');">
                  Clear Global Context
                </button>
              </form>
            {% endif %}
          </div>
        </form>

        <details style="margin-top: 1.5rem;">
          <summary><strong>About Global Agent Context</strong></summary>
          <div style="margin-top: 1rem;">
            <p>The global agent context allows you to define content that appears in all AGENTS.override.md files, ensuring consistent instructions across all AI agent sessions.</p>
            <ul>
              <li><strong>Priority:</strong> Database global context takes precedence over repository AGENTS.md files</li>
              <li><strong>CLI Access:</strong> Use <code>aiops agents global get/set/clear</code> commands</li>
              <li><strong>API Access:</strong> Available at <code>/api/v1/agents/global</code></li>
            </ul>
          </div>
        </details>
      </article>
    </div>
  </section>

  <section class="settings-category">
    <h2>System Logs</h2>
    <div class="settings-grid">
  <article class="settings-card settings-card-full">
    <h3>Application Logs</h3>
    {% if log_file %}
      <p>Inspect recent entries from <code>{{ log_file }}</code> to troubleshoot background activity.</p>
    {% else %}
      <p>Inspect recent log output to troubleshoot background activity.</p>
    {% endif %}
    <div class="settings-actions">
      <label class="checkbox-inline" for="log-line-count">
        <span>Lines</span>
        <input type="number" id="log-line-count" min="50" max="2000" value="400" />
      </label>
      <button type="button" class="secondary" id="refresh-log">Refresh logs</button>
      <span class="text-muted form-helper" id="log-status" aria-live="polite"></span>
    </div>
    <pre id="app-log-output" class="log-output" tabindex="0">Loading…</pre>
  </article>
    </div>
  </section>
</div>
<script>
  (function () {
    const refreshButton = document.getElementById('refresh-log');
    const output = document.getElementById('app-log-output');
    const status = document.getElementById('log-status');
    const lineInput = document.getElementById('log-line-count');
    if (!refreshButton || !output) {
      return;
    }

    const fetchLogs = () => {
      const lines = Math.max(50, Math.min(2000, parseInt(lineInput?.value || '100', 10) || 100));
      if (status) {
        status.textContent = 'Fetching…';
      }
      fetch(`/admin/settings/logs?lines=${lines}`, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(payload => {
          if (!payload.ok) {
            throw new Error(payload.error || 'Unable to read logs.');
          }
          output.textContent = payload.content || '(no log entries)';
          if (status) {
            status.textContent = payload.truncated ? `Showing last ${lines} lines (truncated).` : `Showing up to ${lines} lines.`;
          }
        })
        .catch(error => {
          output.textContent = `Error loading logs: ${error.message}`;
          if (status) {
            status.textContent = 'Failed to fetch logs';
          }
        });
    };

    refreshButton.addEventListener('click', fetchLogs);
    // Load logs on demand instead of automatically for better page load performance
    output.textContent = 'Click "Refresh Logs" to load application logs';
  })();

</script>
{% endblock %}
