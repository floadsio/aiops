{% extends "base.html" %}
{% block title %}SSH Keys | aiops Control Panel{% endblock %}
{% block content %}
<h1>SSH Keys</h1>
<h2>Registered Keys</h2>
<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Fingerprint</th>
        <th>Tenant</th>
        <th>Added</th>
        <th>Storage</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for key in ssh_keys %}
      <tr>
        <td>{{ key.name }}</td>
        <td><code>{{ key.fingerprint }}</code></td>
        <td>
          {% if key.tenant %}
            <span class="tenant-badge" style="--tenant-color: {{ key.tenant.color or default_tenant_color }}">
              <span class="tenant-badge__swatch" aria-hidden="true"></span>
              {{ key.tenant.name }}
            </span>
          {% else %}
            <span class="text-muted">Unassigned</span>
          {% endif %}
        </td>
        <td>{{ key.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
        <td>
          {% if key.encrypted_private_key %}
            <span style="color: var(--pico-ins-color);" title="Encrypted in database">üîí Database</span>
          {% elif key.private_key_path %}
            <span style="color: var(--pico-muted-color);" title="Stored on filesystem">üìÅ Filesystem</span>
          {% else %}
            <span style="color: var(--pico-del-color);">‚Äî</span>
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('admin.edit_ssh_key', key_id=key.id) }}">Edit</a>
          <form
            method="post"
            action="{{ url_for('admin.delete_ssh_key', key_id=key.id) }}"
            class="inline-form"
          >
            {{ delete_form.csrf_token }}
            {{ delete_form.key_id(value=key.id) }}
            <button type="submit" class="link-button danger" onclick="return confirm('Remove SSH key {{ key.name }}?')">
              Remove
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6">No keys configured.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h2>Add SSH Key</h2>
<form method="post">
  {{ form.hidden_tag() }}
  <label>
    {{ form.name.label }}
    {{ form.name() }}
    {% for error in form.name.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
  </label>
  <label>
    {{ form.public_key.label }}
    {{ form.public_key(rows=4) }}
    {% for error in form.public_key.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
  </label>
  <label>
    {{ form.private_key.label }}
    {{ form.private_key(rows=6, placeholder="Paste private key content here (will be encrypted and stored in database)") }}
    {% if form.private_key.description %}
      <small class="text-muted">{{ form.private_key.description }}</small>
    {% else %}
      <small class="text-muted">üîí Private key will be encrypted with Fernet and stored securely in the database. Never stored in plain text on filesystem.</small>
    {% endif %}
    {% for error in form.private_key.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
  </label>
  <label>
    {{ form.tenant_id.label }}
    {{ form.tenant_id() }}
    {% for error in form.tenant_id.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
  </label>
  <button type="submit">Add Key</button>
</form>
{% endblock %}
