{% extends "base.html" %}
{% block title %}Admin Settings | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .settings-grid {
    display: grid;
    gap: 1.5rem;
  }
  .settings-card {
    padding: 1.5rem;
    border-radius: 1.2rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.92);
  }
  [data-theme="dark"] .settings-card {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .settings-card h2 {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }
  .settings-card p {
    margin-top: 0;
    margin-bottom: 0.9rem;
  }
  .settings-card form {
    margin: 0;
  }
  .settings-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .settings-actions .checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .settings-actions .form-helper {
    font-size: 0.85rem;
  }
  .user-table {
    width: 100%;
  }
  .user-table td,
  .user-table th {
    vertical-align: top;
  }
  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .user-actions details {
    margin-bottom: 0.35rem;
  }
  .user-edit-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .user-edit-form label {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .user-actions form {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .user-actions input[type="password"] {
    max-width: 220px;
  }
  .user-meta {
    font-size: 0.9rem;
    color: #475569;
  }
  [data-theme="dark"] .user-meta {
    color: rgba(226, 232, 240, 0.75);
  }
  .log-output {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 1rem;
    background: rgba(241, 245, 249, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    font-size: 0.8rem;
    max-height: 20rem;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
  [data-theme="dark"] .log-output {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(148, 163, 184, 0.25);
  }
</style>
{% endblock %}
{% block content %}
<h1>Admin Settings</h1>

<div class="settings-grid">
  <article class="settings-card">
    <h2>System Update</h2>
    <p>Run <code>scripts/update.sh</code> without shell access. Optionally request a restart once the update completes.</p>
    {% if restart_command %}
      <p class="text-muted">Configured restart command: <code>{{ restart_command }}</code></p>
    {% else %}
      <p class="text-muted">No restart command configured. Set <code>UPDATE_RESTART_COMMAND</code> in your environment to automatically restart the service.</p>
    {% endif %}
    <form method="post" action="{{ url_for('admin.run_system_update') }}">
      {{ update_form.hidden_tag() }}
      <div class="settings-actions">
        <label class="checkbox-inline">
          {{ update_form.restart() }}
          <span>Restart application after update</span>
        </label>
        <button type="submit" class="secondary">Run update script</button>
        <span class="text-muted form-helper">Output appears as a flash message below.</span>
      </div>
    </form>
  </article>

  <article class="settings-card">
    <h2>User Accounts</h2>
    <p>Create and manage application users. Promote additional administrators so critical tasks are not blocked on a single account.</p>
    <details>
      <summary><strong>Create user</strong></summary>
      <form method="post">
        {{ create_user_form.hidden_tag() }}
        <label>
          {{ create_user_form.name.label }}
          {{ create_user_form.name() }}
          {% for error in create_user_form.name.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.email.label }}
          {{ create_user_form.email(type="email") }}
          {% for error in create_user_form.email.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label>
          {{ create_user_form.password.label }}
          {{ create_user_form.password(type="password", autocomplete="new-password") }}
          {% for error in create_user_form.password.errors %}
            <span class="error">{{ error }}</span>
          {% endfor %}
        </label>
        <label class="checkbox">
          {{ create_user_form.is_admin() }}
          {{ create_user_form.is_admin.label }}
        </label>
        <button type="submit" class="secondary">{{ create_user_form.submit.label.text }}</button>
      </form>
    </details>

    <h3>Existing users</h3>
    {% if users %}
      <table class="user-table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Role</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            {% set toggle_form = user_toggle_forms[user.id] %}
            {% set reset_form = user_reset_forms[user.id] %}
            {% set delete_form = user_delete_forms[user.id] %}
            {% set update_form = user_update_forms[user.id] %}
            <tr>
              <th scope="row">
                {{ user.name or "Unnamed user" }}
                <div class="user-meta">#{{ user.id }}</div>
              </th>
              <td><code>{{ user.email }}</code></td>
              <td>
                {% if user.is_admin %}
                  <span class="badge success">Administrator</span>
                {% else %}
                  <span class="badge">Standard</span>
                {% endif %}
                {% if current_user.id == user.id %}
                  <div class="user-meta">(You)</div>
                {% endif %}
              </td>
              <td>
                <div class="user-actions">
                  <details>
                    <summary>Edit details</summary>
                    <form method="post" action="{{ url_for('admin.update_user', user_id=user.id) }}" class="user-edit-form">
                      {{ update_form.hidden_tag() }}
                      <label>
                        {{ update_form.name.label }}
                        {{ update_form.name() }}
                      </label>
                      <label>
                        {{ update_form.email.label }}
                        {{ update_form.email(type="email") }}
                      </label>
                      <label class="checkbox">
                        {{ update_form.is_admin() }}
                        {{ update_form.is_admin.label }}
                      </label>
                      <button type="submit" class="secondary">{{ update_form.submit.label.text }}</button>
                    </form>
                  </details>
                  <form method="post" action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}">
                    {{ toggle_form.hidden_tag() }}
                    <button type="submit" class="secondary">
                      {% if user.is_admin %}Revoke admin{% else %}Promote to admin{% endif %}
                    </button>
                  </form>
                  <form method="post" action="{{ url_for('admin.reset_user_password', user_id=user.id) }}">
                    {{ reset_form.hidden_tag() }}
                    {{ reset_form.password(type="password", placeholder="New password", autocomplete="new-password") }}
                    <button type="submit" class="secondary outline">Reset password</button>
                  </form>
                  <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="secondary outline">Delete user</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No users found.</p>
    {% endif %}
  </article>

  <article class="settings-card">
    <h2>Application Logs</h2>
    {% if log_file %}
      <p>Inspect recent entries from <code>{{ log_file }}</code> to troubleshoot background activity.</p>
    {% else %}
      <p>Inspect recent log output to troubleshoot background activity.</p>
    {% endif %}
    <div class="settings-actions">
      <label class="checkbox-inline" for="log-line-count">
        <span>Lines</span>
        <input type="number" id="log-line-count" min="50" max="2000" value="400" />
      </label>
      <button type="button" class="secondary" id="refresh-log">Refresh logs</button>
      <span class="text-muted form-helper" id="log-status" aria-live="polite"></span>
    </div>
    <pre id="app-log-output" class="log-output" tabindex="0">Loading…</pre>
  </article>
</div>
<script>
  (function () {
    const refreshButton = document.getElementById('refresh-log');
    const output = document.getElementById('app-log-output');
    const status = document.getElementById('log-status');
    const lineInput = document.getElementById('log-line-count');
    if (!refreshButton || !output) {
      return;
    }

    const fetchLogs = () => {
      const lines = Math.max(50, Math.min(2000, parseInt(lineInput?.value || '400', 10) || 400));
      if (status) {
        status.textContent = 'Fetching…';
      }
      fetch(`/admin/settings/logs?lines=${lines}`, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(payload => {
          if (!payload.ok) {
            throw new Error(payload.error || 'Unable to read logs.');
          }
          output.textContent = payload.content || '(no log entries)';
          if (status) {
            status.textContent = payload.truncated ? `Showing last ${lines} lines (truncated).` : `Showing up to ${lines} lines.`;
          }
        })
        .catch(error => {
          output.textContent = `Error loading logs: ${error.message}`;
          if (status) {
            status.textContent = 'Failed to fetch logs';
          }
        });
    };

    refreshButton.addEventListener('click', fetchLogs);
    fetchLogs();
  })();
</script>
{% endblock %}
