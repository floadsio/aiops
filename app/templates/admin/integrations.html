{% extends "base.html" %}
{% block title %}Integrations | aiops Control Panel{% endblock %}
{% block content %}
<div class="integrations-header">
  <div>
    <h1>Issue Integrations</h1>
    <p>Register tenant-level credentials for GitHub, GitLab, or Jira and map them to one or more projects. Each integration can sync issues from multiple repositories or project boards.</p>
  </div>
</div>

<article style="background: var(--pico-code-background-color); border-left: 4px solid var(--pico-primary); margin-bottom: 1.5rem;">
  <p><strong>ðŸ’¡ How to map an integration to multiple projects:</strong></p>
  <ol style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
    <li>Click on an <strong>integration name</strong> in the table below</li>
    <li>On the integration detail page, you can add/remove project mappings</li>
    <li>Each project can have its own external identifier and settings</li>
  </ol>
</article>

<style>
  .integrations-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .integrations-filters {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .integrations-filters select,
  .integrations-filters input {
    margin: 0;
    min-width: 200px;
    flex: 1 1 auto;
  }
  .clear-filters-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
  .integrations-card-list {
    display: none;
    gap: 1rem;
    margin-top: 1.5rem;
    grid-template-columns: 1fr;
  }
  .integration-card {
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 0.75rem;
    padding: 1rem 1.15rem;
    background: rgba(255, 255, 255, 0.86);
    width: 100%;
  }
  [data-theme="dark"] .integration-card {
    background: rgba(15, 23, 42, 0.65);
    border-color: rgba(148, 163, 184, 0.4);
  }
  .integration-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .integration-card__name {
    font-weight: 600;
    font-size: 1.05rem;
    color: var(--pico-primary);
    margin: 0 0 0.25rem 0;
  }
  .integration-card__meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
  }
  .integration-card__meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .integration-card__meta dt {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(71, 85, 105, 0.9);
    margin: 0;
  }
  .integration-card__meta dd {
    margin: 0;
    font-weight: 600;
    font-size: 0.9rem;
  }
  [data-theme="dark"] .integration-card__meta dt {
    color: rgba(226, 232, 240, 0.72);
  }
  .integration-card__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .integration-card__actions button,
  .integration-card__actions a {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    margin: 0;
  }
<style>
  .button-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .integration-inline-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }
  .integration-inline-form button {
    align-self: flex-start;
  }
  .integration-name-link {
    font-weight: 600;
    font-size: 1.05rem;
    text-decoration: none;
    color: var(--pico-primary);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .integration-name-link:hover {
    text-decoration: underline;
  }
  .integration-name-link::after {
    content: "â†’";
    font-size: 1.1rem;
    transition: transform 0.2s;
  }
  .integration-name-link:hover::after {
    transform: translateX(3px);
  }
  .manage-projects-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.75rem;
    font-size: 0.875rem;
    text-decoration: none;
    background: var(--pico-primary);
    color: var(--pico-primary-inverse);
    border-radius: var(--pico-border-radius);
    transition: background 0.2s;
  }
  .manage-projects-btn:hover {
    background: var(--pico-primary-hover);
    color: var(--pico-primary-inverse);
  }
  /* ============================================
     MOBILE RESPONSIVE STYLES
     ============================================ */

  @media (max-width: 768px) {
    .integrations-header {
      margin-bottom: 1rem;
    }
    .integrations-header h1 {
      font-size: 1.5rem;
    }
    .integrations-filters {
      flex-direction: column;
      gap: 0.5rem;
    }
    .integrations-filters select,
    .integrations-filters input {
      width: 100%;
      min-width: 0;
      font-size: 1rem; /* Prevents zoom on iOS */
    }
    .clear-filters-btn {
      width: 100%;
    }
    .table-scroll {
      display: none;
    }
    .integrations-card-list {
      display: grid;
    }
    .grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    .button-row {
      flex-direction: column;
      align-items: stretch;
    }
    .button-row button {
      width: 100%;
      justify-content: center;
    }
    .integration-inline-form button {
      width: 100%;
      align-self: stretch;
      justify-content: center;
    }
    .manage-projects-btn {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .integrations-header h1 {
      font-size: 1.25rem;
    }
    .integrations-header p {
      font-size: 0.85rem;
    }
    .integration-card {
      padding: 0.75rem;
    }
    .integration-card__name {
      font-size: 0.95rem;
    }
    .integration-card__meta {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
  }
</style>

<h2>Configured Integrations</h2>

<!-- Filters -->
<div class="integrations-filters">
  <input
    type="text"
    id="searchIntegrations"
    placeholder="Search integrations..."
    aria-label="Search"
  >
  <select id="tenantFilter" aria-label="Filter by tenant">
    <option value="">All Tenants</option>
    {% for tenant in (integrations | map(attribute='tenant') | unique | sort(attribute='name')) %}
      {% if tenant %}
        <option value="{{ tenant.id }}">{{ tenant.name }}</option>
      {% endif %}
    {% endfor %}
  </select>
  <select id="providerFilter" aria-label="Filter by provider">
    <option value="">All Providers</option>
    <option value="github">GitHub</option>
    <option value="gitlab">GitLab</option>
    <option value="jira">Jira</option>
  </select>
  <button id="clearFilters" class="clear-filters-btn secondary outline" style="display: none;">
    Clear Filters
  </button>
</div>

{% if integrations %}
<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Tenant</th>
        <th>Name</th>
        <th>Provider</th>
        <th>Base URL</th>
        <th>Status</th>
        <th>Linked Projects</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for integration in integrations %}
      <tr>
        <td>
          {% if integration.tenant %}
            <span class="tenant-badge" style="--tenant-color: {{ integration.tenant.color or default_tenant_color }}">
              <span class="tenant-badge__swatch" aria-hidden="true"></span>
              {{ integration.tenant.name }}
            </span>
          {% else %}
            <span class="text-muted">Unknown</span>
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}" class="integration-name-link" title="Click to manage project mappings">
            {{ integration.name }}
          </a>
        </td>
        <td>{{ integration.provider|capitalize }}</td>
        <td>{% if integration.base_url %}<code>{{ integration.base_url }}</code>{% else %}<span class="text-muted">Default</span>{% endif %}</td>
        <td>
          {% if integration.enabled %}
            <span class="badge success">Enabled</span>
          {% else %}
            <span class="badge">Disabled</span>
          {% endif %}
          <details style="margin-top: 0.5rem;">
            <summary>Edit integration</summary>
            {% set tenant_update_form = tenant_integration_update_forms[integration.id] %}
            <form method="post" action="{{ url_for('admin.update_tenant_integration', integration_id=integration.id) }}" class="integration-inline-form">
              {{ tenant_update_form.hidden_tag() }}
              <label>
                {{ tenant_update_form.name.label }}
                {{ tenant_update_form.name() }}
              </label>
              <label>
                {{ tenant_update_form.base_url.label }}
                {{ tenant_update_form.base_url(placeholder="Optional override for self-hosted instances") }}
              </label>
              <label>
                {{ tenant_update_form.api_token.label }}
                {{ tenant_update_form.api_token(placeholder="Leave blank to keep current token") }}
                {% if tenant_update_form.api_token.description %}
                <small class="text-muted">{{ tenant_update_form.api_token.description }}</small>
                {% endif %}
              </label>
              <button type="submit" class="secondary">{{ tenant_update_form.submit.label.text }}</button>
            </form>
          </details>
        </td>
        <td>
          {% if integration.project_integrations %}
            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
              <span class="badge" style="font-size: 1rem; padding: 0.35rem 0.75rem;">
                {{ integration.project_integrations|length }} project{{ 's' if integration.project_integrations|length != 1 else '' }}
              </span>
              <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}" class="manage-projects-btn">
                Manage Projects
              </a>
            </div>
            <details style="margin-top: 0.75rem;">
              <summary>Show mapped projects ({{ integration.project_integrations|length }})</summary>
              <ul style="margin-top: 0.5rem;">
                {% for project_integration in integration.project_integrations %}
                  <li>
                    <a href="{{ url_for('projects.project_detail', project_id=project_integration.project.id) }}">
                      {{ project_integration.project.name if project_integration.project else "Unknown project" }}
                    </a>
                    {% if project_integration.issues %}
                      <small>({{ project_integration.issues|length }} issue{{ 's' if project_integration.issues|length != 1 else '' }})</small>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </details>
          {% else %}
            <span class="text-muted" style="display: block; margin-bottom: 0.5rem;">No linked projects yet</span>
            <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}" class="manage-projects-btn">
              Add Projects
            </a>
          {% endif %}
        </td>
        <td>
          <form method="post" class="inline-form">
            {{ integration_delete_form.csrf_token }}
            {{ integration_delete_form.integration_id(value=integration.id) }}
            {{ integration_delete_form.submit(
              class_="link-button danger",
              value="Remove",
              onclick="return confirm('Remove integration {{ integration.name }} and all linked issues?')"
            ) }}
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Mobile Card View -->
<div class="integrations-card-list">
  {% for integration in integrations %}
    <article class="integration-card" data-integration-id="{{ integration.id }}" data-tenant-id="{{ integration.tenant.id if integration.tenant else '' }}" data-provider="{{ integration.provider }}">
      <div class="integration-card__header">
        <div>
          <h3 class="integration-card__name">
            <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}">
              {{ integration.name }}
            </a>
          </h3>
          {% if integration.enabled %}
            <span class="badge success">Enabled</span>
          {% else %}
            <span class="badge">Disabled</span>
          {% endif %}
        </div>
      </div>

      <dl class="integration-card__meta">
        <div class="integration-card__meta-item">
          <dt>Tenant</dt>
          <dd>
            {% if integration.tenant %}
              <span class="tenant-badge" style="--tenant-color: {{ integration.tenant.color or default_tenant_color }}">
                <span class="tenant-badge__swatch" aria-hidden="true"></span>
                {{ integration.tenant.name }}
              </span>
            {% else %}
              <span class="text-muted">Unknown</span>
            {% endif %}
          </dd>
        </div>
        <div class="integration-card__meta-item">
          <dt>Provider</dt>
          <dd>{{ integration.provider|capitalize }}</dd>
        </div>
        <div class="integration-card__meta-item">
          <dt>Base URL</dt>
          <dd>
            {% if integration.base_url %}
              <code style="font-size: 0.8rem;">{{ integration.base_url }}</code>
            {% else %}
              <span class="text-muted">Default</span>
            {% endif %}
          </dd>
        </div>
        <div class="integration-card__meta-item">
          <dt>Linked Projects</dt>
          <dd>
            {% if integration.project_integrations %}
              <span class="badge" style="font-size: 0.9rem;">
                {{ integration.project_integrations|length }} project{{ 's' if integration.project_integrations|length != 1 else '' }}
              </span>
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </dd>
        </div>
      </dl>

      <div class="integration-card__actions">
        <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}" role="button" class="secondary">
          Manage Projects
        </a>
        <form method="post" class="inline-form" style="display: inline;">
          {{ integration_delete_form.csrf_token }}
          {{ integration_delete_form.integration_id(value=integration.id) }}
          {{ integration_delete_form.submit(
            class_="link-button danger",
            value="Remove",
            onclick="return confirm('Remove integration " + integration.name + " and all linked issues?')"
          ) }}
        </form>
      </div>

      {% if integration.project_integrations %}
        <details style="margin-top: 1rem;">
          <summary style="font-size: 0.9rem;">Show mapped projects ({{ integration.project_integrations|length }})</summary>
          <ul style="margin-top: 0.5rem; font-size: 0.85rem;">
            {% for project_integration in integration.project_integrations %}
              <li>
                <a href="{{ url_for('projects.project_detail', project_id=project_integration.project.id) }}">
                  {{ project_integration.project.name if project_integration.project else "Unknown project" }}
                </a>
                {% if project_integration.issues %}
                  <small>({{ project_integration.issues|length }} issue{{ 's' if project_integration.issues|length != 1 else '' }})</small>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}
    </article>
  {% endfor %}
</div>
{% else %}
<p>No integrations configured yet.</p>
{% endif %}

<div class="grid">
  <article>
    <header>
      <h2>Add Integration</h2>
    </header>
    <form method="post">
      {{ integration_form.hidden_tag() }}
      <label>
        {{ integration_form.tenant_id.label }}
        {{ integration_form.tenant_id() }}
        {% for error in integration_form.tenant_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.name.label }}
        {{ integration_form.name() }}
        {% for error in integration_form.name.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.provider.label }}
        {{ integration_form.provider() }}
        {% for error in integration_form.provider.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.base_url.label }}
        {{ integration_form.base_url(placeholder="Optional override for self-hosted instances") }}
        {% for error in integration_form.base_url.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.api_token.label }}
        {{ integration_form.api_token() }}
        {% for error in integration_form.api_token.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label id="jira-email-field">
        {{ integration_form.jira_email.label }}
        {{ integration_form.jira_email(placeholder=integration_form.jira_email.description) }}
        {% for error in integration_form.jira_email.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label class="checkbox">
        {{ integration_form.enabled() }}
        {{ integration_form.enabled.label }}
      </label>
      <div class="button-row">
        <button type="button" class="secondary" id="test-integration">Test Integration</button>
        <button type="submit" name="{{ integration_form.save.name }}" value="1">{{ integration_form.save.label.text }}</button>
      </div>
      <p id="integration-test-result" class="text-muted" hidden></p>
    </form>
  </article>

  <article>
    <header>
      <h2>Link Project</h2>
    </header>
    <form method="post">
      {{ project_form.hidden_tag() }}
      <label>
        {{ project_form.project_id.label }}
        {{ project_form.project_id() }}
        {% for error in project_form.project_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.integration_id.label }}
        {{ project_form.integration_id() }}
        {% for error in project_form.integration_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.external_identifier.label }}
        {{ project_form.external_identifier(placeholder=project_form.external_identifier.description) }}
        {% for error in project_form.external_identifier.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.jira_jql.label }}
        {{ project_form.jira_jql(rows=3, placeholder=project_form.jira_jql.description) }}
        {% for error in project_form.jira_jql.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_base_url.label }}
        {{ project_form.override_base_url(placeholder=project_form.override_base_url.description) }}
        {% for error in project_form.override_base_url.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_api_token.label }}
        {{ project_form.override_api_token() }}
        {% for error in project_form.override_api_token.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_username.label }}
        {{ project_form.override_username(placeholder=project_form.override_username.description) }}
        {% for error in project_form.override_username.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <button type="submit" name="{{ project_form.link.name }}" value="1">{{ project_form.link.label.text }}</button>
    </form>
  </article>
</div>
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const testButton = document.getElementById('test-integration');
    if (!testButton) {
      return;
    }
    const form = testButton.closest('form');
    const resultElement = document.getElementById('integration-test-result');
    const provider = form ? form.elements['provider'] : null;
  const tenant = form ? form.elements['tenant_id'] : null;
  const baseUrl = form ? form.elements['base_url'] : null;
  const apiToken = form ? form.elements['api_token'] : null;
  const jiraEmail = form ? form.elements['jira_email'] : null;
  const csrfToken = form ? form.elements['csrf_token'] : null;
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfTokenValue = (
    (csrfToken && csrfToken.value) ||
    (csrfMeta && csrfMeta.getAttribute('content')) ||
    ''
  );
    const jiraEmailField = document.getElementById('jira-email-field');

    function toggleJiraField() {
      if (!jiraEmailField) {
        return;
      }
      const needsEmail = provider && provider.value === 'jira';
      jiraEmailField.style.display = needsEmail ? '' : 'none';
    }
    toggleJiraField();
    if (provider) {
      provider.addEventListener('change', toggleJiraField);
    }

    function setResult(message, tone) {
      if (!resultElement) {
        return;
      }
      resultElement.hidden = false;
      resultElement.textContent = message;
      if (tone === 'success') {
        resultElement.style.color = 'var(--pico-color-success)';
      } else if (tone === 'error') {
        resultElement.style.color = 'var(--pico-color-danger)';
      } else {
        resultElement.style.color = 'inherit';
      }
    }

    testButton.addEventListener('click', async () => {
      if (!form) {
        return;
      }
      if (!provider || !tenant || !apiToken || !csrfTokenValue) {
        setResult('Integration form is incomplete.', 'error');
        return;
      }

      const payload = {
        provider: provider.value,
        tenant_id: tenant.value,
        base_url: baseUrl ? baseUrl.value : '',
        api_token: apiToken.value,
        jira_email: jiraEmail ? jiraEmail.value : ''
      };

      setResult('Testing credentials...', 'neutral');
      testButton.disabled = true;
      try {
        const response = await fetch('{{ url_for("admin.test_integration") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {})
          },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok && data && data.ok) {
          setResult(data.message || 'Integration credentials verified.', 'success');
        } else {
          const message = data && data.message ? data.message : 'Failed to verify integration.';
          setResult(message, 'error');
        }
      } catch (error) {
        setResult('Unable to reach the server to test credentials.', 'error');
      } finally {
        testButton.disabled = false;
      }
    });
  })();

  // Filter functionality
  (function () {
    const searchInput = document.getElementById('searchIntegrations');
    const tenantFilter = document.getElementById('tenantFilter');
    const providerFilter = document.getElementById('providerFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');

    function updateClearButton() {
      const hasFilters =
        searchInput.value ||
        tenantFilter.value ||
        providerFilter.value;
      clearFiltersBtn.style.display = hasFilters ? 'block' : 'none';
    }

    function filterIntegrations() {
      const searchValue = searchInput.value.toLowerCase();
      const tenantValue = tenantFilter.value;
      const providerValue = providerFilter.value;

      // Filter table rows
      const tableRows = document.querySelectorAll('.table-scroll tbody tr');
      tableRows.forEach(row => {
        const integrationName = (row.cells[1]?.textContent || '').toLowerCase();
        const providerCell = (row.cells[2]?.textContent || '').toLowerCase();
        const tenantId = row.querySelector('.tenant-badge')?.closest('td')?.querySelector('[style*="--tenant-color"]')?.closest('span')?.textContent || '';

        const matchesSearch = !searchValue || integrationName.includes(searchValue);
        const matchesTenant = !tenantValue || row.querySelector(`[style*="--tenant-color"]`)?.closest('span')?.textContent.includes(tenantFilter.options[tenantFilter.selectedIndex]?.text || '');
        const matchesProvider = !providerValue || providerCell.includes(providerValue);

        row.style.display = (matchesSearch && matchesTenant && matchesProvider) ? '' : 'none';
      });

      // Filter mobile cards
      const cards = document.querySelectorAll('.integration-card');
      cards.forEach(card => {
        const integrationName = (card.querySelector('.integration-card__name')?.textContent || '').toLowerCase();
        const cardTenantId = card.dataset.tenantId;
        const cardProvider = card.dataset.provider;

        const matchesSearch = !searchValue || integrationName.includes(searchValue);
        const matchesTenant = !tenantValue || cardTenantId === tenantValue;
        const matchesProvider = !providerValue || cardProvider === providerValue;

        card.style.display = (matchesSearch && matchesTenant && matchesProvider) ? '' : 'none';
      });

      updateClearButton();
    }

    if (searchInput) {
      searchInput.addEventListener('input', filterIntegrations);
    }
    if (tenantFilter) {
      tenantFilter.addEventListener('change', filterIntegrations);
    }
    if (providerFilter) {
      providerFilter.addEventListener('change', filterIntegrations);
    }
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', () => {
        searchInput.value = '';
        tenantFilter.value = '';
        providerFilter.value = '';
        filterIntegrations();
      });
    }
  })();
</script>
{% endblock %}
