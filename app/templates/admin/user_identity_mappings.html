{% extends "base.html" %}
{% block title %}User Identity Mappings | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .identity-header {
    margin-bottom: 2rem;
  }
  .identity-header h1 {
    margin-bottom: 0.5rem;
  }
  .identity-header p {
    color: #64748b;
    margin: 0;
  }
  [data-theme="dark"] .identity-header p {
    color: rgba(148, 163, 184, 0.75);
  }
  .identity-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 2rem;
  }
  .identity-card {
    padding: 1rem 1.25rem;
    border-radius: 0.7rem;
    background: rgba(26, 29, 35, 0.04);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  [data-theme="dark"] .identity-card {
    background: rgba(148, 163, 184, 0.08);
    border-color: rgba(148, 163, 184, 0.3);
  }
  .identity-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }
  .identity-card__user-section {
    flex: 1;
    min-width: 0;
  }
  .identity-card__user-name {
    font-size: 1.05rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: var(--pico-color-slate-900);
  }
  [data-theme="dark"] .identity-card__user-name {
    color: rgba(226, 232, 240, 0.95);
  }
  .identity-card__user-email {
    font-size: 0.8rem;
    color: #64748b;
    margin: 0;
  }
  [data-theme="dark"] .identity-card__user-email {
    color: rgba(148, 163, 184, 0.75);
  }
  .identity-card__mappings {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }
  .identity-mapping {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }
  .identity-mapping__label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    font-weight: 500;
  }
  [data-theme="dark"] .identity-mapping__label {
    color: rgba(148, 163, 184, 0.75);
  }
  .identity-mapping__value {
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    background: rgba(148, 163, 184, 0.1);
    border-radius: 0.2rem;
  }
  [data-theme="dark"] .identity-mapping__value {
    background: rgba(148, 163, 184, 0.2);
  }
  .identity-mapping__value--empty {
    color: #64748b;
    background: transparent;
  }
  .identity-card__actions {
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
    flex-shrink: 0;
  }
  .identity-card__actions button {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    margin: 0;
  }
  .identity-card__footer {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.5rem;
  }
  [data-theme="dark"] .identity-card__footer {
    color: rgba(148, 163, 184, 0.75);
  }
  .add-mapping-section {
    padding: 1.5rem;
    border-radius: 0.7rem;
    background: rgba(26, 29, 35, 0.02);
    border: 1px solid rgba(148, 163, 184, 0.2);
    margin-bottom: 2rem;
  }
  [data-theme="dark"] .add-mapping-section {
    background: rgba(148, 163, 184, 0.05);
    border-color: rgba(148, 163, 184, 0.25);
  }
  .add-mapping-section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }
  .info-box {
    padding: 1.5rem;
    border-radius: 0.7rem;
    background: rgba(25, 118, 210, 0.08);
    border: 1px solid rgba(25, 118, 210, 0.2);
  }
  [data-theme="dark"] .info-box {
    background: rgba(66, 165, 245, 0.1);
    border-color: rgba(66, 165, 245, 0.25);
  }
  .info-box h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
  }
  .info-box p {
    margin: 0.5rem 0;
  }
  .info-box ul {
    margin: 0.5rem 0;
  }
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #64748b;
  }
  [data-theme="dark"] .empty-state {
    color: rgba(148, 163, 184, 0.75);
  }
  @media (max-width: 768px) {
    .identity-card__header {
      flex-direction: column;
    }
    .identity-card__actions {
      width: 100%;
    }
    .identity-card__mappings {
      flex-direction: column;
    }
  }
</style>
{% endblock %}
{% block content %}
<div class="identity-header">
  <h1>User Identity Mappings</h1>
  <p>Map aiops users to their identities on GitHub, GitLab, and Jira for correct issue assignment.</p>
</div>

<!-- Identity Mappings List -->
<div class="identity-list">
  {% for mapping in identity_maps %}
    <article class="identity-card">
      <div class="identity-card__header">
        <div class="identity-card__user-section">
          <h3 class="identity-card__user-name">{{ mapping.user.name }}</h3>
          <p class="identity-card__user-email">{{ mapping.user.email }}</p>

          <div class="identity-card__mappings">
            <div class="identity-mapping">
              <span class="identity-mapping__label">GitHub</span>
              {% if mapping.github_username %}
                <code class="identity-mapping__value">{{ mapping.github_username }}</code>
              {% else %}
                <span class="identity-mapping__value identity-mapping__value--empty">—</span>
              {% endif %}
            </div>

            <div class="identity-mapping">
              <span class="identity-mapping__label">GitLab</span>
              {% if mapping.gitlab_username %}
                <code class="identity-mapping__value">{{ mapping.gitlab_username }}</code>
              {% else %}
                <span class="identity-mapping__value identity-mapping__value--empty">—</span>
              {% endif %}
            </div>

            <div class="identity-mapping">
              <span class="identity-mapping__label">Jira Account ID</span>
              {% if mapping.jira_account_id %}
                <code class="identity-mapping__value">{{ mapping.jira_account_id }}</code>
              {% else %}
                <span class="identity-mapping__value identity-mapping__value--empty">—</span>
              {% endif %}
            </div>
          </div>

          <p class="identity-card__footer">Updated {{ mapping.updated_at.strftime("%Y-%m-%d %H:%M") }}</p>
        </div>

        <div class="identity-card__actions">
          <form
            method="post"
            action="{{ url_for('admin.delete_user_identity_mapping', user_id=mapping.user_id) }}"
            style="margin: 0;"
          >
            {{ delete_forms[mapping.user_id].csrf_token }}
            {{ delete_forms[mapping.user_id].user_id(value=mapping.user_id) }}
            <button type="submit" class="contrast" onclick="return confirm('Delete identity mapping for {{ mapping.user.name }}?')">
              Delete
            </button>
          </form>
        </div>
      </div>
    </article>
  {% else %}
    <div class="empty-state">
      <p>No identity mappings configured.</p>
    </div>
  {% endfor %}
</div>

<!-- Add/Update Mapping Form -->
<section class="add-mapping-section">
  <h2>Add or Update Identity Mapping</h2>
  <form method="post">
    {{ form.hidden_tag() }}
    <label>
      {{ form.user_id.label }}
      {{ form.user_id() }}
      {% for error in form.user_id.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.github_username.label }}
      {{ form.github_username() }}
      <small class="text-muted">GitHub username (e.g., octocat)</small>
      {% for error in form.github_username.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.gitlab_username.label }}
      {{ form.gitlab_username() }}
      <small class="text-muted">GitLab username</small>
      {% for error in form.gitlab_username.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <label>
      {{ form.jira_account_id.label }}
      {{ form.jira_account_id() }}
      <small class="text-muted">Jira account ID (not email!). Find this in Jira user profile.</small>
      {% for error in form.jira_account_id.errors %}
        <span class="error">{{ error }}</span>
      {% endfor %}
    </label>
    <button type="submit">{{ form.submit.label.text }}</button>
  </form>
</section>

<!-- Info Box -->
<div class="info-box">
  <h3>About User Identity Mappings</h3>
  <p>
    User identity mappings allow aiops to correctly assign issues when creating them on external platforms.
    Each aiops user can have different usernames or account IDs on GitHub, GitLab, and Jira.
  </p>
  <ul>
    <li><strong>GitHub:</strong> Use the GitHub username (e.g., "octocat")</li>
    <li><strong>GitLab:</strong> Use the GitLab username</li>
    <li><strong>Jira:</strong> Use the Jira account ID (found in user profile, not the email address)</li>
  </ul>
  <p class="text-muted">
    Leave fields blank if the user doesn't have an account on a particular platform.
    When creating issues, aiops will skip assignee if no mapping exists.
  </p>
</div>
{% endblock %}
