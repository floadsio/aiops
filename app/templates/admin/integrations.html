{% extends "base.html" %}
{% block title %}Integrations | aiops Control Panel{% endblock %}
{% block content %}
<div class="integrations-header">
  <div>
    <h1>Issue Integrations</h1>
    <p>Register tenant-level credentials for GitHub, GitLab, or Jira and map them to one or more projects. Each integration can sync issues from multiple repositories or project boards.</p>
  </div>
</div>

<article style="background: var(--pico-code-background-color); border-left: 4px solid var(--pico-primary); margin-bottom: 1.5rem;">
  <p><strong>üí° How to map an integration to multiple projects:</strong></p>
  <ol style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
    <li>Click on an <strong>integration name</strong> in the table below</li>
    <li>On the integration detail page, you can add/remove project mappings</li>
    <li>Each project can have its own external identifier and settings</li>
  </ol>
</article>

<style>
  .integrations-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .integrations-filters {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .integrations-filters select,
  .integrations-filters input[type="text"] {
    margin: 0;
    border-radius: 0.5rem;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: rgba(255, 255, 255, 0.92);
    min-width: 180px;
  }
  [data-theme="dark"] .integrations-filters select,
  [data-theme="dark"] .integrations-filters input[type="text"] {
    border-color: rgba(148, 163, 184, 0.5);
    background: rgba(26, 29, 35, 0.65);
    color: rgba(226, 232, 240, 0.9);
  }
  @media (max-width: 768px) {
    .integrations-filters {
      flex-direction: column;
      gap: 0.5rem;
    }
    .integrations-filters select,
    .integrations-filters input {
      width: 100%;
      min-width: 0;
      font-size: 1rem;
    }
  }

  /* Card Layout - based on Statistics page contributor cards */
  .integrations-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .integration-card {
    padding: 1rem 1.25rem;
    border-radius: 0.7rem;
    background: rgba(26, 29, 35, 0.04);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }

  [data-theme="dark"] .integration-card {
    background: rgba(148, 163, 184, 0.08);
    border-color: rgba(148, 163, 184, 0.3);
  }

  .integration-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .integration-card__title-section {
    flex: 1;
    min-width: 200px;
  }

  .integration-card__name {
    font-weight: 600;
    font-size: 1rem;
    margin: 0 0 0.5rem 0;
  }

  .integration-card__name a {
    color: var(--pico-primary);
    text-decoration: none;
  }

  .integration-card__name a:hover {
    text-decoration: underline;
  }

  .integration-card__badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .integration-card__meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--pico-muted-color);
    flex-wrap: wrap;
  }

  .integration-card__base-url {
    margin: 0.5rem 0;
    font-size: 0.85rem;
  }

  .integration-card__base-url code {
    font-size: 0.8rem;
  }

  .integration-card__actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .integration-card__actions button,
  .integration-card__actions a[role="button"] {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    margin: 0;
  }

  .integration-card__projects,
  .integration-card__edit {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(148, 163, 184, 0.2);
  }

  .integration-card__projects summary,
  .integration-card__edit summary {
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--pico-primary);
    font-weight: 500;
  }

  .integration-card__projects ul {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    padding-left: 1.5rem;
  }

  .integration-card__projects li {
    margin: 0.25rem 0;
  }

  .integration-card__projects a {
    color: var(--pico-primary);
    text-decoration: none;
  }

  .integration-card__projects a:hover {
    text-decoration: underline;
  }

  .button-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .integration-inline-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .integration-inline-form button {
    align-self: flex-start;
  }

  /* Mobile responsive styles */
  @media (max-width: 768px) {
    .integrations-header {
      margin-bottom: 1rem;
    }
    .integrations-header h1 {
      font-size: 1.5rem;
    }
    .integrations-filters {
      flex-direction: column;
      gap: 0.5rem;
    }
    .integrations-filters select,
    .integrations-filters input {
      width: 100%;
      min-width: 0;
      font-size: 1rem; /* Prevents zoom on iOS */
    }
    .clear-filters-btn {
      width: 100%;
    }
    .grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    .button-row {
      flex-direction: column;
      align-items: stretch;
    }
    .button-row button {
      width: 100%;
      justify-content: center;
    }
    .integration-inline-form button {
      width: 100%;
      align-self: stretch;
      justify-content: center;
    }
    .integration-card__actions {
      flex-direction: column;
    }
    .integration-card__actions button,
    .integration-card__actions a[role="button"] {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .integrations-header h1 {
      font-size: 1.25rem;
    }
    .integrations-header p {
      font-size: 0.85rem;
    }
    .integration-card {
      padding: 0.75rem;
    }
  }
</style>

<h2>Configured Integrations</h2>

<!-- Filters -->
<form method="get" class="integrations-filters">
  <select name="tenant" onchange="this.form.submit()" aria-label="Filter by tenant">
    {% for option in tenant_options %}
      <option value="{{ option.value }}" {% if option.value == tenant_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <select name="provider" onchange="this.form.submit()" aria-label="Filter by provider">
    {% for option in provider_options %}
      <option value="{{ option.value }}" {% if option.value == provider_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <select name="status" onchange="this.form.submit()" aria-label="Filter by status">
    {% for option in status_options %}
      <option value="{{ option.value }}" {% if option.value == status_filter %}selected{% endif %}>
        {{ option.label }} ({{ option.count }})
      </option>
    {% endfor %}
  </select>

  <input
    type="text"
    name="search"
    value="{{ search_query }}"
    placeholder="Search integrations..."
    aria-label="Search"
  />
</form>

<p class="text-muted">
  Showing {{ filtered_count }} of {{ total_count }} integration{{ 's' if total_count != 1 else '' }}
  {% if tenant_filter != 'all' %}
    (tenant: {{ tenant_filter_label }})
  {% endif %}
  {% if provider_filter != 'all' %}
    (provider: {{ provider_filter_label }})
  {% endif %}
  {% if status_filter != 'all' %}
    (status: {{ status_filter_label }})
  {% endif %}
  {% if search_query %}
    (search: "{{ search_query }}")
  {% endif %}.
</p>

{% if integrations %}
<div class="integrations-list">
  {% for integration in integrations %}
    <article class="integration-card" data-integration-id="{{ integration.id }}" data-tenant-id="{{ integration.tenant.id if integration.tenant else '' }}" data-provider="{{ integration.provider }}">
      <div class="integration-card__header">
        <div class="integration-card__title-section">
          <h3 class="integration-card__name">
            <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}">
              {{ integration.name }}
            </a>
          </h3>
          <div class="integration-card__badges">
            {% if integration.tenant %}
              <span class="tenant-badge" style="--tenant-color: {{ integration.tenant.color or default_tenant_color }}">
                <span class="tenant-badge__swatch" aria-hidden="true"></span>
                {{ integration.tenant.name }}
              </span>
            {% endif %}
            <span class="badge">{{ integration.provider|capitalize }}</span>
            {% if integration.enabled %}
              <span class="badge success">Enabled</span>
            {% else %}
              <span class="badge">Disabled</span>
            {% endif %}
          </div>
        </div>
        <div class="integration-card__meta">
          {% if integration.project_integrations %}
            <span>üìÅ {{ integration.project_integrations|length }} project{{ 's' if integration.project_integrations|length != 1 else '' }}</span>
          {% else %}
            <span class="text-muted">No projects linked</span>
          {% endif %}
        </div>
      </div>

      {% if integration.base_url %}
        <div class="integration-card__base-url">
          <strong>Base URL:</strong> <code>{{ integration.base_url }}</code>
        </div>
      {% endif %}

      <div class="integration-card__actions">
        <a href="{{ url_for('admin.integration_detail', integration_id=integration.id) }}" role="button" class="secondary">
          Manage Projects
        </a>
        <form method="post" class="inline-form" style="display: inline; margin: 0;">
          {{ integration_delete_form.csrf_token }}
          {{ integration_delete_form.integration_id(value=integration.id) }}
          <button
            type="submit"
            class="secondary outline"
            style="color: var(--pico-del-color); border-color: var(--pico-del-color);"
            onclick="return confirm('Remove integration {{ integration.name }} and all linked issues?')"
          >
            Remove
          </button>
        </form>
      </div>

      {% if integration.project_integrations %}
        <details class="integration-card__projects">
          <summary>Show linked projects ({{ integration.project_integrations|length }})</summary>
          <ul>
            {% for project_integration in integration.project_integrations %}
              <li>
                <a href="{{ url_for('projects.project_detail', project_id=project_integration.project.id) }}">
                  {{ project_integration.project.name if project_integration.project else "Unknown project" }}
                </a>
                {% if project_integration.issues %}
                  <small>({{ project_integration.issues|length }} issue{{ 's' if project_integration.issues|length != 1 else '' }})</small>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}

      <details class="integration-card__edit">
        <summary>Edit integration settings</summary>
        {% set tenant_update_form = tenant_integration_update_forms[integration.id] %}
        <form method="post" action="{{ url_for('admin.update_tenant_integration', integration_id=integration.id) }}" class="integration-inline-form">
          {{ tenant_update_form.hidden_tag() }}
          <label>
            {{ tenant_update_form.name.label }}
            {{ tenant_update_form.name() }}
          </label>
          <label>
            {{ tenant_update_form.base_url.label }}
            {{ tenant_update_form.base_url(placeholder="Optional override for self-hosted instances") }}
          </label>
          <label>
            {{ tenant_update_form.api_token.label }}
            {{ tenant_update_form.api_token(placeholder="Leave blank to keep current token") }}
            {% if tenant_update_form.api_token.description %}
            <small class="text-muted">{{ tenant_update_form.api_token.description }}</small>
            {% endif %}
          </label>
          <button type="submit" class="secondary">{{ tenant_update_form.submit.label.text }}</button>
        </form>
      </details>
    </article>
  {% endfor %}
</div>
{% else %}
<p>No integrations configured yet.</p>
{% endif %}

<div class="grid">
  <article>
    <header>
      <h2>Add Integration</h2>
    </header>
    <form method="post">
      {{ integration_form.hidden_tag() }}
      <label>
        {{ integration_form.tenant_id.label }}
        {{ integration_form.tenant_id() }}
        {% for error in integration_form.tenant_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.name.label }}
        {{ integration_form.name() }}
        {% for error in integration_form.name.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.provider.label }}
        {{ integration_form.provider() }}
        {% for error in integration_form.provider.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.base_url.label }}
        {{ integration_form.base_url(placeholder="Optional override for self-hosted instances") }}
        {% for error in integration_form.base_url.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ integration_form.api_token.label }}
        {{ integration_form.api_token() }}
        {% for error in integration_form.api_token.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label id="jira-email-field">
        {{ integration_form.jira_email.label }}
        {{ integration_form.jira_email(placeholder=integration_form.jira_email.description) }}
        {% for error in integration_form.jira_email.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label class="checkbox">
        {{ integration_form.enabled() }}
        {{ integration_form.enabled.label }}
      </label>
      <div class="button-row">
        <button type="button" class="secondary" id="test-integration">Test Integration</button>
        <button type="submit" name="{{ integration_form.save.name }}" value="1">{{ integration_form.save.label.text }}</button>
      </div>
      <p id="integration-test-result" class="text-muted" hidden></p>
    </form>
  </article>

  <article>
    <header>
      <h2>Link Project</h2>
    </header>
    <form method="post">
      {{ project_form.hidden_tag() }}
      <label>
        {{ project_form.project_id.label }}
        {{ project_form.project_id() }}
        {% for error in project_form.project_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.integration_id.label }}
        {{ project_form.integration_id() }}
        {% for error in project_form.integration_id.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.external_identifier.label }}
        {{ project_form.external_identifier(placeholder=project_form.external_identifier.description) }}
        {% for error in project_form.external_identifier.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.jira_jql.label }}
        {{ project_form.jira_jql(rows=3, placeholder=project_form.jira_jql.description) }}
        {% for error in project_form.jira_jql.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_base_url.label }}
        {{ project_form.override_base_url(placeholder=project_form.override_base_url.description) }}
        {% for error in project_form.override_base_url.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_api_token.label }}
        {{ project_form.override_api_token() }}
        {% for error in project_form.override_api_token.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <label>
        {{ project_form.override_username.label }}
        {{ project_form.override_username(placeholder=project_form.override_username.description) }}
        {% for error in project_form.override_username.errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </label>
      <button type="submit" name="{{ project_form.link.name }}" value="1">{{ project_form.link.label.text }}</button>
    </form>
  </article>
</div>
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const testButton = document.getElementById('test-integration');
    if (!testButton) {
      return;
    }
    const form = testButton.closest('form');
    const resultElement = document.getElementById('integration-test-result');
    const provider = form ? form.elements['provider'] : null;
  const tenant = form ? form.elements['tenant_id'] : null;
  const baseUrl = form ? form.elements['base_url'] : null;
  const apiToken = form ? form.elements['api_token'] : null;
  const jiraEmail = form ? form.elements['jira_email'] : null;
  const csrfToken = form ? form.elements['csrf_token'] : null;
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfTokenValue = (
    (csrfToken && csrfToken.value) ||
    (csrfMeta && csrfMeta.getAttribute('content')) ||
    ''
  );
    const jiraEmailField = document.getElementById('jira-email-field');

    function toggleJiraField() {
      if (!jiraEmailField) {
        return;
      }
      const needsEmail = provider && provider.value === 'jira';
      jiraEmailField.style.display = needsEmail ? '' : 'none';
    }
    toggleJiraField();
    if (provider) {
      provider.addEventListener('change', toggleJiraField);
    }

    function setResult(message, tone) {
      if (!resultElement) {
        return;
      }
      resultElement.hidden = false;
      resultElement.textContent = message;
      if (tone === 'success') {
        resultElement.style.color = 'var(--pico-color-success)';
      } else if (tone === 'error') {
        resultElement.style.color = 'var(--pico-color-danger)';
      } else {
        resultElement.style.color = 'inherit';
      }
    }

    testButton.addEventListener('click', async () => {
      if (!form) {
        return;
      }
      if (!provider || !tenant || !apiToken || !csrfTokenValue) {
        setResult('Integration form is incomplete.', 'error');
        return;
      }

      const payload = {
        provider: provider.value,
        tenant_id: tenant.value,
        base_url: baseUrl ? baseUrl.value : '',
        api_token: apiToken.value,
        jira_email: jiraEmail ? jiraEmail.value : ''
      };

      setResult('Testing credentials...', 'neutral');
      testButton.disabled = true;
      try {
        const response = await fetch('{{ url_for("admin.test_integration") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {})
          },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok && data && data.ok) {
          setResult(data.message || 'Integration credentials verified.', 'success');
        } else {
          const message = data && data.message ? data.message : 'Failed to verify integration.';
          setResult(message, 'error');
        }
      } catch (error) {
        setResult('Unable to reach the server to test credentials.', 'error');
      } finally {
        testButton.disabled = false;
      }
    });
  })();

  // Filter functionality
  (function () {
    const searchInput = document.getElementById('searchIntegrations');
    const tenantFilter = document.getElementById('tenantFilter');
    const providerFilter = document.getElementById('providerFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');

    function updateClearButton() {
      const hasFilters =
        searchInput.value ||
        tenantFilter.value ||
        providerFilter.value;
      clearFiltersBtn.style.display = hasFilters ? 'block' : 'none';
    }

    function filterIntegrations() {
      const searchValue = searchInput.value.toLowerCase();
      const tenantValue = tenantFilter.value;
      const providerValue = providerFilter.value;

      // Filter cards
      const cards = document.querySelectorAll('.integration-card');
      cards.forEach(card => {
        const integrationName = (card.querySelector('.integration-card__name')?.textContent || '').toLowerCase();
        const cardTenantId = card.dataset.tenantId;
        const cardProvider = card.dataset.provider;

        const matchesSearch = !searchValue || integrationName.includes(searchValue);
        const matchesTenant = !tenantValue || cardTenantId === tenantValue;
        const matchesProvider = !providerValue || cardProvider === providerValue;

        card.style.display = (matchesSearch && matchesTenant && matchesProvider) ? '' : 'none';
      });

      updateClearButton();
    }

    if (searchInput) {
      searchInput.addEventListener('input', filterIntegrations);
    }
    if (tenantFilter) {
      tenantFilter.addEventListener('change', filterIntegrations);
    }
    if (providerFilter) {
      providerFilter.addEventListener('change', filterIntegrations);
    }
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', () => {
        searchInput.value = '';
        tenantFilter.value = '';
        providerFilter.value = '';
        filterIntegrations();
      });
    }
  })();
</script>
{% endblock %}
