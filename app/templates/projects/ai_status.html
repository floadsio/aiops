{% extends "base.html" %}
{% block title %}AI Tool Status{% endblock %}
{% block content %}
<h1>AI Tool Status</h1>
<p class="text-muted">View your Claude usage limits and remaining capacity{% if linux_username %} for user <code>{{ linux_username }}</code>{% endif %}.</p>

<article class="contrast" style="padding:1.5rem;">
  <header style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:space-between;">
    <div>
      <h2 style="margin:0;">Claude Usage</h2>
      <p class="text-muted" style="margin:0;">Token and request limits tracked from Claude API responses.</p>
    </div>
    <div>
      <a href="{{ url_for('projects.ai_status_overview') }}" class="secondary" role="button">Refresh</a>
    </div>
  </header>
  <hr>

  {% if claude_usage.input_tokens_limit or claude_usage.output_tokens_limit or claude_usage.requests_limit %}
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem;">
      {% if claude_usage.input_tokens_limit %}
        <div style="padding:1rem;border-radius:0.5rem;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);">
          <div style="font-size:0.85rem;color:#64748b;margin-bottom:0.5rem;">Input Tokens</div>
          <div style="font-size:1.5rem;font-weight:600;">
            {{ "{:,}".format(claude_usage.input_tokens_remaining or 0) }}
          </div>
          <div style="font-size:0.85rem;color:#64748b;margin-top:0.25rem;">
            of {{ "{:,}".format(claude_usage.input_tokens_limit) }}
          </div>
          {% if claude_usage.input_tokens_limit and claude_usage.input_tokens_remaining is not none %}
            <div style="margin-top:0.5rem;height:4px;background:rgba(0,0,0,0.1);border-radius:2px;overflow:hidden;">
              <div style="height:100%;background:#3b82f6;width:{{ (claude_usage.input_tokens_remaining / claude_usage.input_tokens_limit * 100)|round|int }}%;"></div>
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if claude_usage.output_tokens_limit %}
        <div style="padding:1rem;border-radius:0.5rem;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);">
          <div style="font-size:0.85rem;color:#64748b;margin-bottom:0.5rem;">Output Tokens</div>
          <div style="font-size:1.5rem;font-weight:600;">
            {{ "{:,}".format(claude_usage.output_tokens_remaining or 0) }}
          </div>
          <div style="font-size:0.85rem;color:#64748b;margin-top:0.25rem;">
            of {{ "{:,}".format(claude_usage.output_tokens_limit) }}
          </div>
          {% if claude_usage.output_tokens_limit and claude_usage.output_tokens_remaining is not none %}
            <div style="margin-top:0.5rem;height:4px;background:rgba(0,0,0,0.1);border-radius:2px;overflow:hidden;">
              <div style="height:100%;background:#10b981;width:{{ (claude_usage.output_tokens_remaining / claude_usage.output_tokens_limit * 100)|round|int }}%;"></div>
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if claude_usage.requests_limit %}
        <div style="padding:1rem;border-radius:0.5rem;background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);">
          <div style="font-size:0.85rem;color:#64748b;margin-bottom:0.5rem;">Requests</div>
          <div style="font-size:1.5rem;font-weight:600;">
            {{ "{:,}".format(claude_usage.requests_remaining or 0) }}
          </div>
          <div style="font-size:0.85rem;color:#64748b;margin-top:0.25rem;">
            of {{ "{:,}".format(claude_usage.requests_limit) }}
          </div>
          {% if claude_usage.requests_limit and claude_usage.requests_remaining is not none %}
            <div style="margin-top:0.5rem;height:4px;background:rgba(0,0,0,0.1);border-radius:2px;overflow:hidden;">
              <div style="height:100%;background:#a855f7;width:{{ (claude_usage.requests_remaining / claude_usage.requests_limit * 100)|round|int }}%;"></div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {% if claude_usage.last_updated %}
      <p class="text-muted" style="font-size:0.85rem;">
        Last updated: {{ claude_usage.last_updated.strftime('%Y-%m-%d %H:%M UTC') if claude_usage.last_updated else 'Never' }}
      </p>
      <p class="text-muted" style="font-size:0.85rem;">
        Usage limits are automatically updated when you use Claude Code through aiops.
      </p>
    {% else %}
      <p class="text-muted">
        Usage limits will be populated after your first Claude Code session.
      </p>
    {% endif %}
  {% else %}
    <p class="text-muted">
      Claude usage tracking is not yet implemented. Usage data will be automatically populated in a future update when you use Claude Code through aiops.
    </p>
    <p class="text-muted" style="font-size:0.85rem;">
      Note: You can still use Claude Code normally - this page is for displaying usage limits once tracking is enabled.
    </p>
  {% endif %}
</article>

<article class="contrast" style="padding:1.5rem;margin-top:1.5rem;">
  <header style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:space-between;">
    <div>
      <h2 style="margin:0;">Claude CLI Status</h2>
      <p class="text-muted" style="margin:0;">Latest status output from <code>claude</code> CLI.</p>
    </div>
  </header>
  <hr>

  {% if claude_status %}
    <p><strong>Command:</strong> <code>{{ claude_status.command or 'claude' }}</code></p>
    {% if claude_status.stdout %}
      <p><strong>Output</strong></p>
      <pre style="white-space:pre-wrap;">{{ claude_status.stdout }}</pre>
    {% endif %}
    {% if claude_status.stderr %}
      <p><strong>Errors</strong></p>
      <pre style="white-space:pre-wrap;color:#dc2626;">{{ claude_status.stderr }}</pre>
    {% endif %}
    <p><strong>Exit code:</strong> {{ claude_status.returncode }}</p>
  {% elif claude_status_error %}
    <p class="text-danger">{{ claude_status_error }}</p>
  {% else %}
    <p class="text-muted">Claude CLI status is unavailable.</p>
  {% endif %}
</article>
{% endblock %}
