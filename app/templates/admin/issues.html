{% extends "base.html" %}
{% block title %}Issues | aiops Control Panel{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    .issues-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .issue-filter-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .issue-filter-form label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(71, 85, 105, 0.9);
    }
    [data-theme="dark"] .issue-filter-form label {
      color: rgba(226, 232, 240, 0.72);
    }
    .issues-table table {
      width: 100%;
    }
    .issues-table th {
      white-space: nowrap;
    }
    .issues-table .sort-link {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }
    .issues-table .sort-link:hover,
    .issues-table .sort-link:focus {
      text-decoration: underline;
    }
    .issues-table .sort-indicator {
      font-size: 0.8rem;
      opacity: 0.65;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }
    .issues-table .sort-link.is-active .sort-indicator {
      opacity: 1;
    }
  .issues-card-list {
    display: none;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .issues-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }
    .issue-card {
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 1rem;
      padding: 1rem 1.15rem;
      background: rgba(255, 255, 255, 0.86);
    }
    [data-theme="dark"] .issue-card {
      background: rgba(15, 23, 42, 0.65);
      border-color: rgba(148, 163, 184, 0.4);
    }
    .issue-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .issue-card__header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .issue-card__title {
      margin: 0.25rem 0 0;
      font-size: 0.95rem;
    }
    .issue-card__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.6rem 1rem;
      margin: 1rem 0 0;
      padding: 0;
    }
    .issue-card__meta-item {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .issue-card__meta dt {
      margin: 0;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(71, 85, 105, 0.9);
    }
    .issue-card__meta dd {
      margin: 0;
      font-weight: 600;
    }
    [data-theme="dark"] .issue-card__meta dt {
      color: rgba(226, 232, 240, 0.72);
    }
    @media (max-width: 900px) {
      .issues-actions {
        align-items: stretch;
      }
    }
    @media (max-width: 720px) {
      .table-scroll.issues-table {
        display: none;
      }
      .issues-card-list {
        display: grid;
      }
    }
  </style>
{% endblock %}
{% block content %}
<h1>External Issues</h1>

<div class="issues-actions">
  <form method="get" class="issue-filter-form">
    <label for="issue-status-filter">Issue status</label>
    <select id="issue-status-filter" name="status" onchange="this.form.submit()">
      {% for option in status_options %}
        <option value="{{ option.value }}" {% if option.value == status_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <label for="issue-tenant-filter">Tenant</label>
    <select id="issue-tenant-filter" name="tenant" onchange="this.form.submit()">
      {% for option in tenant_options %}
        <option value="{{ option.value }}" {% if option.value == tenant_filter %}selected{% endif %}>
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    <input type="hidden" name="sort" value="{{ sort_state.key }}">
    <input type="hidden" name="direction" value="{{ sort_state.direction }}">
  </form>

  <form method="post" action="{{ url_for('admin.refresh_all_issues') }}" class="inline-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <button type="submit" class="secondary">Refresh All Issues</button>
  </form>
</div>

{% if issues %}
  <p class="text-muted">
    Showing {{ total_issue_count }} of {{ total_issue_full_count }}
    issue{{ '' if total_issue_full_count == 1 else 's' }}
    {% if status_filter != 'all' %}
      (status: {{ status_filter_label }})
    {% endif %}.
  </p>

  <div class="table-scroll issues-table">
    <table>
      <thead>
        <tr>
          {% for column in sort_columns %}
            {% set header = sort_headers.get(column.key) %}
            <th scope="col" aria-sort="{{ header.aria_sort }}">
              <a href="{{ header.url }}" class="sort-link{% if header.is_active %} is-active{% endif %}">
                {{ column.label }}
                <span class="sort-indicator" aria-hidden="true">
                  {% if header.is_active %}
                    {% if sort_state.direction == 'asc' %}▲{% else %}▼{% endif %}
                  {% else %}
                    ↕
                  {% endif %}
                </span>
              </a>
            </th>
          {% endfor %}
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
          <tr>
            <td>
              {% if issue.url %}
                <a href="{{ issue.url }}" target="_blank" rel="noopener">{{ issue.external_id }}</a>
              {% else %}
                {{ issue.external_id }}
              {% endif %}
            </td>
            <td>{{ issue.title }}</td>
            <td>
              {% if issue.status %}
                <span class="badge {% if issue.status_key == 'closed' %}success{% elif issue.status_key == 'open' %}secondary{% endif %}">
                  {{ issue.status }}
                </span>
              {% else %}
                <span class="badge">Unspecified</span>
              {% endif %}
            </td>
            <td>{{ issue.provider|capitalize }}</td>
            <td>{{ issue.project_name or "Unknown project" }}</td>
            <td>{{ issue.tenant_name or "Unknown tenant" }}</td>
            <td>{{ issue.updated_display or "Unknown" }}</td>
            <td>{{ issue.assignee or "Unassigned" }}</td>
            <td>
              {% if issue.labels %}
                {{ issue.labels|join(', ') }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
            <td>
              {% if issue.project_id %}
                <div class="issues-actions">
                  {% if issue.codex_target and issue.prepare_endpoint and issue.codex_payload %}
                    <button
                      type="button"
                      class="secondary outline issues-start-codex"
                      data-project-id="{{ issue.project_id }}"
                      data-target="{{ issue.codex_target }}"
                      data-prepare="{{ issue.prepare_endpoint }}"
                      data-context='{{ issue.codex_payload|tojson }}'
                    >
                      Start Codex Session
                    </button>
                  {% endif %}
                  {% if issue.populate_endpoint %}
                    <button
                      type="button"
                      class="tertiary issues-populate-agents"
                      data-populate="{{ issue.populate_endpoint }}"
                    >
                      Populate AGENTS.md
                    </button>
                  {% endif %}
                  {% if issue.can_close and issue.close_endpoint %}
                    <form method="post" action="{{ issue.close_endpoint }}" class="inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <button type="submit" class="secondary outline">Close Issue</button>
                    </form>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-muted">Unavailable</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="issues-card-list">
    {% for issue in issues %}
      <article class="issue-card">
        <header class="issue-card__header">
          <div>
            <h3>
              {% if issue.url %}
                <a href="{{ issue.url }}" target="_blank" rel="noopener">{{ issue.external_id }}</a>
              {% else %}
                {{ issue.external_id }}
              {% endif %}
            </h3>
            <p class="issue-card__title">{{ issue.title }}</p>
          </div>
          <div>
            {% if issue.status %}
              <span class="badge {% if issue.status_key == 'closed' %}success{% elif issue.status_key == 'open' %}secondary{% endif %}">
                {{ issue.status }}
              </span>
            {% else %}
              <span class="badge">Unspecified</span>
            {% endif %}
          </div>
        </header>
        <dl class="issue-card__meta">
          <div class="issue-card__meta-item">
            <dt>Provider</dt>
            <dd>{{ issue.provider|capitalize }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Project</dt>
            <dd>{{ issue.project_name or "Unknown project" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Tenant</dt>
            <dd>{{ issue.tenant_name or "Unknown tenant" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Updated</dt>
            <dd>{{ issue.updated_display or "Unknown" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Assignee</dt>
            <dd>{{ issue.assignee or "Unassigned" }}</dd>
          </div>
          <div class="issue-card__meta-item">
            <dt>Labels</dt>
            <dd>
              {% if issue.labels %}
                {{ issue.labels|join(', ') }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </dd>
          </div>
        </dl>
        {% if issue.project_id %}
          <div class="issues-actions">
            {% if issue.codex_target and issue.prepare_endpoint and issue.codex_payload %}
              <button
                type="button"
                class="secondary outline issues-start-codex"
                data-project-id="{{ issue.project_id }}"
                data-target="{{ issue.codex_target }}"
                data-prepare="{{ issue.prepare_endpoint }}"
                data-context='{{ issue.codex_payload|tojson }}'
              >
                Start Codex Session
              </button>
            {% endif %}
            {% if issue.populate_endpoint %}
              <button
                type="button"
                class="tertiary issues-populate-agents"
                data-populate="{{ issue.populate_endpoint }}"
              >
                Populate AGENTS.md
              </button>
            {% endif %}
            {% if issue.can_close and issue.close_endpoint %}
              <form method="post" action="{{ issue.close_endpoint }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="secondary outline">Close Issue</button>
              </form>
            {% endif %}
          </div>
        {% endif %}
      </article>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">No issues found for the selected filter.</p>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const codexButtons = document.querySelectorAll('.issues-start-codex');
    const populateButtons = document.querySelectorAll('.issues-populate-agents');
    if (!codexButtons.length && !populateButtons.length) {
      return;
    }
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenValue = csrfMeta ? csrfMeta.getAttribute('content') : '';

    codexButtons.forEach(button => {
      button.addEventListener('click', () => {
        const projectId = button.dataset.projectId;
        const target = button.dataset.target;
        const prepareEndpoint = button.dataset.prepare;
        const payloadRaw = button.dataset.context;
        if (!projectId || !target || !prepareEndpoint || !payloadRaw) {
          return;
        }

        let payload;
        try {
          payload = JSON.parse(payloadRaw);
        } catch (error) {
          return;
        }

        const storageKey = `aiops-session-context-${projectId}`;

        const finalize = (context) => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(context));
          } catch (error) {
            /* ignore storage errors */
          }
          window.location.href = target;
        };

        fetch(prepareEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then((response) => (
            response.ok
              ? response.json()
              : response.json().then((data) => Promise.reject(data))
          ))
          .then((data) => {
            finalize({
              prompt: data.prompt,
              command: data.command,
              tool: data.tool || payload.tool,
              autoStart: true,
              tmuxTarget: data.tmux_target || null,
            });
          })
          .catch(() => {
            finalize({
              prompt: payload.prompt,
              command: payload.command,
              tool: payload.tool,
              autoStart: payload.autoStart,
              tmuxTarget: payload.tmuxTarget || null,
            });
          });
      });
    });

    populateButtons.forEach(button => {
      button.addEventListener('click', () => {
        const endpoint = button.dataset.populate;
        if (!endpoint) {
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Populating...';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfTokenValue ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue } : {}),
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then(response => (
            response.ok
              ? response.json()
              : response.json().then(data => Promise.reject(data))
          ))
          .then(data => {
            button.textContent = 'AGENTS.md updated';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2000);
            if (data && data.tracked_path) {
              console.info(`Updated agent context at ${data.tracked_path}`);
            }
          })
          .catch(error => {
            console.error('Failed to populate AGENTS.md', error);
            button.textContent = 'Update failed';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2500);
          });
      });
    });
  })();
</script>
{% endblock %}
