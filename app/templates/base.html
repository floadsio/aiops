<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}aiops Control Panel{% endblock %}</title>
    <script>
      (function () {
        const storageKey = "aiops-theme";
        const root = document.documentElement;
        try {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
        let stored = null;
        if (window.localStorage) {
          stored = localStorage.getItem(storageKey);
        }
        const theme = stored || (prefersDark.matches ? "dark" : "light");
        root.setAttribute("data-theme", theme || "light");
        } catch (error) {
          root.setAttribute("data-theme", "light");
        }
      })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
      :root {
        --app-gutter-inline: clamp(1.25rem, 2vw, 2.75rem);
      }
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding-left: var(--app-gutter-inline);
        padding-right: var(--app-gutter-inline);
      }
      header.container {
        padding-top: clamp(0.9rem, 2vh, 1.4rem);
        padding-bottom: clamp(0.9rem, 2vh, 1.4rem);
      }
      main.container {
        padding-top: clamp(1rem, 3vh, 2rem);
        padding-bottom: clamp(2rem, 6vh, 4rem);
      }
      .theme-toggle {
        border: none;
        background: transparent;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.95rem;
        color: inherit;
        transition: background-color 0.15s ease, color 0.15s ease, transform 0.15s ease;
      }
      .theme-toggle:hover {
        transform: translateY(-1px);
      }
      .theme-toggle[data-theme="light"] {
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
      }
      .theme-toggle[data-theme="dark"] {
        background: rgba(148, 163, 184, 0.25);
        color: #f8fafc;
      }
      [data-theme="dark"] .theme-toggle[data-theme="light"] {
        background: rgba(148, 163, 184, 0.25);
        color: #f8fafc;
      }
      [data-theme="dark"] .theme-toggle[data-theme="dark"] {
        background: rgba(15, 23, 42, 0.45);
        color: #f8fafc;
      }
      button,
      [type="button"],
      [type="submit"],
      [role="button"] {
        font-size: 0.9rem;
        padding: 0.35rem 0.85rem;
        line-height: 1.2;
      }
      .theme-toggle {
        padding: 0.35rem 0.6rem;
      }
      .inline-form {
        display: inline-block;
        margin: 0;
      }
      .inline-form button {
        margin-left: 0.5rem;
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
      }
      .inline-form .link-button {
        background: none;
        border: none;
        padding: 0;
        margin-left: 0.75rem;
        font-size: 0.9rem;
        color: #1d4ed8;
        cursor: pointer;
      }
      .inline-form .link-button:hover,
      .inline-form .link-button:focus {
        text-decoration: underline;
      }
      .inline-form .link-button.danger {
        color: #dc2626;
      }
    </style>
    {% block extra_head %}{% endblock %}
  </head>
  <body>
    <header class="container">
      <nav>
        <ul>
          <li><strong>aiops Control Panel</strong></li>
        </ul>
        <ul>
          {% if current_user.is_authenticated %}
            <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('admin.manage_projects') }}">Projects</a></li>
            <li><a href="{{ url_for('admin.manage_integrations') }}">Integrations</a></li>
            <li><a href="{{ url_for('admin.manage_ssh_keys') }}">SSH Keys</a></li>
            <li><a href="{{ url_for('admin.manage_settings') }}">Settings</a></li>
            <li>
              <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                <span aria-hidden="true" id="theme-toggle-icon">ðŸŒ™</span>
                <span id="theme-toggle-label">Dark</span>
              </button>
            </li>
            <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
          {% else %}
            <li><a href="{{ url_for('auth.login') }}">Login</a></li>
          {% endif %}
        </ul>
      </nav>
    </header>
    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div>
            {% for category, message in messages %}
              <article class="contrast {{ category }}">
                {{ message }}
              </article>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    <script>
      (function () {
        const storageKey = "aiops-theme";
        const root = document.documentElement;
        const toggle = document.getElementById("theme-toggle");
        const icon = document.getElementById("theme-toggle-icon");
        const label = document.getElementById("theme-toggle-label");
        if (!toggle || !icon || !label) {
          return;
        }

        let prefersDark;
        try {
          prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
        } catch (error) {
          prefersDark = { matches: false, addEventListener: function () {}, removeEventListener: function () {} };
        }
        const applyTheme = (theme, persist = false) => {
          root.setAttribute("data-theme", theme);
          toggle.setAttribute("data-theme", theme);
          if (theme === "dark") {
            icon.textContent = "ðŸŒž";
            label.textContent = "Light";
          } else {
            icon.textContent = "ðŸŒ™";
            label.textContent = "Dark";
          }
          if (persist && window.localStorage) {
            try {
              localStorage.setItem(storageKey, theme);
            } catch (error) {
              /* ignore storage errors */
            }
          }
        };

        const initialize = () => {
          let stored = null;
          if (window.localStorage) {
            try {
              stored = localStorage.getItem(storageKey);
            } catch (error) {
              stored = null;
            }
          }
          const currentTheme = stored || (prefersDark.matches ? "dark" : "light");
          applyTheme(currentTheme);
        };

        const toggleTheme = () => {
          const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          applyTheme(next, true);
        };

        toggle.addEventListener("click", toggleTheme);

        const prefersListener = (event) => {
          let stored = null;
          if (window.localStorage) {
            try {
              stored = localStorage.getItem(storageKey);
            } catch (error) {
              stored = null;
            }
          }
          if (stored) {
            return;
          }
          applyTheme(event.matches ? "dark" : "light");
        };

        if (typeof prefersDark.addEventListener === "function") {
          prefersDark.addEventListener("change", prefersListener);
        } else if (typeof prefersDark.addListener === "function") {
          prefersDark.addListener(prefersListener);
        }

        initialize();
      })();
    </script>
    {% block extra_body %}{% endblock %}
  </body>
</html>
