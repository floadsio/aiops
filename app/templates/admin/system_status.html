{% extends "base.html" %}
{% block title %}System Status | aiops Control Panel{% endblock %}
{% block extra_head %}
<style>
  .status-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .controls-bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2rem;
  }

  .status-header {
    margin-bottom: 2rem;
  }

  .status-header article {
    margin-bottom: 0;
  }

  .status-header.healthy article {
    border-left: 4px solid var(--pico-ins-color);
  }

  .status-header.unhealthy article {
    border-left: 4px solid var(--pico-del-color);
  }

  .status-icon {
    font-size: 2rem;
    margin-right: 1rem;
  }

  .status-info h2 {
    margin: 0;
  }

  .status-info p {
    margin: 0.5rem 0 0 0;
    color: var(--pico-muted-color);
    font-size: 0.9rem;
  }

  .component-message {
    color: var(--pico-muted-color);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .detail-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .detail-row.available .detail-label {
    color: var(--pico-ins-color);
  }

  .detail-row.unavailable .detail-label {
    color: var(--pico-muted-color);
    opacity: 0.6;
  }

  .detail-row.enabled .detail-label {
    color: var(--pico-ins-color);
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .summary-item {
    text-align: center;
    padding: 1rem;
  }

  .summary-item strong {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .summary-item small {
    color: var(--pico-muted-color);
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .spinning {
    animation: spin 1s linear infinite;
  }

  /* Override card-grid to two columns */
  #components-grid.card-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  /* Component cards need IDs for anchor navigation */
  .component-card {
    scroll-margin-top: 120px;
  }

  /* Sticky navigation bar */
  .status-nav {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    padding: 0.75rem 0;
    margin: 0 0 1.5rem 0;
  }
  [data-theme="dark"] .status-nav {
    background: rgba(26, 29, 35, 0.95);
  }
  .status-nav ul {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }
  .status-nav a {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.4rem 0.75rem;
    border-radius: 0.5rem;
    background: rgba(94, 108, 117, 0.2);
    color: inherit;
    text-decoration: none;
    font-size: 0.85rem;
    transition: background 0.2s;
  }
  .status-nav a:hover {
    background: rgba(94, 108, 117, 0.4);
  }
  [data-theme="dark"] .status-nav a:hover {
    background: rgba(148, 163, 184, 0.3);
  }
  .status-nav .nav-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--pico-muted-color);
  }
  .status-nav .nav-status.healthy {
    background: var(--pico-ins-color);
  }
  .status-nav .nav-status.unhealthy {
    background: var(--pico-del-color);
  }
  @media (max-width: 768px) {
    .status-nav ul {
      gap: 0.25rem;
    }
    .status-nav a {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="status-container">
  <h1>System Status</h1>

  <nav class="status-nav" id="status-nav">
    <ul id="nav-links">
      <!-- Nav links will be populated by JavaScript -->
    </ul>
  </nav>

  <div class="controls-bar">
    <button onclick="refreshStatus()" id="refresh-btn">
      <span id="refresh-icon">üîÑ</span>
      Refresh
    </button>
    <label>
      <input type="checkbox" id="auto-refresh" role="switch" onchange="toggleAutoRefresh()">
      Auto-refresh (30s)
    </label>
  </div>

  <div id="status-content">
    <div class="status-header" id="overall-status">
      <article>
        <div style="display: flex; align-items: center;">
          <span class="status-icon" id="overall-icon">‚è≥</span>
          <div class="status-info">
            <h2 id="overall-title">Loading System Status...</h2>
            <p id="overall-timestamp"></p>
          </div>
        </div>
      </article>
    </div>

    <div class="card-grid" id="components-grid">
      <!-- Components will be loaded here -->
    </div>

    <div class="summary-grid" id="summary-section" style="display: none;">
      <article class="summary-item">
        <strong id="healthy-count">-</strong>
        <small>Healthy</small>
      </article>
      <article class="summary-item">
        <strong id="unhealthy-count">-</strong>
        <small>Unhealthy</small>
      </article>
      <article class="summary-item">
        <strong id="total-count">-</strong>
        <small>Total</small>
      </article>
    </div>
  </div>
</div>

<script>
let autoRefreshInterval = null;

async function refreshStatus() {
  const refreshBtn = document.getElementById('refresh-btn');
  const refreshIcon = document.getElementById('refresh-icon');
  refreshIcon.classList.add('spinning');
  refreshBtn.disabled = true;

  try {
    const response = await fetch('/api/v1/system/status', {
      headers: {
        'X-CSRF-Token': '{{ csrf_token() }}'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch status');
    }

    const data = await response.json();
    updateStatusDisplay(data);
  } catch (error) {
    console.error('Error fetching status:', error);
    document.getElementById('overall-title').textContent = 'Error Loading Status';
  } finally {
    refreshIcon.classList.remove('spinning');
    refreshBtn.disabled = false;
  }
}

function updateStatusDisplay(data) {
  // Update overall status
  const overallStatus = document.getElementById('overall-status');
  const overallIcon = document.getElementById('overall-icon');
  const overallTitle = document.getElementById('overall-title');
  const overallTimestamp = document.getElementById('overall-timestamp');

  if (data.healthy) {
    overallStatus.className = 'status-header healthy';
    overallIcon.textContent = '‚úÖ';
    overallTitle.textContent = 'System Status: All Systems Operational';
  } else {
    overallStatus.className = 'status-header unhealthy';
    overallIcon.textContent = '‚ö†Ô∏è';
    overallTitle.textContent = 'System Status: Issues Detected';
  }

  const timestamp = new Date(data.timestamp);
  overallTimestamp.textContent = `Last checked: ${timestamp.toLocaleString()}`;

  // Update summary
  const summary = data.summary || {};
  document.getElementById('healthy-count').textContent = summary.healthy_components || 0;
  document.getElementById('unhealthy-count').textContent = summary.unhealthy_components || 0;
  document.getElementById('total-count').textContent = summary.total_components || 0;
  document.getElementById('summary-section').style.display = 'grid';

  // Component display names and order
  const componentConfig = {
    'cli_git_tools': { name: 'CLI Git Tools', icon: 'üîå' },
    'ssh_connectivity': { name: 'SSH Connectivity', icon: 'üîê' },
    'user_credentials': { name: 'User Credentials', icon: 'üë§' },
    'database': { name: 'Database', icon: 'üóÑÔ∏è' },
    'tmux': { name: 'Tmux', icon: 'üì∫' },
    'git': { name: 'Git Tools', icon: 'üì¶' },
    'ai_tools': { name: 'AI Tools', icon: 'ü§ñ' },
    'ollama': { name: 'Ollama', icon: 'ü¶ô' },
    'workspaces': { name: 'Workspaces', icon: 'üìÅ' },
    'integrations': { name: 'Integrations', icon: 'üîó' },
    'sessions': { name: 'Sessions', icon: 'üíª' },
    'issue_sync': { name: 'Issue Sync', icon: 'üîÑ' },
    'slack_poller': { name: 'Slack Poller', icon: 'üí¨' },
  };

  const componentOrder = Object.keys(componentConfig);

  // Update navigation
  const navLinks = document.getElementById('nav-links');
  navLinks.innerHTML = '';

  componentOrder.forEach(key => {
    if (data.components[key]) {
      const component = data.components[key];
      const config = componentConfig[key];
      const li = document.createElement('li');
      const statusClass = component.healthy ? 'healthy' : 'unhealthy';
      li.innerHTML = `
        <a href="#component-${key}">
          <span class="nav-status ${statusClass}"></span>
          ${config.name}
        </a>
      `;
      navLinks.appendChild(li);
    }
  });

  // Update components
  const componentsGrid = document.getElementById('components-grid');
  componentsGrid.innerHTML = '';

  componentOrder.forEach(key => {
    if (data.components[key]) {
      const component = data.components[key];
      const config = componentConfig[key];
      const card = createComponentCard(key, component, config);
      componentsGrid.appendChild(card);
    }
  });
}

function createComponentCard(name, component, config) {
  const card = document.createElement('div');
  const accentClass = component.healthy ? 'accent-green' : 'accent-red';
  card.className = `clean-card component-card ${accentClass}`;
  card.id = `component-${name}`;

  const displayName = config ? config.name : name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

  const article = document.createElement('article');
  article.innerHTML = `
    <div class="card-header">
      <h3 class="card-title">${displayName}</h3>
      <span class="card-badge">
        ${component.healthy ? '‚úÖ' : '‚ùå'}
      </span>
    </div>
    <div class="card-content">
      <div class="component-message">
        ${component.message}
      </div>
      ${component.details ? createDetailsHTML(name, component.details) : ''}
    </div>
  `;

  card.appendChild(article);
  return card;
}

function createDetailsHTML(componentName, details) {
  let html = '';

  if (componentName === 'git' && details.tools) {
    Object.entries(details.tools).forEach(([tool, info]) => {
      const status = info.available ? 'available' : 'unavailable';
      const icon = info.available ? '‚úì' : '‚óã';
      const version = info.version ? ` (${info.version.split('\n')[0]})` : '';
      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${tool}</span>
          </span>
          <span class="detail-value">${info.available ? 'Available' + version : info.error || 'Not Found'}</span>
        </div>
      `;
    });
  } else if (componentName === 'ai_tools' && details.tools) {
    Object.entries(details.tools).forEach(([tool, info]) => {
      const status = info.available ? 'available' : 'unavailable';
      const icon = info.available ? '‚úì' : '‚óã';
      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${tool}</span>
          </span>
          <span class="detail-value">${info.available ? 'Available' : 'Not Found'}</span>
        </div>
      `;
    });
  } else if (componentName === 'integrations' && details.integrations) {
    Object.entries(details.integrations).forEach(([name, info]) => {
      const status = info.enabled ? 'enabled' : 'disabled';
      const icon = info.enabled ? '‚úì' : '‚óã';
      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${name}</span>
          </span>
          <span class="detail-value">${info.provider}</span>
        </div>
      `;
    });
  } else if (componentName === 'cli_git_tools' && details.integrations) {
    details.integrations.forEach(integration => {
      const status = integration.auth_ok ? 'enabled' : 'disabled';
      const icon = integration.auth_ok ? '‚úì' : '‚úó';
      const tokenInfo = integration.token_preview ? ` [${integration.token_source}: ${integration.token_preview}]` : '';
      const errorMsg = integration.error ? `<br><small style="color: var(--pico-del-color);">${integration.error.substring(0, 100)}...</small>` : '';
      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${integration.name}</span>
          </span>
          <span class="detail-value">
            ${integration.provider} - ${integration.tenant_name}${tokenInfo}${errorMsg}
          </span>
        </div>
      `;
    });
  } else if (componentName === 'ssh_connectivity' && details.projects) {
    details.projects.forEach(project => {
      const status = project.ssh_ok ? 'enabled' : 'disabled';
      const icon = project.ssh_ok ? '‚úì' : '‚úó';
      const errorMsg = project.error ? `<br><small style="color: var(--pico-del-color);">${project.error}</small>` : '';

      // Build SSH key info display
      let keyInfo = '';
      if (project.ssh_key) {
        const keyName = project.ssh_key.name || 'unknown';
        const keySource = project.ssh_key.source || '?';
        const keyStorage = project.ssh_key.storage || '?';
        keyInfo = `<br><small style="color: var(--pico-muted-color);">Key: ${keyName} (${keySource}, ${keyStorage})</small>`;
      }

      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${project.project_name}</span>
          </span>
          <span class="detail-value">
            ${project.hostname}${keyInfo}${errorMsg}
          </span>
        </div>
      `;
    });
  } else if (componentName === 'sessions' && details.by_tool) {
    Object.entries(details.by_tool).forEach(([tool, count]) => {
      html += `
        <div class="detail-row">
          <span class="detail-label">${tool}</span>
          <span class="detail-value">${count} active</span>
        </div>
      `;
    });
  } else if (componentName === 'ollama') {
    if (details.version) {
      html += `
        <div class="detail-row">
          <span class="detail-label">Version</span>
          <span class="detail-value">${details.version}</span>
        </div>
      `;
    }
    if (details.models !== undefined) {
      html += `
        <div class="detail-row">
          <span class="detail-label">Models Available</span>
          <span class="detail-value">${details.models}</span>
        </div>
      `;
    }
    if (details.endpoint) {
      html += `
        <div class="detail-row">
          <span class="detail-label">Endpoint</span>
          <span class="detail-value">${details.endpoint}</span>
        </div>
      `;
    }
  } else if (componentName === 'issue_sync') {
    html += `
      <div class="detail-row">
        <span class="detail-label">Status</span>
        <span class="detail-value">${details.enabled ? (details.running ? 'üü¢ Active' : 'üî¥ Stopped') : '‚ö™ Disabled'}</span>
      </div>
    `;
    if (details.interval_minutes) {
      html += `
        <div class="detail-row">
          <span class="detail-label">Interval</span>
          <span class="detail-value">${details.interval_minutes} minutes</span>
        </div>
      `;
    }
    if (details.next_run) {
      const nextRun = new Date(details.next_run);
      html += `
        <div class="detail-row">
          <span class="detail-label">Next Run</span>
          <span class="detail-value">${nextRun.toLocaleTimeString()}</span>
        </div>
      `;
    }
  } else if (componentName === 'slack_poller') {
    html += `
      <div class="detail-row">
        <span class="detail-label">Status</span>
        <span class="detail-value">${details.enabled ? (details.running ? 'üü¢ Active' : 'üî¥ Stopped') : '‚ö™ Disabled'}</span>
      </div>
    `;
    if (details.interval_seconds) {
      html += `
        <div class="detail-row">
          <span class="detail-label">Interval</span>
          <span class="detail-value">${details.interval_seconds} seconds</span>
        </div>
      `;
    }
    if (details.next_run) {
      const nextRun = new Date(details.next_run);
      html += `
        <div class="detail-row">
          <span class="detail-label">Next Run</span>
          <span class="detail-value">${nextRun.toLocaleTimeString()}</span>
        </div>
      `;
    }
    html += `
      <div class="detail-row">
        <span class="detail-label">Slack Integrations</span>
        <span class="detail-value">${details.slack_integrations || 0}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Ollama Preview</span>
        <span class="detail-value">${details.ollama_preview ? '‚úÖ Enabled' : '‚ö™ Disabled'}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Pending Issues</span>
        <span class="detail-value">${details.pending_issues || 0}</span>
      </div>
    `;
  } else if (componentName === 'user_credentials' && details.users) {
    details.users.forEach(user => {
      const status = user.missing_count === 0 ? 'enabled' : 'disabled';
      const icon = user.missing_count === 0 ? '‚úì' : '‚ö†';
      const missingList = user.missing.map(m => m.name).join(', ');
      const missingInfo = user.missing_count > 0
        ? `<br><small style="color: var(--pico-del-color);">Missing: ${missingList}</small>`
        : '';
      html += `
        <div class="detail-row ${status}">
          <span class="detail-label">
            <span>${icon}</span>
            <span>${user.user_name}</span>
          </span>
          <span class="detail-value">
            ${user.configured_count}/${user.total_integrations} configured${missingInfo}
          </span>
        </div>
      `;
    });
  } else {
    Object.entries(details).forEach(([key, value]) => {
      if (typeof value !== 'object') {
        const displayKey = key.replace(/_/g, ' ');
        html += `
          <div class="detail-row">
            <span class="detail-label">${displayKey}</span>
            <span class="detail-value">${value}</span>
          </div>
        `;
      }
    });
  }

  return html;
}

function toggleAutoRefresh() {
  const checkbox = document.getElementById('auto-refresh');

  if (checkbox.checked) {
    autoRefreshInterval = setInterval(refreshStatus, 30000);
  } else {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }
}

// Load initial status
refreshStatus();
</script>
{% endblock %}
