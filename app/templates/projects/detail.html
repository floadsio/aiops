{% extends "base.html" %}
{% block title %}{{ project.name }} | Projects{% endblock %}
{% block extra_head %}
  {{ super() }}
  <style>
    article.contrast ul li > button,
    article.contrast ul li > .inline-form {
      display: inline-block;
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
    @media (max-width: 640px) {
      article.contrast ul li {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      article.contrast ul li > button {
        width: 100%;
        justify-content: center;
        margin-top: 0.35rem;
        margin-right: 0;
        /* Ensure minimum touch target size for iOS */
        min-height: 44px;
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }
      article.contrast ul li > .inline-form {
        display: block !important;
        width: 100%;
        margin-top: 0.35rem;
        margin-right: 0;
      }
      /* Make pin/unpin buttons full-width and properly sized on mobile */
      article.contrast ul li > .inline-form button {
        width: 100%;
        justify-content: center;
        min-height: 44px;
        font-size: 1rem;
        padding: 0.5rem 1rem;
        margin-left: 0;
      }
    }
    .git-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .git-history-list li {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.75rem;
      padding: 0.65rem 0.85rem;
      background: rgba(15, 23, 42, 0.02);
    }
    [data-theme="dark"] .git-history-list li {
      background: rgba(15, 23, 42, 0.35);
      border-color: rgba(148, 163, 184, 0.45);
    }
    .git-history-list code {
      font-size: 0.85rem;
    }
    .git-history-list small {
      color: #475569;
    }
    [data-theme="dark"] .git-history-list small {
      color: rgba(226, 232, 240, 0.7);
    }
  </style>
{% endblock %}
{% block content %}
<h1>{{ project.name }}</h1>
<p>
  <strong>Tenant:</strong>
  <span class="tenant-badge" style="--tenant-color: {{ project.tenant.color or default_tenant_color }}">
    <span class="tenant-badge__swatch" aria-hidden="true"></span>
    {{ project.tenant.name }}
  </span>
</p>
<p><strong>Repository:</strong> <code>{{ project.repo_url }}</code></p>
<p><strong>Local Path:</strong> <code>{{ project.local_path }}</code></p>

<section>
  <h2>Automation Consoles</h2>
  <p>
    Launch dedicated windows for AI-assisted edits or Ansible runs.
    Each console locks to this project.
  </p>
  <p>
    <a
      role="button"
      href="{{ url_for('projects.project_ai_console', project_id=project.id) }}"
    >Open AI Console</a>
    <a
      role="button"
      class="secondary"
      href="{{ url_for('projects.project_ansible_console', project_id=project.id) }}"
    >Open Ansible Console</a>
  </p>
</section>

<section>
  <h2>Workspace</h2>
  {% if workspace_status.has_git %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-green-500)">✓ Initialized</span>
    </p>
    <p><strong>Path:</strong> <code>{{ workspace_status.path }}</code></p>
    <p class="text-muted">
      Your workspace is ready. Launch a tmux session to start working.
    </p>
  {% elif workspace_status.error %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-amber-500)">⚠ Not available</span>
    </p>
    <p class="text-muted">{{ workspace_status.error }}</p>
  {% else %}
    <p>
      <strong>Status:</strong> <span style="color: var(--pico-color-amber-500)">⚠ Not initialized</span>
    </p>
    <p class="text-muted">
      Initialize your workspace to start working on this project.
      This will clone the repository to <code>{{ workspace_status.path or '~/workspace/' ~ project.name }}</code>
    </p>
    <button
      id="init-workspace-btn"
      data-project-id="{{ project.id }}"
      onclick="initWorkspace({{ project.id }})"
    >
      Initialize Workspace
    </button>
    <p id="workspace-init-status" style="margin-top: 1rem;"></p>
  {% endif %}
</section>

<section>
  <h2>SSH Access</h2>
  <form method="post">
    {{ ssh_key_form.hidden_tag() }}
    <label>
      {{ ssh_key_form.ssh_key_id.label }}
      {{ ssh_key_form.ssh_key_id() }}
    </label>
    {% for error in ssh_key_form.ssh_key_id.errors %}
      <span class="error">{{ error }}</span>
    {% endfor %}
    {{ ssh_key_form.submit(class="secondary") }}
  </form>
  {% if project.ssh_key %}
    <p class="text-muted">
      Using project-specific key <strong>{{ project.ssh_key.name }}</strong>
      {% if project.ssh_key.fingerprint %}
        ({{ project.ssh_key.fingerprint }})
      {% endif %}
    </p>
  {% elif tenant_default_key %}
    <p class="text-muted">
      Using tenant default key <strong>{{ tenant_default_key.name }}</strong>
      {% if tenant_default_key.fingerprint %}
        ({{ tenant_default_key.fingerprint }})
      {% endif %}
    </p>
  {% else %}
    <p class="warning-note">This tenant has no SSH key with private material configured. Git operations may fail.</p>
  {% endif %}
</section>

<section>
  <h2>Repository Status</h2>
  <p>Branch: {{ status.branch }} | Dirty: {{ status.dirty }}</p>
  {% if status.untracked_files %}
    <details>
      <summary>Untracked Files</summary>
      <ul>
        {% for file in status.untracked_files %}
          <li>{{ file }}</li>
        {% endfor %}
      </ul>
    </details>
  {% endif %}
</section>

<section>
  <h2>Recent Git History</h2>
  {% if commit_history %}
    <ul class="git-history-list">
      {% for commit in commit_history %}
        <li>
          <div>
            <code>{{ commit.short_hash }}</code>
            — {{ commit.message }}
          </div>
          <small>{{ commit.author }} • {{ commit.date_display }}</small>
        </li>
      {% endfor %}
    </ul>
  {% elif commit_history_error %}
    <p class="warning-note">Git history unavailable: {{ commit_history_error }}</p>
  {% else %}
    <p class="text-muted">No commits recorded yet.</p>
  {% endif %}
</section>

<section>
  <h2>Issues</h2>
  <form method="get" class="issue-filter-form">
    <label for="issue-status-filter">Issue status</label>
    <select id="issue-status-filter" name="issue_status" onchange="this.form.submit()">
      {% for option in issue_status_options %}
        <option
          value="{{ option.value }}"
          {% if option.value == issue_status_filter %}selected{% endif %}
        >
          {{ option.label }} ({{ option.count }})
        </option>
      {% endfor %}
    </select>
    {% for key, value in request.args.items() if key != 'issue_status' %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
  </form>
  {% if issue_groups %}
    <p class="text-muted">
      Showing {{ total_issue_count }} of {{ total_issue_full_count }}
      issue{{ '' if total_issue_full_count == 1 else 's' }}
      across {{ issue_groups|length }}
      integration{{ '' if issue_groups|length == 1 else 's' }}
      {% if issue_status_filter != 'all' %}
        (status: {{ issue_status_filter_label }})
      {% endif %}.
    </p>
    {% for group in issue_groups %}
      <article class="contrast">
        <header>
          <h3>{{ group.integration_name }}</h3>
          <p>
            Provider: {{ group.provider_display }}
            {% if group.project_identifier %}
              • Target: <code>{{ group.project_identifier }}</code>
            {% endif %}
            {% if not group.enabled %}
              <span class="badge">Disabled</span>
            {% endif %}
          </p>
          {% if group.last_synced %}
            <p class="text-muted">Last synced {{ group.last_synced }}</p>
          {% endif %}
        </header>
        {% if group.can_create_issue %}
          <details class="issue-create-form">
            <summary>Create new issue</summary>
            <form method="post" class="grid">
              {{ group.create_form.hidden_tag() }}
              {{ group.create_form.integration_id() }}
              <label>
                {{ group.create_form.summary.label }}
                {{ group.create_form.summary() }}
                {% for error in group.create_form.summary.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.description.label }}
                {{ group.create_form.description() }}
                {% for error in group.create_form.description.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.issue_type.label }}
                {{ group.create_form.issue_type() }}
                {% if group.create_form.issue_type.description %}
                  <small class="text-muted">{{ group.create_form.issue_type.description }}</small>
                {% endif %}
                {% for error in group.create_form.issue_type.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.labels.label }}
                {{ group.create_form.labels() }}
                {% if group.create_form.labels.description %}
                  <small class="text-muted">{{ group.create_form.labels.description }}</small>
                {% endif %}
                {% for error in group.create_form.labels.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <label>
                {{ group.create_form.assignee_user_id.label }}
                {{ group.create_form.assignee_user_id() }}
                {% if group.create_form.assignee_user_id.description %}
                  <small class="text-muted">{{ group.create_form.assignee_user_id.description }}</small>
                {% endif %}
                {% for error in group.create_form.assignee_user_id.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </label>
              <div>
                {{ group.create_form.submit(class="secondary") }}
              </div>
            </form>
          </details>
        {% endif %}
        {% if group.issues %}
          <ul>
            {% for issue in group.issues %}
              <li>
                <strong>{{ issue.title }}</strong>
                {% if issue.status %}
                  <span class="badge secondary">{{ issue.status }}</span>
                {% endif %}
                {% if issue.assignee %}
                  <span class="badge">{{ issue.assignee }}</span>
                {% endif %}
                <br />
                <small>
                  ID {{ issue.external_id }}
                  {% if issue.updated_display %}
                    • Updated {{ issue.updated_display }}
                  {% endif %}
                </small>
                {% if issue.labels %}
                  <br />
                  <small>Labels: {{ issue.labels|join(', ') }}</small>
                {% endif %}
                {% if issue.url %}
                  <br />
                  <a
                    href="{{ issue.url }}"
                    target="_blank"
                    rel="noopener"
                  >Open in {{ group.provider_display }}</a>
                {% endif %}
                <br />
                <button
                  type="button"
                  class="secondary start-codex-session"
                  data-target="{{ url_for('projects.project_ai_console', project_id=project.id) }}"
                  data-prepare="{{ url_for(
                    'projects.prepare_issue_context',
                    project_id=project.id,
                    issue_id=issue.id
                  ) }}"
                  data-context='{{ issue.codex_payload|tojson }}'
                  data-tool="claude"
                  data-command="{{ ai_tool_commands.get('claude') or default_ai_shell }}"
                >
                  Claude
                </button>
                <button
                  type="button"
                  class="secondary start-codex-session"
                  data-target="{{ url_for('projects.project_ai_console', project_id=project.id) }}"
                  data-prepare="{{ url_for(
                    'projects.prepare_issue_context',
                    project_id=project.id,
                    issue_id=issue.id
                  ) }}"
                  data-context='{{ issue.codex_payload|tojson }}'
                  data-tool="codex"
                  data-command="{{ ai_tool_commands.get('codex') or default_ai_shell }}"
                >
                  Codex
                </button>
                <button
                  type="button"
                  class="tertiary populate-agents-md"
                  data-populate="{{ url_for(
                    'projects.populate_issue_agents_md',
                    project_id=project.id,
                    issue_id=issue.id
                  ) }}"
                >
                  Populate AGENTS.override.md
                </button>
                {% if issue.comment_count %}
                  <details class="issue-comment-thread">
                    <summary>
                      {{ issue.comment_count }}
                      comment{{ '' if issue.comment_count == 1 else 's' }} synced
                      from tracker
                    </summary>
                    <ul class="issue-comments">
                      {% for comment in issue.comments %}
                        <li>
                          <small>
                            {% if comment.author %}
                              {{ comment.author }}
                            {% else %}
                              <span class="text-muted">Unknown author</span>
                            {% endif %}
                            {% if comment.created_display %}
                              • {{ comment.created_display }}
                            {% endif %}
                            {% if comment.url %}
                              • <a href="{{ comment.url }}" target="_blank" rel="noopener">View</a>
                            {% endif %}
                          </small>
                          <div class="issue-comment__body">
                            {{ comment.body|e|replace('\n', '<br />')|safe }}
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  </details>
                {% endif %}
                {% if issue.can_assign %}
                  <form
                    method="post"
                    class="inline-form"
                    action="{{ url_for('projects.assign_issue', project_id=project.id, issue_id=issue.id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input
                      type="text"
                      name="assignee"
                      placeholder="Assign to (comma-separated)"
                      style="max-width: 14rem;"
                    />
                    <button type="submit" class="secondary outline">Assign</button>
                  </form>
                {% endif %}
                {% if issue.status_key != 'closed' %}
                  <form
                    method="post"
                    class="inline-form"
                    action="{{ url_for('projects.close_issue', project_id=project.id, issue_id=issue.id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="secondary outline">Close Issue</button>
                  </form>
                {% endif %}
                {% if issue.is_pinned %}
                  <form
                    method="post"
                    class="inline-form"
                    action="{{ url_for('projects.unpin_issue', project_id=project.id, issue_id=issue.id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="tertiary outline" style="color:#f59e0b;">★ Unpin</button>
                  </form>
                {% else %}
                  <form
                    method="post"
                    class="inline-form"
                    action="{{ url_for('projects.pin_issue', project_id=project.id, issue_id=issue.id) }}"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="tertiary outline">☆ Pin</button>
                  </form>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          {% if group.total_issues %}
            <p class="text-muted">No issues match the current filter.</p>
          {% else %}
            <p class="text-muted">No issues cached for this integration yet.</p>
          {% endif %}
        {% endif %}
      </article>
    {% endfor %}
  {% else %}
  <p class="text-muted">No issue integrations linked to this project.</p>
  {% endif %}
</section>

<section>
  <h2>Project Guide</h2>
  <p class="text-muted">
    Review or update the repository's <code>AGENTS.override.md</code> guide from the dashboard.
  </p>
  <p>
    <a
      role="button"
      class="secondary"
      href="{{ url_for('projects.edit_agents_file', project_id=project.id) }}"
    >View &amp; Edit AGENTS.override.md</a>
  </p>
</section>

<section>
  <h2>Git Actions</h2>
  <form method="post">
    {{ git_form.hidden_tag() }}
    {{ git_form.action.label }} {{ git_form.action() }}
    {{ git_form.ref.label }} {{ git_form.ref() }}
    <label class="checkbox">
      {{ git_form.clean_pull() }} {{ git_form.clean_pull.label.text }}
    </label>
    {{ git_form.submit() }}
  </form>
</section>

{% if message %}
<article class="contrast">
  <h3>Task Output</h3>
  <pre>{{ message }}</pre>
</article>
{% endif %}

{% if error %}
<article class="contrast" data-theme="dark">
  <h3>Errors</h3>
  <pre>{{ error }}</pre>
</article>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  (function () {
    const codexButtons = document.querySelectorAll('.start-codex-session');
    const populateButtons = document.querySelectorAll('.populate-agents-md');
    if (!codexButtons.length && !populateButtons.length) {
      return;
    }
    const storageKeyPrefix = 'aiops-session-context';
    const projectId = {{ project.id }};
    const storageKey = `${storageKeyPrefix}-${projectId}`;
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfTokenValue = (
      (csrfInput && csrfInput.value) ||
      (csrfMeta && csrfMeta.getAttribute('content')) ||
      ''
    );
    const csrfHeaders = csrfTokenValue
      ? { 'X-CSRFToken': csrfTokenValue, 'X-CSRF-Token': csrfTokenValue }
      : {};

    codexButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        const prepareEndpoint = button.dataset.prepare;
        const payloadRaw = button.dataset.context;
        const toolOverride = button.dataset.tool;
        const commandOverride = button.dataset.command;
        if (!target || !payloadRaw) {
          return;
        }
        let payload;
        try {
          payload = JSON.parse(payloadRaw);
        } catch (error) {
          return;
        }

        // Override the tool if specified on the button
        if (toolOverride) {
          payload.tool = toolOverride;
          if (commandOverride) {
            payload.command = commandOverride;
          }
        }

        const finalize = (context) => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(context));
          } catch (error) {
            /* ignore storage errors */
          }
          window.location.href = target;
        };

        if (payload.issueId && prepareEndpoint) {
          const preparePayload = {};
          if (payload.tool) {
            preparePayload.tool = payload.tool;
          }

          fetch(prepareEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...csrfHeaders,
            },
            credentials: 'same-origin',
            body: JSON.stringify(preparePayload)
          })
            .then((response) => (
              response.ok
                ? response.json()
                : response.json().then((data) => Promise.reject(data))
            ))
            .then(data => {
              finalize({
                prompt: data.prompt,
                command: data.command,
                tool: data.tool || payload.tool,
                autoStart: true,
                tmuxTarget: data.tmux_target || null,
              });
            })
            .catch(() => {
              finalize({
                prompt: payload.prompt,
                command: payload.command,
                tool: payload.tool,
                autoStart: payload.autoStart,
                tmuxTarget: payload.tmuxTarget || null,
              });
            });
        } else {
          finalize({
            prompt: payload.prompt,
            command: payload.command,
            tool: payload.tool,
            autoStart: payload.autoStart,
            tmuxTarget: payload.tmuxTarget || null,
          });
        }
      });
    });

    populateButtons.forEach(button => {
      button.addEventListener('click', () => {
        const endpoint = button.dataset.populate;
        if (!endpoint) {
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = 'Populating...';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...csrfHeaders,
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        })
          .then(response => (
            response.ok
              ? response.json()
              : response.json().then(data => Promise.reject(data))
          ))
          .then(data => {
            button.textContent = 'AGENTS.override.md updated';
            setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2000);
            if (data && data.tracked_path) {
              console.info(`Updated agent context at ${data.tracked_path}`);
            }
          })
          .catch(error => {
            console.error('Failed to populate AGENTS.override.md', error);
            button.textContent = 'Update failed';
            window.setTimeout(() => {
              button.textContent = originalLabel;
              button.disabled = false;
            }, 2500);
          });
      });
    });
  })();

  // Workspace initialization
  function initWorkspace(projectId) {
    const button = document.getElementById('init-workspace-btn');
    const statusEl = document.getElementById('workspace-init-status');

    if (!button || !statusEl) return;

    // Disable button and show loading state
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    const originalText = button.textContent;
    button.textContent = 'Initializing...';
    statusEl.innerHTML = '<small style="color: var(--pico-color-azure-500);">Cloning repository...</small>';

    fetch(`/api/v1/projects/${projectId}/workspace/init`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        statusEl.innerHTML = `<small style="color: var(--pico-color-green-500);">✓ ${data.message || 'Workspace initialized successfully!'}</small>`;
        // Reload page after 1 second to show updated status
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        statusEl.innerHTML = `<small style="color: var(--pico-color-red-500);">✗ ${data.error || 'Failed to initialize workspace'}</small>`;
        button.disabled = false;
        button.removeAttribute('aria-busy');
        button.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Workspace initialization error:', error);
      statusEl.innerHTML = '<small style="color: var(--pico-color-red-500);">✗ Network error. Please try again.</small>';
      button.disabled = false;
      button.removeAttribute('aria-busy');
      button.textContent = originalText;
    });
  }
</script>
{% endblock %}
